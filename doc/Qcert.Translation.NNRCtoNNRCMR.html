
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Qcert.Translation.NNRCtoNNRCMR</title>
<meta name="description" content="Documentation of Coq module Qcert.Translation.NNRCtoNNRCMR" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Qcert.Translation.NNRCtoNNRCMR</h1>
<div class="coq">
<br/>
<span class="kwd">Section</span> <span class="id">NNRCtoNNRCMR</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Arith</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ZArith</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">List</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">EquivDec</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Utils</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">BasicRuntime</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCRuntime</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCMRRuntime</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ForeignToReduceOps</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCRuntime</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">list_scope</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fredop</span>:<span class="id">foreign_reduce_op</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">ftoredop</span>:<span class="id">foreign_to_reduce_op</span>}.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">fresh_mr_var</span> (<span class="id">prefix</span>: <span class="id">string</span>) (<span class="id">loc</span>: <span class="id">dlocalization</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">x</span> := <span class="id">fresh_var</span> <span class="id">prefix</span> (<span class="id">domain</span> <span class="id">vars_loc</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">x</span>, (<span class="id">x</span>, <span class="id">loc</span>)::<span class="id">vars_loc</span>).<br/>
<br/>
<br/>
<br/>
<div class="doc"><span class="bracket"><span class="id">load_env</span> <span class="id">unit_var</span> <span class="id">vars</span> <span class="id">env</span></span> takes the
      environment <span class="bracket"><span class="id">env</span></span> used to evaluate an NNRC expression and return
      the environment to use to execute the translation of this
      expression as a map-reduce chain. <span class="bracket"><span class="id">vars</span></span> is the list of
      variables that have to be stored in the map-reduce with
      their dlocalization kind.
      This function also add to the map-reduce environment and entry
      <span class="bracket"><span class="id">init</span></span> that contains the unit value.
   </div>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">load_init_env</span> (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">env</span>: <span class="id">list</span> (<span class="id">string</span>*<span class="id">data</span>)) : <span class="id">option</span> (<span class="id">list</span> (<span class="id">string</span>*<span class="id">ddata</span>)) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">add_initunit</span> (<span class="id">initunit</span>:<span class="id">var</span>) (<span class="id">env</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">ddata</span>)) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">initunit</span>, <span class="id">Dlocal</span> <span class="id">dunit</span>) :: <span class="id">env</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr_env</span> := <span class="id">mkDistConstants</span> <span class="id">vars_loc</span> <span class="id">env</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lift</span> (<span class="id">add_initunit</span> <span class="id">initunit</span>) <span class="id">mr_env</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">load_init_env_success</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">nnrc_env</span> <span class="id">mr_env</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">load_init_env</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">nnrc_env</span> = <span class="id">Some</span> <span class="id">mr_env</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">vars_loc</span> <span class="id">x</span> = <span class="id">Some</span> <span class="id">Vlocal</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lift</span> <span class="id">Dlocal</span> (<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">nnrc_env</span> <span class="id">x</span>) = <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">x</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">vars_loc</span> <span class="id">x</span> = <span class="id">Some</span> <span class="id">Vdistr</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">coll</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">nnrc_env</span> <span class="id">x</span> = <span class="id">Some</span> (<span class="id">dcoll</span> <span class="id">coll</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">x</span> = <span class="id">Some</span> (<span class="id">Ddistr</span> <span class="id">coll</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">load_env_lookup_initunit</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">nnrc_env</span> <span class="id">mr_env</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">load_init_env_success</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">nnrc_env</span> <span class="id">mr_env</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">initunit</span> = <span class="id">Some</span> (<span class="id">Dlocal</span> <span class="id">dunit</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2845')">Proof.</div>
<div class="proofscript" id="proof2845">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hmr_env</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">load_init_env_success</span> <span class="kwd">in</span> <span class="id">Hmr_env</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Hmr_env</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">load_init_env</span>, <span class="id">mkDistConstants</span>, <span class="id">mkDistConstant</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">rmap</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x_loc</span> : <span class="id">string</span> * <span class="id">dlocalization</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">x</span>, <span class="id">loc</span>) := <span class="id">x_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">olift</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">d</span> : <span class="id">data</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lift</span> (<span class="kwd">fun</span> <span class="id">dd</span> : <span class="id">ddata</span> =&gt; (<span class="id">x</span>, <span class="id">dd</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">loc</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Vlocal</span> =&gt; <span class="id">Some</span> (<span class="id">Dlocal</span> <span class="id">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Vdistr</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">d</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dunit</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dnat</span> <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dbool</span> <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dstring</span> <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dcoll</span> <span class="id">coll</span> =&gt; <span class="id">Some</span> (<span class="id">Ddistr</span> <span class="id">coll</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">drec</span> <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dleft</span> <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dright</span> <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dbrand</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">dforeign</span> <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>) (<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">nnrc_env</span> <span class="id">x</span>)) <span class="id">vars_loc</span>); <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dest_eqdec</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mr_chain_of_nnrc_with_no_free_var</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">output</span>: <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">coll_n</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">var</span> := "<span class="id">x</span>"%<span class="id">string</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">var</span>, <span class="id">NNRCUnop</span> <span class="id">AColl</span> <span class="id">n</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">initunit</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">output</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapScalar</span> <span class="id">coll_n</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">RedSingleton</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr</span>::<span class="id">nil</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcmr_of_nnrc_with_no_free_var</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">free_vars_loc</span>: <span class="id">vdbindings</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">output</span>: <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRChain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">free_vars_loc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr_chain_of_nnrc_with_no_free_var</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">output</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">output</span>::<span class="id">nil</span>, (<span class="id">NNRCVar</span> <span class="id">output</span>)), (<span class="id">output</span>, <span class="id">Vlocal</span>)::<span class="id">nil</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrcmr_of_nnrc_with_no_free_var_wf</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">free_vars_loc</span>: <span class="id">vdbindings</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">output</span>: <span class="id">var</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_global_vars</span> <span class="id">n</span> = <span class="id">nil</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_free_vars</span> <span class="id">n</span> = <span class="id">nil</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcmr_well_formed</span> (<span class="id">nnrcmr_of_nnrc_with_no_free_var</span> <span class="id">n</span> <span class="id">free_vars_loc</span> <span class="id">initunit</span> <span class="id">output</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2846')">Proof.</div>
<div class="proofscript" id="proof2846">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hfv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_well_formed</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">mr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_of_nnrc_with_no_free_var</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hmr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Hmr</span>; <span class="tactic">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_well_formed</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">try</span> <span class="tactic">split</span>; <span class="tactic">try</span> (<span class="tactic">rewrite</span> &lt;- <span class="id">H</span>; <span class="tactic">simpl</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">function_with_no_free_vars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">elim</span> <span class="id">H</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">simpl</span>; [<span class="tactic">assumption</span>| ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">x</span> <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">mr</span> <span class="kwd">in</span> <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">elim</span> <span class="id">H</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H0</span>; <span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrcmr_of_nnrc_with_no_free_var_correct</span> <span class="id">h</span> <span class="id">mr_env</span> <span class="id">q</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">free_vars_loc</span> <span class="id">initunit</span> <span class="id">output</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Hfv</span>: <span class="id">nnrc_free_vars</span> <span class="id">q</span> = <span class="id">nil</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Hfg</span>: <span class="id">nnrc_global_vars</span> <span class="id">q</span> = <span class="id">nil</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Hinitunit</span>: <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">initunit</span> = <span class="id">Some</span> (<span class="id">Dlocal</span> <span class="id">dunit</span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Houtput</span>: <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">output</span> = <span class="id">None</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> <span class="id">nil</span> <span class="id">q</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcmr_eval</span> <span class="id">h</span> <span class="id">mr_env</span> (<span class="id">nnrcmr_of_nnrc_with_no_free_var</span> <span class="id">q</span> <span class="id">free_vars_loc</span> <span class="id">initunit</span> <span class="id">output</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2847')">Proof.</div>
<div class="proofscript" id="proof2847">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_of_nnrc_with_no_free_var</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_chain_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Hinitunit</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">cons</span> (<span class="id">prod</span> <span class="id">var</span> <span class="id">data</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">pair</span> <span class="id">var</span> <span class="id">data</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">String</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Ascii.Ascii</span> <span class="id">false</span> <span class="id">false</span> <span class="id">false</span> <span class="id">true</span> <span class="id">true</span> <span class="id">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">true</span> <span class="id">false</span>) <span class="id">EmptyString</span>) <span class="id">dunit</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">nil</span> (<span class="id">prod</span> <span class="id">var</span> <span class="id">data</span>))) <span class="id">q</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> (@<span class="id">nil</span> (<span class="id">prod</span> <span class="id">string</span> <span class="id">data</span>)) <span class="id">q</span>) <span class="kwd">as</span> <span class="id">Heq</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ | <span class="tactic">unfold</span> <span class="id">empty_cenv</span> ;<span class="tactic">rewrite</span> <span class="id">Heq</span>; <span class="tactic">clear</span> <span class="id">Heq</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">rewrite</span> (<span class="id">nnrc_core_eval_equiv_free_in_env</span> <span class="id">q</span> (("<span class="id">x</span>"%<span class="id">string</span>, <span class="id">dunit</span>) :: <span class="id">nil</span>) <span class="id">nil</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="tactic">reflexivity</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">x</span> <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Hfv</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">case_eq</span> (<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> <span class="id">nil</span> <span class="id">q</span>); <span class="tactic">intros</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Houtput</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_last_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">build_nnrc_env</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrc_env_build</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">zip</span>, <span class="id">effective_params_from_bindings</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (@<span class="id">equiv_dec</span> <span class="id">string</span> (@<span class="id">eq</span> <span class="id">string</span>) (@<span class="id">eq_equivalence</span> <span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">string_eqdec</span> <span class="id">output</span> <span class="id">output</span>); <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mr_chain_of_nnrc_with_one_free_var</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">x_loc</span>: <span class="id">var</span> * <span class="id">dlocalization</span>) (<span class="id">output</span>:<span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">x_loc</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">x</span>, <span class="id">Vlocal</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">output</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapScalar</span> (<span class="id">x</span>, <span class="id">NNRCUnop</span> <span class="id">AColl</span> <span class="id">n</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">RedSingleton</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr</span>::<span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">x</span>, <span class="id">Vdistr</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">values</span> := <span class="id">x</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">output</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapDist</span> <span class="id">id_function</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RedCollect</span> (<span class="id">values</span>, <span class="id">n</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr</span>::<span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcmr_of_nnrc_with_one_free_var</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">x_loc</span>: <span class="id">var</span> * <span class="id">dlocalization</span>) (<span class="id">free_vars_loc</span>: <span class="id">vdbindings</span>)  (<span class="id">output</span>:<span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRChain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">free_vars_loc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr_chain_of_nnrc_with_one_free_var</span> <span class="id">n</span> <span class="id">x_loc</span> <span class="id">output</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">output</span>::<span class="id">nil</span>, (<span class="id">NNRCVar</span> <span class="id">output</span>)), (<span class="id">output</span>, <span class="id">Vlocal</span>)::<span class="id">nil</span>).<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrcmr_of_nnrc_with_one_free_var_wf</span> (<span class="id">free_vars_loc</span>: <span class="id">vdbindings</span>) (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">x_loc</span>: <span class="id">var</span> * <span class="id">dlocalization</span>) (<span class="id">output</span>:<span class="id">var</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">function_with_no_free_vars</span> (<span class="id">fst</span> <span class="id">x_loc</span>, <span class="id">n</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcmr_well_formed</span> (<span class="id">nnrcmr_of_nnrc_with_one_free_var</span> <span class="id">n</span> <span class="id">x_loc</span> <span class="id">free_vars_loc</span> <span class="id">output</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2848')">Proof.</div>
<div class="proofscript" id="proof2848">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hfv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_well_formed</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">mr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_of_nnrc_with_one_free_var</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">x_loc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">d</span>; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hmr</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Hmr</span>; <span class="tactic">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_well_formed</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">split</span>; [ | <span class="tactic">trivial</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">function_with_no_free_vars</span> <span class="kwd">in</span> *; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">apply</span> <span class="id">id_function_no_free_vars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">unfold</span> <span class="id">function_with_no_free_vars</span> <span class="kwd">in</span> *; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrcmr_of_nnrc_with_one_free_var_correct</span> <span class="id">h</span> <span class="id">nnrc_env</span> <span class="id">mr_env</span> <span class="id">n</span> <span class="id">x_loc</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">free_vars_loc</span> <span class="id">output</span> <span class="id">initunit</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Hnnrc_env</span>: <span class="id">exists</span> <span class="id">d</span>, <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">nnrc_env</span> (<span class="id">fst</span> <span class="id">x_loc</span>) = <span class="id">Some</span> <span class="id">d</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Hmr_env</span>: <span class="id">load_init_env_success</span> <span class="id">initunit</span> (<span class="id">x_loc</span>::<span class="id">nil</span>) <span class="id">nnrc_env</span> <span class="id">mr_env</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Hfv</span>: <span class="id">function_with_no_free_vars</span> (<span class="id">fst</span> <span class="id">x_loc</span>, <span class="id">n</span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Houtput</span>: <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">output</span> = <span class="id">None</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> <span class="id">nnrc_env</span> <span class="id">n</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcmr_eval</span> <span class="id">h</span> <span class="id">mr_env</span> (<span class="id">nnrcmr_of_nnrc_with_one_free_var</span> <span class="id">n</span> <span class="id">x_loc</span> <span class="id">free_vars_loc</span> <span class="id">output</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2849')">Proof.</div>
<div class="proofscript" id="proof2849">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">load_init_env_success</span>, <span class="id">mkDistConstants</span> <span class="kwd">in</span> <span class="id">Hmr_env</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Hmr_env</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_of_nnrc_with_one_free_var</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">x_loc</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">d</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">specialize</span> (<span class="id">H0</span> <span class="id">v</span>); <span class="tactic">clear</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dest_eqdec</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Some</span> <span class="id">Vlocal</span> = <span class="id">Some</span> <span class="id">Vlocal</span>) <span class="kwd">as</span> <span class="id">Htrivial</span>; [ <span class="tactic">reflexivity</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H0</span> <span class="id">Htrivial</span>); <span class="tactic">clear</span> <span class="id">Htrivial</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_chain_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (@<span class="id">lookup</span> <span class="id">var</span> <span class="id">ddata</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">equiv_dec</span> <span class="id">var</span> (@<span class="id">eq</span> <span class="id">var</span>) (@<span class="id">eq_equivalence</span> <span class="id">var</span>) <span class="id">string_eqdec</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_env</span> <span class="id">v</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">lift</span> <span class="id">data</span> <span class="id">ddata</span> <span class="id">Dlocal</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">lookup</span> <span class="id">string</span> <span class="id">data</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">equiv_dec</span> <span class="id">string</span> (@<span class="id">eq</span> <span class="id">string</span>) (@<span class="id">eq_equivalence</span> <span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">string_eqdec</span>) <span class="id">nnrc_env</span> <span class="id">v</span>))) <span class="kwd">as</span> <span class="id">Heq</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="tactic">rewrite</span> <span class="id">H0</span>; <span class="tactic">reflexivity</span> | <span class="tactic">rewrite</span> <span class="id">Heq</span>; <span class="tactic">clear</span> <span class="id">Heq</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Hnnrc_env</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">lift</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (@<span class="id">lookup</span> <span class="id">string</span> <span class="id">data</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">equiv_dec</span> <span class="id">string</span> (@<span class="id">eq</span> <span class="id">string</span>) (@<span class="id">eq_equivalence</span> <span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">string_eqdec</span>) <span class="id">nnrc_env</span> <span class="id">v</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">Some</span> <span class="id">data</span> <span class="id">x</span>) <span class="kwd">as</span> <span class="id">Heq</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="tactic">auto</span> | <span class="tactic">rewrite</span> <span class="id">Heq</span>; <span class="tactic">clear</span> <span class="id">Heq</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> ((<span class="id">v</span>, <span class="id">x</span>) :: <span class="id">nil</span>) <span class="id">n</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> <span class="id">nnrc_env</span> <span class="id">n</span>) <span class="kwd">as</span> <span class="id">Heq</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ | <span class="tactic">rewrite</span> <span class="id">Heq</span>; <span class="tactic">clear</span> <span class="id">Heq</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">apply</span> <span class="id">nnrc_core_eval_equiv_free_in_env</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dest_eqdec</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">elim</span> <span class="id">Hfv</span>; <span class="tactic">clear</span> <span class="id">Hfv</span>; <span class="tactic">intros</span> <span class="id">Hgv</span> <span class="id">Hfv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">Hfv</span> <span class="id">x0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">Hfv</span> <span class="id">H2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">c</span> <span class="id">Hfv</span>). <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">destruct</span> (<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> <span class="id">nnrc_env</span> <span class="id">n</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (@<span class="id">lookup</span> <span class="id">var</span> (@<span class="id">ddata</span> (@<span class="id">foreign_runtime_data</span> <span class="id">fruntime</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">equiv_dec</span> <span class="id">var</span> (@<span class="id">eq</span> <span class="id">var</span>) (@<span class="id">eq_equivalence</span> <span class="id">var</span>) <span class="id">string_eqdec</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_env</span> <span class="id">output</span> = <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">output</span>) <span class="tactic">by</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H2</span>; <span class="tactic">clear</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Houtput</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_last_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">build_nnrc_env</span>, <span class="id">nnrc_env_build</span>, <span class="id">zip</span>, <span class="id">effective_params_from_bindings</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intro</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">specialize</span> (<span class="id">H1</span> <span class="id">v</span>); <span class="tactic">clear</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dest_eqdec</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Some</span> <span class="id">Vdistr</span> = <span class="id">Some</span> <span class="id">Vdistr</span>) <span class="kwd">as</span> <span class="id">Htrivial</span>; [ <span class="tactic">reflexivity</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H1</span> <span class="id">Htrivial</span>); <span class="tactic">clear</span> <span class="id">Htrivial</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_chain_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (@<span class="id">lookup</span> <span class="id">var</span> <span class="id">ddata</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">equiv_dec</span> <span class="id">var</span> (@<span class="id">eq</span> <span class="id">var</span>) (@<span class="id">eq_equivalence</span> <span class="id">var</span>) <span class="id">string_eqdec</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_env</span> <span class="id">v</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@<span class="id">Some</span> <span class="id">ddata</span> (<span class="id">Ddistr</span> <span class="id">x</span>)) <span class="kwd">as</span> <span class="id">Heq</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="tactic">assumption</span> | <span class="tactic">rewrite</span> <span class="id">Heq</span>; <span class="tactic">clear</span> <span class="id">Heq</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">rmap_id</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> ((<span class="id">v</span>, <span class="id">dcoll</span> <span class="id">x</span>) :: <span class="id">nil</span>) <span class="id">n</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> <span class="id">nnrc_env</span> <span class="id">n</span>) <span class="kwd">as</span> <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">apply</span> <span class="id">nnrc_core_eval_equiv_free_in_env</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">elim</span> <span class="id">Hfv</span>; <span class="tactic">clear</span> <span class="id">Hfv</span>; <span class="tactic">intros</span> <span class="id">Hgv</span> <span class="id">Hfv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">Hfv</span> <span class="id">x0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">Hfv</span> <span class="id">H2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dest_eqdec</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">rewrite</span> <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> <span class="id">nnrc_env</span> <span class="id">n</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (@<span class="id">lookup</span> <span class="id">var</span> (@<span class="id">ddata</span> (@<span class="id">foreign_runtime_data</span> <span class="id">fruntime</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@<span class="id">equiv_dec</span> <span class="id">var</span> (@<span class="id">eq</span> <span class="id">var</span>) (@<span class="id">eq_equivalence</span> <span class="id">var</span>) <span class="id">string_eqdec</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_env</span> <span class="id">output</span> = <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">output</span>) <span class="tactic">by</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H2</span>; <span class="tactic">clear</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Houtput</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_last_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">build_nnrc_env</span>, <span class="id">nnrc_env_build</span>, <span class="id">zip</span>, <span class="id">effective_params_from_bindings</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">case</span> (<span class="id">equiv_dec</span> <span class="id">output</span> <span class="id">output</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">brand_of_var</span> (<span class="id">x</span>: <span class="id">var</span>) := <span class="id">String.append</span> "<span class="id">__Env</span>."%<span class="id">string</span> (<span class="id">x</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">pack_closure_env</span> (<span class="id">free_vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">closure_env_name</span>: <span class="id">var</span>) : <span class="id">list</span> <span class="id">mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">List.map</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> (<span class="id">fv_loc</span>: <span class="id">var</span> * <span class="id">dlocalization</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">fv</span>, <span class="id">loc</span>) := <span class="id">fv_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr_reduce_brand</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">RedId</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">loc</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Vlocal</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr_map_brand</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">d</span>:<span class="id">var</span> := "<span class="id">x</span>"%<span class="id">string</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">d</span>, <span class="id">NNRCUnop</span> <span class="id">AColl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> (<span class="id">ABrand</span> (<span class="id">singleton</span> (<span class="id">brand_of_var</span> <span class="id">fv</span>))) (<span class="id">NNRCVar</span> <span class="id">d</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">closure_env_name</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapScalar</span> <span class="id">mr_map_brand</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_reduce_brand</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Vdistr</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr_map_brand</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">d</span>:<span class="id">var</span> := "<span class="id">x</span>"%<span class="id">string</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">d</span>, <span class="id">NNRCUnop</span> (<span class="id">ABrand</span> (<span class="id">singleton</span> (<span class="id">brand_of_var</span> <span class="id">fv</span>))) (<span class="id">NNRCVar</span> <span class="id">d</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">closure_env_name</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapDist</span> <span class="id">mr_map_brand</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_reduce_brand</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">free_vars_loc</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">unpack_closure_env</span> (<span class="id">closure_env_name</span>: <span class="id">var</span>) (<span class="id">free_vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">k</span>: <span class="id">nnrc</span>) : <span class="id">nnrc</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">List.fold_right</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">fv_loc</span> <span class="id">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">fv_loc</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">fv</span>, <span class="id">Vdistr</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">d</span> : <span class="id">var</span> := <span class="id">fresh_var</span> "<span class="id">unpackdistributed</span>$" (<span class="id">closure_env_name</span> :: <span class="id">nil</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCLet</span> <span class="id">fv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCFor</span> <span class="id">d</span> (<span class="id">NNRCVar</span> <span class="id">closure_env_name</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCEither</span> (<span class="id">NNRCUnop</span> (<span class="id">ACast</span> (<span class="id">singleton</span> (<span class="id">brand_of_var</span> <span class="id">fv</span>))) (<span class="id">NNRCVar</span> <span class="id">d</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">d</span> (<span class="id">NNRCUnop</span> <span class="id">AColl</span> (<span class="id">NNRCUnop</span> <span class="id">AUnbrand</span> (<span class="id">NNRCVar</span> <span class="id">d</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">d</span> (<span class="id">NNRCConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">fv</span>, <span class="id">Vlocal</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">d</span> : <span class="id">var</span> := <span class="id">fresh_var</span> "<span class="id">unpackscalar</span>$" (<span class="id">closure_env_name</span> :: <span class="id">nil</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCLet</span> <span class="id">fv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCEither</span> (<span class="id">NNRCUnop</span> <span class="id">ASingleton</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCFor</span> <span class="id">d</span> (<span class="id">NNRCVar</span> <span class="id">closure_env_name</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCEither</span> (<span class="id">NNRCUnop</span> (<span class="id">ACast</span> (<span class="id">singleton</span> (<span class="id">brand_of_var</span> <span class="id">fv</span>))) (<span class="id">NNRCVar</span> <span class="id">d</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">d</span> (<span class="id">NNRCUnop</span> <span class="id">AColl</span> (<span class="id">NNRCUnop</span> <span class="id">AUnbrand</span> (<span class="id">NNRCVar</span> <span class="id">d</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">d</span> (<span class="id">NNRCConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fv</span> (<span class="id">NNRCVar</span> <span class="id">fv</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fv</span> (<span class="id">NNRCConst</span> <span class="id">dunit</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">k</span> <span class="id">free_vars_loc</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mr_chain_of_nnrc_with_free_vars</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">output</span>: <span class="id">var</span>): <span class="id">list</span> <span class="id">mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">free_vars</span> := <span class="id">bdistinct</span> (<span class="id">nnrc_free_vars</span> <span class="id">n</span> ++ <span class="id">nnrc_global_vars</span> <span class="id">n</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">List.fold_right</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x</span> <span class="id">oacc</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">olift</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">loc</span> =&gt; <span class="id">lift</span> (<span class="kwd">fun</span> <span class="id">acc</span> =&gt; (<span class="id">x</span>, <span class="id">loc</span>)::<span class="id">acc</span>) <span class="id">oacc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">vars_loc</span> <span class="id">x</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Some</span> <span class="id">nil</span>) <span class="id">free_vars</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">free_vars_loc</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">closure_env_name</span>, <span class="id">vars_loc</span>) := <span class="id">fresh_mr_var</span> "<span class="id">closure</span>$" <span class="id">Vdistr</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">pack_closure_env</span> := <span class="id">pack_closure_env</span> <span class="id">free_vars_loc</span> <span class="id">closure_env_name</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">final_reduce</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">closure_env_name</span>, <span class="id">unpack_closure_env</span> <span class="id">closure_env_name</span> <span class="id">free_vars_loc</span> <span class="id">n</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">final_mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">closure_env_name</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">output</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapDist</span> <span class="id">id_function</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RedCollect</span> <span class="id">final_reduce</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pack_closure_env</span> ++ (<span class="id">final_mr</span>::<span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcmr_of_nnrc_with_free_vars</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">output</span>: <span class="id">var</span>): <span class="id">nnrcmr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRChain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vars_loc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr_chain_of_nnrc_with_free_vars</span> <span class="id">n</span> <span class="id">vars_loc</span> <span class="id">output</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">output</span>::<span class="id">nil</span>, (<span class="id">NNRCVar</span> <span class="id">output</span>)), (<span class="id">output</span>, <span class="id">Vlocal</span>)::<span class="id">nil</span>).<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">pack_closure_env_wf</span> (<span class="id">free_vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">closure_env_name</span>: <span class="id">var</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_chain_well_formed</span> (<span class="id">pack_closure_env</span> <span class="id">free_vars_loc</span> <span class="id">closure_env_name</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2850')">Proof.</div>
<div class="proofscript" id="proof2850">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">free_vars_loc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">free_vars_loc</span> = <span class="id">nil</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_chain_well_formed</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">free_vars_loc</span> &lt;&gt; <span class="id">nil</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_well_formed</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">mr</span> <span class="id">Hmr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Hmr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">unfold</span> <span class="id">mr_well_formed</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">d</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">SCase</span> "<span class="id">Scalar</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">function_with_no_free_vars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">x</span> <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Hx</span>; [ <span class="tactic">congruence</span> | <span class="id">contradiction</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">SCase</span> "<span class="id">Distributed</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">function_with_no_free_vars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">x</span> <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Hx</span>; [ <span class="tactic">congruence</span> | <span class="id">contradiction</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">IHfree_vars_loc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">unpack_closure_env_free_vars</span> (<span class="id">closure_env_name</span>: <span class="id">var</span>) (<span class="id">free_vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">k</span>: <span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">free_vars</span> := <span class="id">List.map</span> <span class="id">fst</span> <span class="id">free_vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">In</span> <span class="id">x</span> (<span class="id">nnrc_free_vars</span> (<span class="id">unpack_closure_env</span> <span class="id">closure_env_name</span> <span class="id">free_vars_loc</span> <span class="id">k</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">In</span> <span class="id">x</span> (<span class="id">closure_env_name</span> :: (<span class="id">bminus</span> <span class="id">free_vars</span> (<span class="id">bdistinct</span> (<span class="id">nnrc_free_vars</span> <span class="id">k</span>)))).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2851')">Proof.</div>
<div class="proofscript" id="proof2851">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Opaque</span> <span class="id">fresh_var</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">free_vars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">free_vars</span> = <span class="id">nil</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">right</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">bdistinct_same_elemts</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&nbsp;*)</span><br/>
&nbsp;assumption.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">free_vars</span> &lt;&gt; <span class="id">nil</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&nbsp;*)</span><br/>
&nbsp;destruct&nbsp;Hx;&nbsp;subst;&nbsp;simpl;&nbsp;[intuition&nbsp;|&nbsp;].&nbsp;*)</span>&nbsp;destruct&nbsp;(string_eqdec&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fresh_var&nbsp;"unpack$"&nbsp;(closure_env_name&nbsp;::&nbsp;nil))&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fresh_var&nbsp;"unpack$"&nbsp;(closure_env_name&nbsp;::&nbsp;nil)));&nbsp;[&nbsp;|&nbsp;congruence].&nbsp;*)</span>&nbsp;rewrite&nbsp;in_app_iff&nbsp;in&nbsp;H.&nbsp;*)</span>&nbsp;destruct&nbsp;H;&nbsp;apply&nbsp;remove_inv&nbsp;in&nbsp;H;&nbsp;destruct&nbsp;H.&nbsp;*)</span>&nbsp;+&nbsp;rewrite&nbsp;in_app_iff&nbsp;in&nbsp;H.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;simpl&nbsp;in&nbsp;H.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;destruct&nbsp;H;&nbsp;[&nbsp;|&nbsp;intuition&nbsp;].&nbsp;*)</span>&nbsp;&nbsp;&nbsp;apply&nbsp;remove_inv&nbsp;in&nbsp;H.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;destruct&nbsp;H.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;dest_eqdec;&nbsp;simpl&nbsp;in&nbsp;H;&nbsp;intuition.&nbsp;*)</span>&nbsp;+&nbsp;specialize&nbsp;(IHfree_vars&nbsp;H).&nbsp;*)</span>&nbsp;&nbsp;&nbsp;simpl&nbsp;in&nbsp;IHfree_vars.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;intuition.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;right.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;rewrite&nbsp;&lt;-&nbsp;mult_pos_equiv_in&nbsp;in&nbsp;H1&nbsp;|-&nbsp;*.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;rewrite&nbsp;bminus_mult&nbsp;in&nbsp;H1&nbsp;|-&nbsp;*.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;rewrite&nbsp;mult_on_remove;&nbsp;trivial.&nbsp;*)</span>&nbsp;&nbsp;Admitted.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrcmr_of_nnrc_with_free_vars_wf</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">output</span>: <span class="id">var</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">x</span>, <span class="id">In</span> <span class="id">x</span> (<span class="id">nnrc_free_vars</span> <span class="id">n</span>) -&gt; <span class="id">In</span> <span class="id">x</span> (<span class="id">List.map</span> <span class="id">fst</span> <span class="id">vars_loc</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcmr_well_formed</span> (<span class="id">nnrcmr_of_nnrc_with_free_vars</span> <span class="id">n</span> <span class="id">vars_loc</span> <span class="id">output</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2852')">Proof.</div>
<div class="proofscript" id="proof2852">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Opaque</span> <span class="id">fresh_var</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_well_formed</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hvars_loc</span> <span class="id">mr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_of_nnrc_with_free_vars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hmr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXXXXXX&nbsp;TODO&nbsp;XXXXXXXXXX&nbsp;*)</span><br/>
&nbsp;destruct&nbsp;(List.fold_right&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;(x&nbsp;:&nbsp;var)&nbsp;(oacc&nbsp;:&nbsp;option&nbsp;(list&nbsp;(var&nbsp;*&nbsp;dlocalization)))&nbsp;=&gt;&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;olift&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;loc&nbsp;:&nbsp;dlocalization&nbsp;=&gt;&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lift&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;acc&nbsp;:&nbsp;list&nbsp;(var&nbsp;*&nbsp;dlocalization)&nbsp;=&gt;&nbsp;(x,&nbsp;loc)&nbsp;::&nbsp;acc)&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oacc)&nbsp;(lookup&nbsp;equiv_dec&nbsp;vars_loc&nbsp;x))&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Some&nbsp;nil)&nbsp;(bdistinct&nbsp;(nnrc_free_vars&nbsp;n)));&nbsp;*)</span>&nbsp;&nbsp;&nbsp;[&nbsp;|&nbsp;apply&nbsp;in_nil&nbsp;in&nbsp;Hmr;&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contradiction&nbsp;].&nbsp;*)</span>&nbsp;simpl&nbsp;in&nbsp;Hmr.&nbsp;*)</span>&nbsp;apply&nbsp;in_app_or&nbsp;in&nbsp;Hmr.&nbsp;*)</span>&nbsp;inversion&nbsp;Hmr;&nbsp;clear&nbsp;Hmr.&nbsp;*)</span>&nbsp;-&nbsp;Case&nbsp;"pack_closure_env"%string.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;admit.&nbsp;<span class="comment">(*&nbsp;XXXXXXXXX&nbsp;TODO&nbsp;XXXXXXXXXX&nbsp;*)</span>&nbsp;*)</span>&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;generalize&nbsp;(pack_closure_env_wf&nbsp;inputdb&nbsp;(bdistinct&nbsp;free_vars_of_n)&nbsp;(really_fresh_in&nbsp;output&nbsp;(output&nbsp;::&nbsp;avoid)&nbsp;n)&nbsp;mr).&nbsp;*)</span>&nbsp;*)</span>&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;auto.&nbsp;*)</span>&nbsp;*)</span>&nbsp;-&nbsp;Case&nbsp;"final_mr"%string.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;simpl&nbsp;in&nbsp;H.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;inversion&nbsp;H;&nbsp;try&nbsp;contradiction;&nbsp;clear&nbsp;H.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;rewrite&nbsp;&lt;-&nbsp;H0;&nbsp;clear&nbsp;H0.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;unfold&nbsp;mr_well_formed.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;simpl.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;repeat&nbsp;split.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;+&nbsp;apply&nbsp;coll_function_no_free_vars.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;+&nbsp;intros&nbsp;f&nbsp;Hf.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;simpl&nbsp;in&nbsp;*.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apply&nbsp;unpack_closure_env_free_vars&nbsp;in&nbsp;Hf;&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;solve&nbsp;[&nbsp;apply&nbsp;bdistinct_same_elemts&nbsp;].&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;(Hvars_loc&nbsp;f)&nbsp;in&nbsp;Hf.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;Hfree_vars_of_n&nbsp;in&nbsp;Hf.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(bminus&nbsp;(bdistinct&nbsp;(nnrc_free_vars&nbsp;n))&nbsp;(bdistinct&nbsp;(nnrc_free_vars&nbsp;n))&nbsp;=&nbsp;nil)&nbsp;as&nbsp;Hbminus;&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;solve&nbsp;[&nbsp;apply&nbsp;bminus_self&nbsp;].&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;Hbminus&nbsp;in&nbsp;Hf;&nbsp;clear&nbsp;Hbminus.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apply&nbsp;in_inv&nbsp;in&nbsp;Hf.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destruct&nbsp;Hf;&nbsp;try&nbsp;contradiction.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;&lt;-&nbsp;H.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reflexivity.&nbsp;*)</span>&nbsp;&nbsp;Admitted.</div>
<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrcmr_of_nnrc_with_free_vars_correct</span> <span class="id">h</span> <span class="id">nnrc_env</span> <span class="id">mr_env</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">output</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">load_init_env_success</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">nnrc_env</span> <span class="id">mr_env</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">x</span>, <span class="id">In</span> <span class="id">x</span> (<span class="id">domain</span> <span class="id">nnrc_env</span>) -&gt; <span class="id">In</span> <span class="id">x</span> (<span class="id">domain</span> <span class="id">vars_loc</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">x</span>, <span class="id">In</span> <span class="id">x</span> (<span class="id">nnrc_free_vars</span> <span class="id">n</span>) -&gt; <span class="id">exists</span> <span class="id">d</span>, <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">x</span> = <span class="id">Some</span> <span class="id">d</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">mr_env</span> <span class="id">output</span> = <span class="id">None</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> <span class="id">nnrc_env</span> <span class="id">n</span> =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcmr_eval</span> <span class="id">h</span> <span class="id">mr_env</span> (<span class="id">nnrcmr_of_nnrc_with_free_vars</span> <span class="id">n</span> <span class="id">vars_loc</span> <span class="id">output</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2853')">Proof.</div>
<div class="proofscript" id="proof2853">
&nbsp;intros&nbsp;Hfree_vars_of_n&nbsp;Havoid&nbsp;Hfv&nbsp;Houtput.&nbsp;*)</span>&nbsp;unfold&nbsp;nnrcmr_of_nnrc_with_free_vars.&nbsp;*)</span>&nbsp;unfold&nbsp;nnrcmr_eval.&nbsp;*)</span>&nbsp;rewrite&nbsp;fold_left_app.&nbsp;*)</span>&nbsp;simpl.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXXXXXXXXXXX&nbsp;*)</span><br/>
&nbsp;&nbsp;Admitted.</div>
<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">get_mr_chain_vars</span> <span class="id">nrm</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">vars_loc</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">List.fold_left</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">acc</span> <span class="id">mr</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">vinput</span> := <span class="id">mr_input_localized</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">voutput</span> := <span class="id">mr_output_localized</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vinput</span> :: <span class="id">voutput</span> :: <span class="id">acc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nrm</span> <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vars_loc</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mr_chain_of_nnrc</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">output</span>: <span class="id">var</span>): <span class="id">list</span> <span class="id">mr</span> * <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr_chain</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">bdistinct</span> (<span class="id">nnrc_free_vars</span> <span class="id">n</span> ++ <span class="id">nnrc_global_vars</span> <span class="id">n</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_chain_of_nnrc_with_no_free_var</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">output</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">x</span> :: <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">vars_loc</span> <span class="id">x</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">loc</span> =&gt; <span class="id">mr_chain_of_nnrc_with_one_free_var</span> <span class="id">n</span> (<span class="id">x</span>, <span class="id">loc</span>) <span class="id">output</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">free_vars</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_chain_of_nnrc_with_free_vars</span> <span class="id">n</span> <span class="id">vars_loc</span> <span class="id">output</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">nnrcmr_vars</span> := <span class="id">get_mr_chain_vars</span> <span class="id">mr_chain</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr_chain</span>, <span class="id">nnrcmr_vars</span> ++ <span class="id">vars_loc</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcmr_of_nnrc</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">inputs_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">output</span>: <span class="id">var</span>): <span class="id">nnrcmr</span> * <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">mr_chain</span>, <span class="id">vars_loc</span>) := <span class="id">mr_chain_of_nnrc</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">inputs_loc</span> <span class="id">output</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mkMRChain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inputs_loc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_chain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">output</span>::<span class="id">nil</span>, (<span class="id">NNRCVar</span> <span class="id">output</span>)), (<span class="id">output</span>, <span class="id">Vlocal</span>)::<span class="id">nil</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vars_loc</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrcmr_of_nnrc_wf</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">output</span>: <span class="id">var</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcmr_well_formed</span> (<span class="id">fst</span> (<span class="id">nnrcmr_of_nnrc</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">output</span>)).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2854')">Proof.</div>
<div class="proofscript" id="proof2854">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_of_nnrc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">bdistinct</span> (<span class="id">nnrc_free_vars</span> <span class="id">n</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXX&nbsp;TODO&nbsp;XXXX&nbsp;*)</span><br/>
&nbsp;&nbsp;Admitted.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mr_chain_distributed_of_nnrc</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">output</span>: <span class="id">var</span>): <span class="id">list</span> <span class="id">mr</span> * <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">tmp</span>, <span class="id">vars_loc</span>) := <span class="id">fresh_mr_var</span> "<span class="id">scalarcoll</span>$"%<span class="id">string</span> <span class="id">Vdistr</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">mr_chain</span>, <span class="id">vars_loc</span>) := <span class="id">mr_chain_of_nnrc</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">tmp</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr_chain</span> ++ ((<span class="id">mr_scalar_to_distributed</span> <span class="id">tmp</span> <span class="id">output</span>)::<span class="id">nil</span>), <span class="id">vars_loc</span>).<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mk_loop</span> (<span class="id">x</span>: <span class="id">var</span>) (<span class="id">n1</span>: <span class="id">nnrc</span>) (<span class="id">n2</span>: <span class="id">nnrc</span>) (<span class="id">mr_list1</span>: <span class="id">list</span> <span class="id">mr</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) : <span class="id">nnrc</span> * <span class="id">list</span> <span class="id">mr</span> * <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">n1_distributed_result_var</span>, <span class="id">vars_loc</span>) := <span class="id">fresh_mr_var</span> "<span class="id">distcoll</span>$"%<span class="id">string</span> <span class="id">Vdistr</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">n_result_var</span>, <span class="id">vars_loc</span>) := <span class="id">fresh_mr_var</span> "<span class="id">loop_result</span>$"%<span class="id">string</span> <span class="id">Vlocal</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">mr_n1</span>, <span class="id">vars_loc</span>) := <span class="id">mr_chain_distributed_of_nnrc</span> <span class="id">n1</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">n1_distributed_result_var</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr_n2</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">n1_distributed_result_var</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">n_result_var</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapDist</span> (<span class="id">x</span>, <span class="id">n2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RedCollect</span> <span class="id">id_function</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr_list</span> : <span class="id">list</span> <span class="id">mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_list1</span> ++ <span class="id">mr_n1</span> ++ (<span class="id">mr_n2</span> :: <span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCVar</span> <span class="id">n_result_var</span>, <span class="id">mr_list</span>, <span class="id">vars_loc</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">try_mk_loop</span> (<span class="id">x</span>: <span class="id">var</span>) (<span class="id">n1</span>: <span class="id">nnrc</span>) (<span class="id">n2</span>: <span class="id">nnrc</span>) (<span class="id">mr_list1</span>: <span class="id">list</span> <span class="id">mr</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) : <span class="id">option</span> (<span class="id">nnrc</span> * <span class="id">list</span> <span class="id">mr</span> * <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">bdistinct</span> (<span class="id">nnrc_free_vars</span> <span class="id">n2</span> ++ <span class="id">nnrc_global_vars</span> <span class="id">n2</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">mk_loop</span> <span class="id">x</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">mr_list1</span> <span class="id">initunit</span> <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">x</span>' :: <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">equiv_dec</span> <span class="id">x</span> <span class="id">x</span>' <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">mk_loop</span> <span class="id">x</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">mr_list1</span> <span class="id">initunit</span> <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Program</span> <span class="kwd">Fixpoint</span> <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) { <span class="kwd">measure</span> (<span class="id">nnrc_size</span> <span class="id">n</span>) }: <span class="id">nnrc</span> * <span class="id">list</span> <span class="id">mr</span> * <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">n</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCFor</span> <span class="id">x</span> <span class="id">n1</span> <span class="id">n2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n1</span>', <span class="id">mr_list1</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n1</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">try_mk_loop</span> <span class="id">x</span> <span class="id">n1</span>' <span class="id">n2</span> <span class="id">mr_list1</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">n</span>', <span class="id">mr_list</span>, <span class="id">vars_loc</span>) =&gt; (<span class="id">n</span>', <span class="id">mr_list</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCFor</span> <span class="id">x</span> <span class="id">n1</span>' <span class="id">n2</span>, <span class="id">mr_list1</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCGetConstant</span> <span class="id">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">n</span>, <span class="id">nil</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCVar</span> <span class="id">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">n</span>, <span class="id">nil</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCConst</span> <span class="id">d</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">n</span>, <span class="id">nil</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> <span class="id">op</span> <span class="id">n1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n1</span>', <span class="id">mr_list1</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n1</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">foreign_to_reduce_op_of_unary_op</span> <span class="id">op</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">red_op</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">n1_distributed_result_var</span>, <span class="id">vars_loc</span>) := <span class="id">fresh_mr_var</span> "<span class="id">distcoll</span>$"%<span class="id">string</span> <span class="id">Vdistr</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">mr_n1</span>, <span class="id">vars_loc</span>) := <span class="id">mr_chain_distributed_of_nnrc</span> <span class="id">n1</span>' <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">n1_distributed_result_var</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">result_var</span>, <span class="id">vars_loc</span>) := <span class="id">fresh_mr_var</span> "<span class="id">res</span>$"%<span class="id">string</span> <span class="id">Vlocal</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">n1_distributed_result_var</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">result_var</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapDist</span> <span class="id">id_function</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RedOp</span> <span class="id">red_op</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCVar</span> <span class="id">result_var</span>, <span class="id">mr_list1</span> ++ <span class="id">mr_n1</span> ++ (<span class="id">mr</span> :: <span class="id">nil</span>), <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">op</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AFlatten</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">n1_distributed_result_var</span>, <span class="id">vars_loc</span>) := <span class="id">fresh_mr_var</span> "<span class="id">distcoll</span>$"%<span class="id">string</span> <span class="id">Vdistr</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">mr_n1</span>, <span class="id">vars_loc</span>) := <span class="id">mr_chain_distributed_of_nnrc</span> <span class="id">n1</span>' <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">n1_distributed_result_var</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">flatten_result_var</span>, <span class="id">vars_loc</span>) := <span class="id">fresh_mr_var</span> "<span class="id">flat</span>$"%<span class="id">string</span> <span class="id">Vdistr</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mr_flatten</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMR</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">n1_distributed_result_var</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">flatten_result_var</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MapDistFlatten</span> <span class="id">id_function</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">RedId</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCVar</span> <span class="id">flatten_result_var</span>, <span class="id">mr_list1</span> ++ <span class="id">mr_n1</span> ++ (<span class="id">mr_flatten</span> :: <span class="id">nil</span>), <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; (<span class="id">NNRCUnop</span> <span class="id">op</span> <span class="id">n1</span>', <span class="id">mr_list1</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCBinop</span> <span class="id">op</span> <span class="id">n1</span> <span class="id">n2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n1</span>', <span class="id">mr_list1</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n1</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n2</span>', <span class="id">mr_list2</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n2</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCBinop</span> <span class="id">op</span> <span class="id">n1</span>' <span class="id">n2</span>', <span class="id">mr_list1</span> ++ <span class="id">mr_list2</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCLet</span> <span class="id">x</span> <span class="id">n1</span> <span class="id">n2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n1</span>', <span class="id">mr_list1</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n1</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">x_fresh</span> := <span class="id">nnrc_pick_name</span> "$" <span class="id">id</span> (<span class="id">domain</span> <span class="id">vars_loc</span>) <span class="id">x</span> <span class="id">n2</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">n2</span> := <span class="id">nnrc_rename_lazy</span> <span class="id">n2</span> <span class="id">x</span> <span class="id">x_fresh</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">mr_n1</span>, <span class="id">vars_loc</span>) := <span class="id">mr_chain_of_nnrc</span> <span class="id">n1</span>' <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">x_fresh</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n2</span>', <span class="id">mr_list2</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n2</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">n2</span>', <span class="id">mr_list1</span> ++ <span class="id">mr_n1</span> ++ <span class="id">mr_list2</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCIf</span> <span class="id">n0</span> <span class="id">n1</span> <span class="id">n2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n0</span>', <span class="id">mr_list</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n0</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n1</span>', <span class="id">mr_list1</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n1</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n2</span>', <span class="id">mr_list2</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n2</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCIf</span> <span class="id">n0</span>' <span class="id">n1</span>' <span class="id">n2</span>', <span class="id">nil</span>, <span class="id">vars_loc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCEither</span> <span class="id">n0</span> <span class="id">x</span> <span class="id">n1</span> <span class="id">y</span> <span class="id">n2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">n</span>, <span class="id">nil</span>, <span class="id">vars_loc</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCGroupBy</span> <span class="id">g</span> <span class="id">sl</span> <span class="id">n1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">n</span>, <span class="id">nil</span>, <span class="id">vars_loc</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2855')">Next Obligation.</div>
<div class="proofscript" id="proof2855">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;Defined.</div>
<div class="toggleproof" onclick="toggleDisplay('proof2856')">Next Obligation.</div>
<div class="proofscript" id="proof2856">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;Defined.</div>
<div class="toggleproof" onclick="toggleDisplay('proof2857')">Next Obligation.</div>
<div class="proofscript" id="proof2857">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;Defined.</div>
<div class="toggleproof" onclick="toggleDisplay('proof2858')">Next Obligation.</div>
<div class="proofscript" id="proof2858">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;Defined.</div>
<div class="toggleproof" onclick="toggleDisplay('proof2859')">Next Obligation.</div>
<div class="proofscript" id="proof2859">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">nnrc_rename_lazy_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;Defined.</div>
<div class="toggleproof" onclick="toggleDisplay('proof2860')">Next Obligation.</div>
<div class="proofscript" id="proof2860">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;Defined.</div>
<div class="toggleproof" onclick="toggleDisplay('proof2861')">Next Obligation.</div>
<div class="proofscript" id="proof2861">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;Defined.</div>
<div class="toggleproof" onclick="toggleDisplay('proof2862')">Next Obligation.</div>
<div class="proofscript" id="proof2862">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;Defined.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrc_to_nnrcmr_chain_aux_causally_consistent</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">shadow_free</span> <span class="id">n</span> = <span class="id">true</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">_</span>, <span class="id">mr_chain</span>, <span class="id">_</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_chain_causally_consistent</span> <span class="id">mr_chain</span> = <span class="id">true</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2863')">Proof.</div>
<div class="proofscript" id="proof2863">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_cases</span> (<span class="tactic">induction</span> <span class="id">n</span>) <span class="id">Case</span>; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span> [ <span class="tactic">unfold</span> <span class="id">nnrcmr_causally_consistent</span>; <span class="tactic">reflexivity</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">NNRCBinop</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hshadow_free</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n1</span> <span class="id">initunit</span> <span class="id">vars_loc</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">tmp</span> <span class="id">vars_loc1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">tmp</span> <span class="kwd">as</span> (<span class="id">n1</span>', <span class="id">mr_list1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hn1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n2</span> <span class="id">initunit</span> <span class="id">vars_loc1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">tmp</span> <span class="id">vars_loc2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">tmp</span> <span class="kwd">as</span> (<span class="id">n2</span>', <span class="id">mr_list2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">Hn2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_causally_consistent</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXX&nbsp;TODO&nbsp;XXXXXXX&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">NNRCUnop</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXX&nbsp;TODO&nbsp;XXXXXXX&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">NNRCLet</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXX&nbsp;TODO&nbsp;XXXXXXX&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">NNRCFor</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXX&nbsp;TODO&nbsp;XXXXXXX&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">Case</span> "<span class="id">NNRCIf</span>"%<span class="id">string</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXX&nbsp;TODO&nbsp;XXXXXXX&nbsp;*)</span><br/>
&nbsp;&nbsp;Admitted.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrc_to_mr_chain_ns</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">vars_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) (<span class="id">output</span>: <span class="id">var</span>) : <span class="id">list</span> <span class="id">mr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">n</span>', <span class="id">mr_list</span>, <span class="id">vars_loc</span>) := <span class="id">nnrc_to_nnrcmr_chain_ns_aux</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">final_mr</span>, <span class="id">_</span>) := <span class="id">mr_chain_of_nnrc</span> <span class="id">n</span>' <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">output</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_list</span> ++ <span class="id">final_mr</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrc_to_nnrcmr_chain_ns</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">inputs_loc</span>: <span class="id">vdbindings</span>) (<span class="id">vars_loc</span>: <span class="id">vdbindings</span>) : <span class="id">nnrcmr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">output</span> := <span class="id">fresh_var</span> "<span class="id">output</span>" (<span class="id">domain</span> <span class="id">vars_loc</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRChain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inputs_loc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_to_mr_chain_ns</span> <span class="id">n</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">output</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">output</span>::<span class="id">nil</span>, (<span class="id">NNRCVar</span> <span class="id">output</span>)), (<span class="id">output</span>, <span class="id">Vlocal</span>)::<span class="id">nil</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrc_to_nnrcmr_chain</span> (<span class="id">initunit</span>: <span class="id">var</span>) (<span class="id">inputs_loc</span>: <span class="id">vdbindings</span>) (<span class="id">n</span>: <span class="id">nnrc</span>) : <span class="id">nnrcmr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">n_ns</span> :=  <span class="id">n</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">vars_loc</span> := <span class="id">inputs_loc</span> ++ <span class="id">List.map</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; (<span class="id">x</span>, <span class="id">Vlocal</span>)) (<span class="id">nnrc_bound_vars</span> <span class="id">n_ns</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_to_nnrcmr_chain_ns</span> <span class="id">n_ns</span> <span class="id">initunit</span> <span class="id">inputs_loc</span> <span class="id">vars_loc</span>.<br/>
<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrc_to_nnrcmr_no_chain</span> (<span class="id">n</span>: <span class="id">nnrc</span>) (<span class="id">inputs_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) : <span class="id">nnrcmr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRChain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inputs_loc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">List.map</span> <span class="id">fst</span> <span class="id">inputs_loc</span>, <span class="id">n</span>), <span class="id">inputs_loc</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">load_init_env_build_nnrc_env_id</span> <span class="id">env</span> <span class="id">initunit</span> <span class="id">mr_env</span> <span class="id">vars_loc</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">load_init_env</span> <span class="id">initunit</span> <span class="id">vars_loc</span> <span class="id">env</span> = <span class="id">Some</span> <span class="id">mr_env</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">build_nnrc_env</span> <span class="id">mr_env</span> (<span class="id">map</span> <span class="id">fst</span> <span class="id">vars_loc</span>) <span class="id">vars_loc</span> = <span class="id">Some</span> ((<span class="id">initunit</span>, <span class="id">dunit</span>) :: <span class="id">env</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2864')">Proof.</div>
<div class="proofscript" id="proof2864">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">env</span> <span class="id">mr_env</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">vars_loc</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;Admitted.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Theorem</span> <span class="id">nnrc_to_nnrcmr_no_chain_correct</span> <span class="id">h</span> <span class="id">env</span> <span class="id">initunit</span> <span class="id">mr_env</span> (<span class="id">n</span>:<span class="id">nnrc</span>) (<span class="id">inputs_loc</span>: <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>)) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">load_init_env</span> <span class="id">initunit</span> <span class="id">inputs_loc</span> <span class="id">env</span> = <span class="id">Some</span> <span class="id">mr_env</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">empty_cenv</span> <span class="id">env</span> <span class="id">n</span> = <span class="id">nnrcmr_eval</span> <span class="id">h</span> <span class="id">mr_env</span> (<span class="id">nnrc_to_nnrcmr_no_chain</span> <span class="id">n</span> <span class="id">inputs_loc</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2865')">Proof.</div>
<div class="proofscript" id="proof2865">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrc_to_nnrcmr_no_chain</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_last_eval</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">load_init_env_build_nnrc_env_id</span> <span class="id">env</span> <span class="id">initunit</span> <span class="id">mr_env</span> <span class="id">inputs_loc</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Admitted.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">Top</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">nnrc_deconst</span> (<span class="id">e</span>:<span class="id">nnrc</span>) : <span class="id">nnrc</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCGetConstant</span> <span class="id">y</span> =&gt; <span class="id">NNRCVar</span> <span class="id">y</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCVar</span> <span class="id">y</span> =&gt; <span class="id">NNRCVar</span> <span class="id">y</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCConst</span> <span class="id">d</span> =&gt; <span class="id">NNRCConst</span> <span class="id">d</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCBinop</span> <span class="id">bop</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NNRCBinop</span> <span class="id">bop</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e1</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> <span class="id">uop</span> <span class="id">e1</span> =&gt; <span class="id">NNRCUnop</span> <span class="id">uop</span> (<span class="id">nnrc_deconst</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCLet</span> <span class="id">y</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCLet</span> <span class="id">y</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e1</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCFor</span> <span class="id">y</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCFor</span> <span class="id">y</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e1</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCIf</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">e3</span> =&gt;  <span class="id">NNRCIf</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">e3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCEither</span> <span class="id">ed</span> <span class="id">xl</span> <span class="id">el</span> <span class="id">xr</span> <span class="id">er</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCEither</span> (<span class="id">nnrc_deconst</span> <span class="id">ed</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">xl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">el</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">xr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nnrc_deconst</span> <span class="id">er</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCGroupBy</span> <span class="id">g</span> <span class="id">sl</span> <span class="id">e1</span> =&gt; <span class="id">NNRCGroupBy</span> <span class="id">g</span> <span class="id">sl</span> (<span class="id">nnrc_deconst</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrc_to_nnrcmr_top</span> (<span class="id">vinit</span>: <span class="id">var</span>) (<span class="id">inputs_loc</span>:<span class="id">vdbindings</span>) (<span class="id">q</span>:<span class="id">nnrc</span>) : <span class="id">nnrcmr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">inputs_loc</span> := (<span class="id">vinit</span>, <span class="id">Vlocal</span>) :: <span class="id">inputs_loc</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">q</span> := <span class="id">nnrc_to_nnrc_core</span> (<span class="id">nnrc_deconst</span> <span class="id">q</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lift_nnrc_core</span> (<span class="id">nnrc_to_nnrcmr_chain</span> <span class="id">vinit</span> <span class="id">inputs_loc</span>) <span class="id">q</span>.<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">Top</span>.<br/>
&nbsp;&nbsp;<br/>
<span class="kwd">End</span> <span class="id">NNRCtoNNRCMR</span>.<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</div>
</body>
</html>
