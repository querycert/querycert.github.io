
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Qcert.NRAEnv.Optim.NRAEnvOptimizer</title>
<meta name="description" content="Documentation of Coq module Qcert.NRAEnv.Optim.NRAEnvOptimizer" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Qcert.NRAEnv.Optim.NRAEnvOptimizer</h1>
<div class="coq">
<br/>
<span class="kwd">Section</span> <span class="id">NRAEnvOptimizer</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Equivalence</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Morphisms</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Setoid</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">EquivDec</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="kwd">Program</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span> <span class="id">List</span> <span class="id">ListSet</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Utils</span> <span class="id">BasicSystem</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">cNRAEnv</span> <span class="id">cNRAEnvEq</span> <span class="id">TcNRAEnv</span> <span class="id">TcNRAEnvEq</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NRAEnv</span> <span class="id">NRAEnvEq</span> <span class="id">TNRAEnv</span> <span class="id">TNRAEnvEq</span> <span class="id">NRAEnvRewrite</span> <span class="id">TNRAEnvRewrite</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">cNRAEnvIgnore</span> <span class="id">TcNRAEnvIgnore</span> <span class="id">NRAEnvIgnore</span> <span class="id">cNRAEnvSize</span> <span class="id">NRAEnvSize</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">OptimizerStep</span> <span class="id">OptimizerLogger</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">nraenv_scope</span>.<br/>
&nbsp;&nbsp;<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Ltac</span> <span class="id">tcorrectness_prover</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">repeat</span> <span class="tactic">progress</span> (<span class="tactic">try</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| [|- <span class="id">context</span> [<span class="kwd">match</span> ?<span class="id">p</span> <span class="kwd">with</span> | <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>] ] =&gt; <span class="tactic">destruct</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">try</span> <span class="tactic">unfold</span> <span class="id">Equivalence.equiv</span> <span class="kwd">in</span> *; <span class="tactic">try</span> <span class="tactic">subst</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Ltac</span> <span class="id">tprove_correctness</span> <span class="id">p</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcorrectness_prover</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnraenv_rewrites_to_trans</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p1</span> <span class="id">p2</span> <span class="id">p3</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p1</span> ⇒ₓ <span class="id">p2</span> -&gt; <span class="id">p2</span> ⇒ₓ <span class="id">p3</span> -&gt; <span class="id">p1</span> ⇒ₓ <span class="id">p3</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2203')">Proof.</div>
<div class="proofscript" id="proof2203">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="tactic">transitivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">AUX</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">f</span> <span class="id">p</span> <span class="id">p</span>':<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">p</span>, <span class="id">p</span> ⇒ₓ <span class="id">f</span> <span class="id">p</span>) -&gt; <span class="id">p</span> ⇒ₓ <span class="id">p</span>' -&gt; <span class="id">p</span> ⇒ₓ <span class="id">f</span> <span class="id">p</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2204')">Proof.</div>
<div class="proofscript" id="proof2204">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span> <span class="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p</span>') <span class="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
<div class="doc">Apply the function f to the direct child of p </div>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">rewriter</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nraenv_map</span> (<span class="id">f</span>: <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>) (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvID</span> =&gt; <span class="id">NRAEnvID</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvConst</span> <span class="id">rd</span> =&gt; <span class="id">NRAEnvConst</span> <span class="id">rd</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> <span class="id">bop</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvBinop</span> <span class="id">bop</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">uop</span> <span class="id">op1</span> =&gt; <span class="id">NRAEnvUnop</span> <span class="id">uop</span> (<span class="id">f</span> <span class="id">op1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvMap</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMapConcat</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvMapConcat</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProduct</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvProduct</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvSelect</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEither</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvEither</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEitherConcat</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvEitherConcat</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvDefault</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvDefault</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvApp</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvGetConstant</span> <span class="id">s</span> =&gt; <span class="id">NRAEnvGetConstant</span> <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEnv</span> =&gt; <span class="id">NRAEnvEnv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvAppEnv</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMapEnv</span> <span class="id">op1</span> =&gt; <span class="id">NRAEnvMapEnv</span> (<span class="id">f</span> <span class="id">op1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvFlatMap</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvFlatMap</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvJoin</span> <span class="id">op1</span> <span class="id">op2</span> <span class="id">op3</span> =&gt; <span class="id">NRAEnvJoin</span> (<span class="id">f</span> <span class="id">op1</span>) (<span class="id">f</span> <span class="id">op2</span>) (<span class="id">f</span> <span class="id">op3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProject</span> <span class="id">sl</span> <span class="id">op1</span> =&gt; <span class="id">NRAEnvProject</span> <span class="id">sl</span> (<span class="id">f</span> <span class="id">op1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvGroupBy</span> <span class="id">s</span> <span class="id">sl</span> <span class="id">op1</span> =&gt; <span class="id">NRAEnvGroupBy</span> <span class="id">s</span> <span class="id">sl</span> (<span class="id">f</span> <span class="id">op1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnnest</span> <span class="id">a</span> <span class="id">b</span> <span class="id">op1</span> =&gt; <span class="id">NRAEnvUnnest</span> <span class="id">a</span> <span class="id">b</span> (<span class="id">f</span> <span class="id">op1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
<div class="doc">Apply the function f to all subexpression fo p. </div>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">nraenv_map_deep</span> (<span class="id">f</span>: <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>) (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvID</span> =&gt; <span class="id">f</span> <span class="id">NRAEnvID</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvConst</span> <span class="id">rd</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvConst</span> <span class="id">rd</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> <span class="id">bop</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvBinop</span> <span class="id">bop</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">uop</span> <span class="id">op1</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvUnop</span> <span class="id">uop</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvMap</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMapConcat</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvMapConcat</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProduct</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvProduct</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvSelect</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvDefault</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvDefault</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEither</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvEither</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEitherConcat</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvEitherConcat</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvApp</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvGetConstant</span> <span class="id">s</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvGetConstant</span> <span class="id">s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEnv</span> =&gt; <span class="id">f</span> <span class="id">NRAEnvEnv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvAppEnv</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMapEnv</span> <span class="id">op1</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvMapEnv</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvFlatMap</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvFlatMap</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvJoin</span> <span class="id">op1</span> <span class="id">op2</span> <span class="id">op3</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvJoin</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op2</span>) (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op3</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProject</span> <span class="id">sl</span> <span class="id">op1</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvProject</span> <span class="id">sl</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvGroupBy</span> <span class="id">s</span> <span class="id">sl</span> <span class="id">op1</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvGroupBy</span> <span class="id">s</span> <span class="id">sl</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnnest</span> <span class="id">a</span> <span class="id">b</span> <span class="id">op1</span> =&gt; <span class="id">f</span> (<span class="id">NRAEnvUnnest</span> <span class="id">a</span> <span class="id">b</span> (<span class="id">nraenv_map_deep</span> <span class="id">f</span> <span class="id">op1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">rewriter</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">dup</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nraenv_nodupA</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">q</span>:<span class="id">nraenv</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nodupA</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">q</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">nodupA_checker</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) : <span class="id">bool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">ADistinct</span> <span class="id">_</span> =&gt; <span class="id">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> <span class="id">AMinus</span> <span class="id">p</span>₁ <span class="id">p</span>₂ =&gt; <span class="id">nodupA_checker</span> <span class="id">p</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nodupA_checker_correct</span> {<span class="id">bm</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nodupA_checker</span> <span class="id">p</span> = <span class="id">true</span> -&gt; <span class="id">nraenv_nodupA</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2205')">Proof.</div>
<div class="proofscript" id="proof2205">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">p</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">destruct</span> <span class="id">b</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">nd</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">olift2</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_case_in</span> <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="tactic">intros</span>; <span class="tactic">rewrite</span> <span class="id">H0</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_case_in</span> <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="tactic">intros</span>; <span class="tactic">rewrite</span> <span class="id">H1</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">rondcoll2</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">some_lift</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [? ? ?].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">ondcoll2</span> <span class="kwd">in</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr_in</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr_in</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">invcs</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">bminus_NoDup</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IHp2</span> <span class="id">nd</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IHp2</span> <span class="id">h</span> <span class="id">c</span> <span class="id">dn_c</span> <span class="id">env</span> <span class="id">dn_env</span> <span class="id">x</span> <span class="id">dn_x</span> <span class="id">_</span> <span class="id">H1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">IHp2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">destruct</span> <span class="id">u</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">_</span> .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">olift</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_case_in</span> <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="tactic">intros</span>; <span class="tactic">rewrite</span> <span class="id">H0</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">rondcoll</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">some_lift</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [? ? ?].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">invcs</span> <span class="id">e0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">ondcoll</span> <span class="kwd">in</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr_in</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">invcs</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">bdistinct_NoDup</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">dup_elim_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">ADistinct</span> <span class="id">q</span>  =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">nodupA_checker</span> <span class="id">q</span> <span class="kwd">then</span> <span class="id">q</span> <span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">dup_elim_fun_correctness</span> {<span class="id">bm</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dup_elim_fun</span> <span class="id">p</span> ≡ₓ <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2206')">Proof.</div>
<div class="proofscript" id="proof2206">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">u</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_case</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">nd</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">symmetry</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_nraenv_eq_to_nraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">dup_elim</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">nodupA_checker_correct</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">dup</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnraenv_map</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} := <span class="id">nraenv_map</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnraenv_map_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>}:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">f</span>: <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>: <span class="id">nraenv</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">p</span>', <span class="id">p</span>' ⇒ₓ <span class="id">f</span> <span class="id">p</span>') -&gt; <span class="id">p</span> ⇒ₓ <span class="id">tnraenv_map</span> <span class="id">f</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2207')">Proof.</div>
<div class="proofscript" id="proof2207">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_cases</span> (<span class="tactic">induction</span> <span class="id">p</span>) <span class="id">Case</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">simpl</span>; <span class="tactic">apply</span> <span class="id">Hf</span>]; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p1</span>) <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p2</span>) <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p3</span>) <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p1</span>) <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p2</span>) <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p</span>) <span class="tactic">at</span> 1; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnraenv_map_deep</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} := <span class="id">nraenv_map_deep</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nraenv_map_deep_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>}:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">f</span>: <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>: <span class="id">nraenv</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">p</span>', <span class="id">p</span>' ⇒ₓ <span class="id">f</span> <span class="id">p</span>') -&gt; <span class="id">p</span> ⇒ₓ <span class="id">tnraenv_map_deep</span> <span class="id">f</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2208')">Proof.</div>
<div class="proofscript" id="proof2208">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">f</span> <span class="id">p</span> <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_cases</span> (<span class="tactic">induction</span> <span class="id">p</span>) <span class="id">Case</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">simpl</span>; <span class="tactic">apply</span> <span class="id">Hf</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="tactic">rewrite</span> <span class="id">IHp1</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">IHp2</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">IHp3</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">Hf</span> <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="tactic">rewrite</span> <span class="id">IHp1</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">IHp2</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">Hf</span> <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">IHp</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">Hf</span> <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tand_comm_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> <span class="id">AAnd</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvBinop</span> <span class="id">AAnd</span> <span class="id">op2</span> <span class="id">op1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tand_comm_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tand_comm_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2209')">Proof.</div>
<div class="proofscript" id="proof2209">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tand_comm_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tand_comm_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tand_comm_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">and</span> <span class="id">commute</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Swap</span> <span class="id">the</span> <span class="id">arguments</span> <span class="id">to</span> <span class="id">the</span> <span class="id">boolean</span> <span class="id">and</span> <span class="id">operator</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tand_comm_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tand_comm_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tand_comm_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tand_comm_step</span> <span class="id">tand_comm_fun_correctness</span>.<br/>
<br/>
 <br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_and_comm_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> (<span class="id">NRAEnvBinop</span> <span class="id">AAnd</span> <span class="id">op1</span> <span class="id">op2</span>) <span class="id">op</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvSelect</span> (<span class="id">NRAEnvBinop</span> <span class="id">AAnd</span> <span class="id">op2</span> <span class="id">op1</span>) <span class="id">op</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tselect_and_comm_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tselect_and_comm_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2210')">Proof.</div>
<div class="proofscript" id="proof2210">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tselect_and_comm_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tselect_and_comm_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_and_comm_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">select</span>/<span class="id">and</span> <span class="id">swap</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Swap</span> <span class="id">the</span> <span class="id">arguments</span> <span class="id">to</span> <span class="id">the</span> <span class="id">boolean</span> <span class="id">operator</span> <span class="id">when</span> <span class="id">it</span> <span class="id">is</span> <span class="id">used</span> <span class="kwd">in</span> <span class="id">a</span> <span class="id">selection</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tselect_and_comm_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tselect_and_comm_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_and_comm_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tselect_and_comm_step</span> <span class="id">tselect_and_comm_fun_correctness</span>.<br/>
<br/>
<div class="doc">σ⟨ q ⟩(q₁ ⋃ q₂) ⇒ σ⟨ q ⟩(q₁) ⋃ σ⟨ q ⟩(q₂) </div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">select_union_distr_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> <span class="id">op</span> (<span class="id">NRAEnvBinop</span> <span class="id">AUnion</span> <span class="id">op1</span> <span class="id">op2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvBinop</span> <span class="id">AUnion</span> (<span class="id">NRAEnvSelect</span> <span class="id">op</span> <span class="id">op1</span>) (<span class="id">NRAEnvSelect</span> <span class="id">op</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">select_union_distr_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">select_union_distr_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2211')">Proof.</div>
<div class="proofscript" id="proof2211">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tselect_union_distr</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">select_union_distr_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">select_union_distr_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">select</span>/<span class="id">union</span> <span class="id">distr</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Pushes</span> <span class="id">selection</span> <span class="id">through</span> <span class="id">union</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">select_union_distr_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">select_union_distr_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">select_union_distr_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">select_union_distr_step</span> <span class="id">select_union_distr_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_and_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvSelect</span> <span class="id">op1</span> (<span class="id">NRAEnvSelect</span> <span class="id">op2</span> <span class="id">op</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvSelect</span> (<span class="id">NRAEnvBinop</span> <span class="id">AAnd</span> <span class="id">op2</span> <span class="id">op1</span>) <span class="id">op</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tselect_and_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tselect_and_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2212')">Proof.</div>
<div class="proofscript" id="proof2212">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tselect_and_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tselect_and_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_and_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">select</span>/<span class="id">select</span> <span class="id">fusion</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Fuse</span> <span class="id">nested</span> <span class="id">selections</span> <span class="id">into</span> <span class="id">a</span> <span class="id">single</span> <span class="id">selection</span> <span class="kwd">using</span> <span class="id">a</span> <span class="id">conjunction</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tselect_and_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tselect_and_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_and_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tselect_and_step</span> <span class="id">tselect_and_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_from_duplicate_r_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">s2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>) <span class="id">op1</span>) (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>') <span class="id">op2</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">s2</span> == <span class="id">s2</span>' <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">op2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdot_from_duplicate_r_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tdot_from_duplicate_r_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2213')">Proof.</div>
<div class="proofscript" id="proof2213">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tenvdot_from_duplicate_r_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tdot_from_duplicate_r_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_from_duplicate_r_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">dot</span>/<span class="id">concat</span>/<span class="id">rec</span> <span class="id">right</span> <span class="id">dup</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">field</span> <span class="id">lookup</span> <span class="id">of</span> <span class="id">a</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">record</span> <span class="id">creation</span> <span class="id">of</span> <span class="id">that</span> <span class="id">field</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdot_from_duplicate_r_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdot_from_duplicate_r_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_from_duplicate_r_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdot_from_duplicate_r_step</span> <span class="id">tdot_from_duplicate_r_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_from_duplicate_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">s1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>') <span class="id">op1</span>) (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">op2</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">s1</span> &lt;&gt; <span class="id">s2</span>) <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">s1</span> == <span class="id">s1</span>' <span class="kwd">then</span> <span class="id">op1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdot_from_duplicate_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tdot_from_duplicate_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2214')">Proof.</div>
<div class="proofscript" id="proof2214">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tenvdot_from_duplicate_l_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tdot_from_duplicate_l_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_from_duplicate_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">dot</span>/<span class="id">concat</span>/<span class="id">rec</span> <span class="id">left</span> <span class="id">dup</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">field</span> <span class="id">lookup</span> <span class="id">of</span> <span class="id">a</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">record</span> <span class="id">creation</span> <span class="id">of</span> <span class="id">that</span> <span class="id">field</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdot_from_duplicate_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdot_from_duplicate_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_from_duplicate_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdot_from_duplicate_l_step</span> <span class="id">tdot_from_duplicate_l_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_coll_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p</span>) =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflatten_coll_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflatten_coll_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2215')">Proof.</div>
<div class="proofscript" id="proof2215">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tenvflatten_coll_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tflatten_coll_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_coll_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">coll</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_coll_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_coll_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_coll_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_coll_step</span> <span class="id">tflatten_coll_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_empty_record_r_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id">NRAEnvBinop</span> <span class="id">AConcat</span> <span class="id">p</span> (<span class="id">NRAEnvConst</span> (<span class="id">drec</span> [])) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tconcat_empty_record_r_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tconcat_empty_record_r_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2216')">Proof.</div>
<div class="proofscript" id="proof2216">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tconcat_empty_record_r_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tconcat_empty_record_r_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_empty_record_r_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">concat</span>/<span class="id">nil</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Remove</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">record</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tconcat_empty_record_r_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tconcat_empty_record_r_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_empty_record_r_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tconcat_empty_record_r_step</span> <span class="id">tconcat_empty_record_r_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_empty_record_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id">NRAEnvBinop</span> <span class="id">AConcat</span> (<span class="id">NRAEnvConst</span> (<span class="id">drec</span> [])) <span class="id">p</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tconcat_empty_record_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tconcat_empty_record_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2217')">Proof.</div>
<div class="proofscript" id="proof2217">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tconcat_empty_record_l_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tconcat_empty_record_l_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_empty_record_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">concat</span>/<span class="id">nil</span> <span class="id">left</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Remove</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">record</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tconcat_empty_record_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tconcat_empty_record_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_empty_record_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tconcat_empty_record_l_step</span> <span class="id">tconcat_empty_record_l_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_concat_r_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">a</span>₂) (<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span> <span class="id">q</span>₁ (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">a</span>₁) <span class="id">q</span>₂)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">a</span>₁ == <span class="id">a</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">q</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">a</span>₂) <span class="id">q</span>₁<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdot_over_concat_r_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tdot_over_concat_r_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2218')">Proof.</div>
<div class="proofscript" id="proof2218">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tdot_over_concat_eq_r_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tdot_over_concat_neq_r_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tdot_over_concat_r_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_concat_r_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">dot</span>/<span class="id">concat</span>/<span class="id">rec</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">field</span> <span class="id">lookup</span> <span class="id">of</span> <span class="id">a</span> <span class="id">concatenation</span> <span class="id">of</span> <span class="id">a</span> <span class="id">record</span> <span class="id">construction</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdot_over_concat_r_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdot_over_concat_r_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_concat_r_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdot_over_concat_r_step</span> <span class="id">tdot_over_concat_r_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_concat_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">a</span>₂) (<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">a</span>₁) <span class="id">q</span>₁) <span class="id">q</span>₂) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">a</span>₁ == <span class="id">a</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">a</span>₂) <span class="id">q</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdot_over_concat_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tdot_over_concat_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2219')">Proof.</div>
<div class="proofscript" id="proof2219">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tdot_over_concat_neq_l_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tdot_over_concat_l_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_concat_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">dot</span>/<span class="id">concat</span>/<span class="id">rec</span> <span class="id">left</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">field</span> <span class="id">lookup</span> <span class="id">of</span> <span class="id">a</span> <span class="id">concatenation</span> <span class="id">of</span> <span class="id">a</span> <span class="id">record</span> <span class="id">construction</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdot_over_concat_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdot_over_concat_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_concat_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdot_over_concat_l_step</span> <span class="id">tdot_over_concat_l_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_empty_record_r_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">p</span> (<span class="id">NRAEnvConst</span> (<span class="id">drec</span> [])) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmerge_empty_record_r_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmerge_empty_record_r_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2220')">Proof.</div>
<div class="proofscript" id="proof2220">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmerge_empty_record_r_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmerge_empty_record_r_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_empty_record_r_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">merge</span>-<span class="id">concat</span>/<span class="id">nil</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">merge</span> <span class="id">concat</span> <span class="id">of</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">record</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmerge_empty_record_r_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmerge_empty_record_r_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_empty_record_r_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmerge_empty_record_r_step</span> <span class="id">tmerge_empty_record_r_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_empty_record_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> (<span class="id">NRAEnvConst</span> (<span class="id">drec</span> [])) <span class="id">p</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmerge_empty_record_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmerge_empty_record_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2221')">Proof.</div>
<div class="proofscript" id="proof2221">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmerge_empty_record_l_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmerge_empty_record_l_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_empty_record_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">merge</span>-<span class="id">concat</span>/<span class="id">nil</span> <span class="id">left</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">merge</span> <span class="id">concat</span> <span class="id">of</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">record</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmerge_empty_record_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmerge_empty_record_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_empty_lecord_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmerge_empty_record_l_step</span> <span class="id">tmerge_empty_record_l_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_into_id_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> <span class="id">NRAEnvID</span> <span class="id">p</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_into_id_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmap_into_id_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2222')">Proof.</div>
<div class="proofscript" id="proof2222">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tenvmap_into_id_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmap_into_id_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_into_id_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>/<span class="id">id</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">map</span> <span class="id">of</span> <span class="id">ID</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_into_id_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_into_id_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_into_id_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_into_id_step</span> <span class="id">tmap_into_id_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_map_coll_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p1</span>) <span class="id">p2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> <span class="id">p1</span> <span class="id">p2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflatten_map_coll_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflatten_map_coll_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2223')">Proof.</div>
<div class="proofscript" id="proof2223">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tenvflatten_map_coll_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tflatten_map_coll_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_map_coll_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">coll</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">the</span> <span class="id">map</span> <span class="id">of</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_map_coll_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_map_coll_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_map_coll_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_map_coll_step</span> <span class="id">tflatten_map_coll_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_flatten_map_either_nil_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> <span class="id">p</span>₁ (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₂) <span class="id">p</span>₃)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvApp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> <span class="id">p</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₂) <span class="id">p</span>₃)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflatten_flatten_map_either_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflatten_flatten_map_either_nil_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2224')">Proof.</div>
<div class="proofscript" id="proof2224">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflatten_flatten_map_either_nil</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tflatten_flatten_map_either_nil_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_flatten_map_either_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">app</span>/<span class="id">either</span>/<span class="id">nil</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">nested</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">an</span> <span class="id">either</span> <span class="id">nil</span> (<span class="id">under</span> <span class="id">an</span> <span class="id">application</span>)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_flatten_map_either_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_flatten_map_either_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_flatten_map_either_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_flatten_map_either_nil_step</span> <span class="id">tflatten_flatten_map_either_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_map_compose_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> <span class="id">p1</span> (<span class="id">NRAEnvMap</span> <span class="id">p2</span> <span class="id">p3</span>) =&gt; <span class="id">NRAEnvMap</span> (<span class="id">NRAEnvApp</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p3</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_map_compose_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmap_map_compose_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2225')">Proof.</div>
<div class="proofscript" id="proof2225">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tenvmap_map_compose_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmap_map_compose_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_map_compose_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>/<span class="id">map</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Fuses</span> <span class="id">nested</span> <span class="id">maps</span> <span class="id">together</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_map_compose_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_map_compose_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_map_compose_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_map_compose_step</span> <span class="id">tmap_map_compose_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_singleton_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> <span class="id">p1</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p2</span>) =&gt; <span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvApp</span> <span class="id">p1</span> <span class="id">p2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_singleton_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmap_singleton_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2226')">Proof.</div>
<div class="proofscript" id="proof2226">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tenvmap_singleton_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmap_singleton_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_singleton_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>/<span class="id">coll</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Lowers</span> <span class="id">a</span> <span class="id">map</span> <span class="id">over</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_singleton_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_singleton_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_singleton_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_singleton_step</span> <span class="id">tmap_singleton_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_id_r_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> <span class="id">p</span> <span class="id">NRAEnvID</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_id_r_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_id_r_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2227')">Proof.</div>
<div class="proofscript" id="proof2227">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_id_r_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_id_r_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_id_r_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">id</span> <span class="id">arg</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">application</span> <span class="id">to</span> <span class="id">ID</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_id_r_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_id_r_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_id_r_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_id_r_step</span> <span class="id">tapp_over_id_r_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_env_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> <span class="id">NRAEnvEnv</span> <span class="id">p</span> =&gt; <span class="id">NRAEnvEnv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_env_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_env_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2228')">Proof.</div>
<div class="proofscript" id="proof2228">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_env_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_env_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_env_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">env</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">applications</span> <span class="id">of</span> <span class="id">ENV</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_env_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_env_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_env_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_env_step</span> <span class="id">tapp_over_env_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_id_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> <span class="id">NRAEnvID</span> <span class="id">p</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_id_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_id_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2229')">Proof.</div>
<div class="proofscript" id="proof2229">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_id_l_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_id_l_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_id_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">id</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">applications</span> <span class="id">of</span> <span class="id">ID</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_id_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_id_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_id_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_id_l_step</span> <span class="id">tapp_over_id_l_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_ignoreid_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> <span class="id">p1</span> <span class="id">p2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">p1</span> <span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_ignoreid_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_ignoreid_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2230')">Proof.</div>
<div class="proofscript" id="proof2230">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p1</span>); <span class="tactic">intros</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_ignoreid_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_id_eq</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">nraenv_ignores_id_nraenv_core_eq</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_ignoreid_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">ignore</span>-<span class="id">id</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">application</span> <span class="id">of</span> <span class="id">expressions</span> <span class="id">that</span> <span class="id">ignore</span> <span class="id">ID</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_ignoreid_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_ignoreid_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_ignoreid_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_ignoreid_step</span> <span class="id">tapp_over_ignoreid_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvAppEnv</span> <span class="id">NRAEnvEnv</span> <span class="id">p</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_env_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_env_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2231')">Proof.</div>
<div class="proofscript" id="proof2231">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_env_l_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">env</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">environment</span> <span class="id">applications</span> <span class="id">of</span> <span class="id">the</span> <span class="id">environment</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_env_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_env_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_env_l_step</span> <span class="id">tappenv_over_env_l_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_r_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvAppEnv</span> <span class="id">p</span> <span class="id">NRAEnvEnv</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_env_r_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_env_r_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2232')">Proof.</div>
<div class="proofscript" id="proof2232">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_env_r_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_r_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">env</span> <span class="id">arg</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">environment</span> <span class="id">applications</span> <span class="id">to</span> <span class="id">the</span> <span class="id">environment</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_env_r_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_env_r_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_r_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_env_r_step</span> <span class="id">tappenv_over_env_r_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_ignoreenv_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_env_fun</span> <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">p1</span> <span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_ignoreenv_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_ignoreenv_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2233')">Proof.</div>
<div class="proofscript" id="proof2233">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_env_fun</span> <span class="id">p1</span>); <span class="tactic">intros</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_ignoreenv_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_env_eq</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">nraenv_ignores_env_nraenv_core_eq</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_ignoreenv_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">ignore</span>-<span class="id">env</span> <span class="id">arg</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">environment</span> <span class="id">applications</span> <span class="id">that</span> <span class="id">ignore</span> <span class="id">the</span> <span class="id">environment</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_ignoreenv_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_ignoreenv_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_ignoreenv_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_ignoreenv_step</span> <span class="id">tappenv_over_ignoreenv_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_app_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvApp</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> <span class="id">p1</span> (<span class="id">NRAEnvApp</span> <span class="id">p2</span> <span class="id">p3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_app_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_app_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2234')">Proof.</div>
<div class="proofscript" id="proof2234">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_app_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_app_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_app_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">app</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Reorder</span> <span class="id">nested</span> <span class="id">applications</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_app_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_app_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_app_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_app_step</span> <span class="id">tapp_over_app_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_appenv_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p2</span> <span class="id">p3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_appenv_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_appenv_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2235')">Proof.</div>
<div class="proofscript" id="proof2235">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_appenv_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tappenv_over_appenv_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_appenv_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">app</span>-<span class="id">env</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Reorder</span> <span class="id">nested</span> <span class="id">environment</span> <span class="id">applications</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_appenv_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_appenv_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_appenv_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_appenv_step</span> <span class="id">tappenv_over_appenv_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_app_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvApp</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_env_fun</span> <span class="id">p1</span>) <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> <span class="id">p1</span>(<span class="id">NRAEnvAppEnv</span> <span class="id">p2</span> <span class="id">p3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="kwd">if</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p3</span>) <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p3</span>) (<span class="id">NRAEnvAppEnv</span> <span class="id">p2</span> <span class="id">p3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_app_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_app_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2236')">Proof.</div>
<div class="proofscript" id="proof2236">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_env_fun</span> <span class="id">p1_1</span>); <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tappenv_over_app_ie_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_env_eq</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">generalize</span> <span class="id">nraenv_ignores_env_nraenv_core_eq</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nraenv_core_of_nraenv</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H0</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">case_eq</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p2</span>); <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">tappenv_over_app_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_id_eq</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">generalize</span> <span class="id">nraenv_ignores_id_nraenv_core_eq</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nraenv_core_of_nraenv</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H1</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tappenv_over_app_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_app_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">app</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">through</span> <span class="id">application</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_app_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_app_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_app_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_app_step</span> <span class="id">tappenv_over_app_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_appenv_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p3</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p1</span>) <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> (<span class="id">NRAEnvApp</span> <span class="id">p2</span> <span class="id">p3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_appenv_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_appenv_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2237')">Proof.</div>
<div class="proofscript" id="proof2237">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p1_1</span>); <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tapp_over_appenv_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_id_eq</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">generalize</span> <span class="id">nraenv_ignores_id_nraenv_core_eq</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nraenv_core_of_nraenv</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H0</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_appenv_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">app</span>-<span class="id">env</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">application</span> <span class="id">through</span> <span class="id">environment</span> <span class="id">application</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_appenv_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_appenv_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_appenv_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_appenv_step</span> <span class="id">tapp_over_appenv_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_unop_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvUnop</span> <span class="id">u</span> <span class="id">p1</span>) <span class="id">p2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">u</span> (<span class="id">NRAEnvApp</span> <span class="id">p1</span> <span class="id">p2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_unop_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_unop_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2238')">Proof.</div>
<div class="proofscript" id="proof2238">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_unop_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_unop_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_unop_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">unop</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">application</span> <span class="id">through</span> <span class="id">unary</span> <span class="id">operations</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_unop_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_unop_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_unop_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_unop_step</span> <span class="id">tapp_over_unop_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_unop_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvUnop</span> <span class="id">u</span> <span class="id">p1</span>) <span class="id">p2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">u</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_unop_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_unop_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2239')">Proof.</div>
<div class="proofscript" id="proof2239">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_unop_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_unop_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">unop</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">through</span> <span class="id">unary</span> <span class="id">operations</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_unop_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_unop_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_unop_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_unop_step</span> <span class="id">tappenv_over_unop_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">u</span> (<span class="id">NRAEnvEither</span> <span class="id">p</span>₁ (<span class="id">NRAEnvConst</span> <span class="id">d</span>)) =&gt; <span class="id">NRAEnvEither</span> (<span class="id">NRAEnvUnop</span> <span class="id">u</span> <span class="id">p</span>₁) (<span class="id">NRAEnvUnop</span> <span class="id">u</span> (<span class="id">NRAEnvConst</span> <span class="id">d</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tunop_over_either_const_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tunop_over_either_const_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2240')">Proof.</div>
<div class="proofscript" id="proof2240">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tunop_over_either</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">unop</span>/<span class="id">either</span>/<span class="id">const</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">a</span> <span class="id">unary</span> <span class="id">operation</span> <span class="id">through</span> <span class="id">an</span> <span class="id">either</span> <span class="id">construct</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">right</span> <span class="id">branch</span> <span class="id">that</span> <span class="id">builds</span> <span class="id">a</span> <span class="id">constant</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tunop_over_either_const_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tunop_over_either_const_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tunop_over_either_const_step</span> <span class="id">tunop_over_either_const_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_app_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">u</span> (<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> <span class="id">p</span>₁ (<span class="id">NRAEnvConst</span> <span class="id">d</span>)) <span class="id">p</span>₃) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvUnop</span> <span class="id">u</span> <span class="id">p</span>₁) (<span class="id">NRAEnvUnop</span> <span class="id">u</span> (<span class="id">NRAEnvConst</span> <span class="id">d</span>))) <span class="id">p</span>₃<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tunop_over_either_const_app_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tunop_over_either_const_app_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2241')">Proof.</div>
<div class="proofscript" id="proof2241">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tunop_over_either_app</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_app_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">unop</span>/<span class="id">app</span>/<span class="id">either</span>/<span class="id">const</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">a</span> <span class="id">unary</span> <span class="id">operation</span> <span class="id">through</span> <span class="id">an</span> <span class="id">application</span> <span class="id">of</span> <span class="id">an</span> <span class="id">either</span> <span class="id">construct</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">right</span> <span class="id">branch</span> <span class="id">that</span> <span class="id">builds</span> <span class="id">a</span> <span class="id">constant</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tunop_over_either_const_app_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tunop_over_either_const_app_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_app_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tunop_over_either_const_app_step</span> <span class="id">tunop_over_either_const_app_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvMap</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> <span class="id">p1</span> (<span class="id">NRAEnvApp</span> <span class="id">p2</span> <span class="id">p0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2242')">Proof.</div>
<div class="proofscript" id="proof2242">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_map_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_map_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">map</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">applications</span> <span class="id">through</span> <span class="id">map</span> <span class="id">a</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_map_step</span> <span class="id">tapp_over_map_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_mapconcat_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvMapConcat</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMapConcat</span> <span class="id">p1</span> (<span class="id">NRAEnvApp</span> <span class="id">p2</span> <span class="id">p0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_mapconcat_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_mapconcat_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2243')">Proof.</div>
<div class="proofscript" id="proof2243">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_mapconcat_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_mapconcat_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_mapconcat_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">map</span>-<span class="id">concat</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">application</span> <span class="id">through</span> <span class="id">a</span> <span class="id">map</span>-<span class="id">concat</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_mapconcat_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_mapconcat_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_mapconcat_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_mapconcat_step</span> <span class="id">tapp_over_mapconcat_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_product_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvProduct</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvProduct</span> (<span class="id">NRAEnvApp</span> <span class="id">p1</span> <span class="id">p0</span>) (<span class="id">NRAEnvApp</span> <span class="id">p2</span> <span class="id">p0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_product_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_product_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2244')">Proof.</div>
<div class="proofscript" id="proof2244">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_product_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_product_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_product_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">product</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">application</span> <span class="id">through</span> <span class="id">a</span> <span class="id">product</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_product_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_product_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_product_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_product_step</span> <span class="id">tapp_over_product_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvMap</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NRAEnvMap</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p0</span>) (<span class="id">NRAEnvAppEnv</span> <span class="id">p2</span> <span class="id">p0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2245')">Proof.</div>
<div class="proofscript" id="proof2245">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p2</span>); <span class="tactic">intros</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_tnraenv_eq_to_tnraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tappenv_over_map_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_id_eq</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">nraenv_ignores_id_nraenv_core_eq</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">map</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">through</span> <span class="id">a</span> <span class="id">map</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_map_step</span> <span class="id">tappenv_over_map_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_select_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvSelect</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NRAEnvSelect</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p0</span>) (<span class="id">NRAEnvAppEnv</span> <span class="id">p2</span> <span class="id">p0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_select_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_select_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2246')">Proof.</div>
<div class="proofscript" id="proof2246">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p2</span>); <span class="tactic">intros</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_tnraenv_eq_to_tnraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tappenv_over_select_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_id_eq</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">nraenv_ignores_id_nraenv_core_eq</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_select_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">select</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">through</span> <span class="id">a</span> <span class="id">selection</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_select_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_select_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_select_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_select_step</span> <span class="id">tappenv_over_select_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_select_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvSelect</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p0</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvSelect</span> <span class="id">p1</span> (<span class="id">NRAEnvApp</span> <span class="id">p2</span> <span class="id">p0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_select_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_select_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2247')">Proof.</div>
<div class="proofscript" id="proof2247">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_select_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_select_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_select_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">slect</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">application</span> <span class="id">through</span> <span class="id">a</span> <span class="id">selection</span> <span class="id">body</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_select_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_select_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_select_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_select_step</span> <span class="id">tapp_over_select_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_binop_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvBinop</span> <span class="id">b</span> <span class="id">p2</span> <span class="id">p3</span>) <span class="id">p1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvBinop</span> <span class="id">b</span> (<span class="id">NRAEnvApp</span> <span class="id">p2</span> <span class="id">p1</span>) (<span class="id">NRAEnvApp</span> <span class="id">p3</span> <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_binop_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_binop_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2248')">Proof.</div>
<div class="proofscript" id="proof2248">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_binop_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tapp_over_binop_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_binop_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">binop</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">application</span> <span class="id">through</span> <span class="id">binary</span> <span class="id">operations</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_binop_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_binop_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_binop_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_binop_step</span> <span class="id">tapp_over_binop_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_singletons_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvProduct</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>) <span class="id">p1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">p2</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AColl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>) <span class="id">p1</span>) (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">p2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tproduct_singletons_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tproduct_singletons_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2249')">Proof.</div>
<div class="proofscript" id="proof2249">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tproduct_singletons_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproduct_singletons_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_singletons_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">product</span>/<span class="id">singleton</span> <span class="id">singleton</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">the</span> <span class="id">product</span> <span class="id">of</span> <span class="id">two</span> <span class="id">singRemove</span> <span class="id">loop</span> <span class="id">comprehensions</span> <span class="id">over</span> <span class="id">empty</span> <span class="id">loops</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproduct_singletons_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproduct_singletons_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_singletons_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproduct_singletons_step</span> <span class="id">tproduct_singletons_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_empty_right_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProduct</span> <span class="id">p1</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvConst</span> (<span class="id">drec</span> <span class="id">nil</span>))) =&gt; <span class="id">p1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tproduct_empty_right_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tproduct_empty_right_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2250')">Proof.</div>
<div class="proofscript" id="proof2250">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tproduct_empty_right_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproduct_empty_right_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_empty_right_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">product</span> <span class="id">singleton</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Eliminates</span> <span class="id">empty</span> <span class="id">table</span> <span class="id">on</span> <span class="id">the</span> <span class="id">right</span> <span class="id">of</span> <span class="id">a</span> <span class="id">Cartesian</span> <span class="id">product</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproduct_empty_right_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproduct_empty_right_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_empty_right_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproduct_empty_right_step</span> <span class="id">tproduct_empty_right_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_empty_left_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProduct</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvConst</span> (<span class="id">drec</span> <span class="id">nil</span>))) <span class="id">p1</span> =&gt; <span class="id">p1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tproduct_empty_left_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tproduct_empty_left_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2251')">Proof.</div>
<div class="proofscript" id="proof2251">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tproduct_empty_left_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproduct_empty_left_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_empty_left_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">product</span> <span class="id">singleton</span> <span class="id">left</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Eliminates</span> <span class="id">empty</span> <span class="id">table</span> <span class="id">on</span> <span class="id">the</span> <span class="id">left</span> <span class="id">of</span> <span class="id">a</span> <span class="id">Cartesian</span> <span class="id">product</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproduct_empty_left_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproduct_empty_left_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproduct_empty_left_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproduct_empty_left_step</span> <span class="id">tproduct_empty_left_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdouble_flatten_map_coll_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p3</span>) <span class="id">p1</span>) <span class="id">p2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> <span class="id">p1</span> <span class="id">p2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdouble_flatten_map_coll_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tdouble_flatten_map_coll_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2252')">Proof.</div>
<div class="proofscript" id="proof2252">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tdouble_flatten_map_coll_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tdouble_flatten_map_coll_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdouble_flatten_map_coll_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">map</span>/<span class="id">coll</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">flattenging</span> <span class="id">the</span> <span class="id">map</span> <span class="id">of</span> <span class="id">the</span> <span class="id">map</span> <span class="id">of</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdouble_flatten_map_coll_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdouble_flatten_map_coll_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdouble_flatten_map_coll_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdouble_flatten_map_coll_step</span> <span class="id">tdouble_flatten_map_coll_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_over_double_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvMap</span> <span class="id">q</span>₁ (<span class="id">NRAEnvSelect</span> <span class="id">q</span>₂ (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>))) <span class="id">q</span>₃))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; (<span class="id">NRAEnvMap</span> <span class="id">q</span>₁ (<span class="id">NRAEnvSelect</span> <span class="id">q</span>₂ <span class="id">q</span>₃))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflatten_over_double_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflatten_over_double_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2253')">Proof.</div>
<div class="proofscript" id="proof2253">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflatten_over_double_map_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tflatten_over_double_map_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_over_double_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">map</span>/<span class="id">select</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span> <span class="id">over</span> <span class="id">a</span> <span class="id">map</span> <span class="id">of</span> <span class="id">a</span> <span class="id">selection</span> <span class="id">applied</span> <span class="id">to</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span> <span class="id">of</span> <span class="id">the</span> <span class="id">input</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_over_double_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_over_double_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_over_double_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_over_double_map_step</span> <span class="id">tflatten_over_double_map_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_over_double_map_with_either_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> <span class="id">q</span>₁<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvSelect</span> <span class="id">q</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvApp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>) (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> []))) <span class="id">q</span>₃)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">q</span>₄)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> <span class="id">q</span>₁<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvSelect</span> <span class="id">q</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvApp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>) (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> []))) <span class="id">q</span>₃)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">q</span>₄))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflatten_over_double_map_with_either_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflatten_over_double_map_with_either_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2254')">Proof.</div>
<div class="proofscript" id="proof2254">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflatten_over_double_map_with_either_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tflatten_over_double_map_with_either_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_over_double_map_with_either_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">map</span>/<span class="id">select</span>/<span class="id">app</span>/<span class="id">either</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_over_double_map_with_either_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_over_double_map_with_either_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_over_double_map_with_either_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_over_double_map_with_either_step</span> <span class="id">tflatten_over_double_map_with_either_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_merge_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">NRAEnvEnv</span> <span class="id">p1</span>) <span class="id">p2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_env_fun</span> <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> (<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">p2</span> <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_env_merge_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_env_merge_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2255')">Proof.</div>
<div class="proofscript" id="proof2255">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">unfold</span> <span class="id">tnraenv_rewrites_to</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">b</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1_1</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_env_fun</span> <span class="id">p1_2</span>); <span class="tactic">intros</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_env_merge_l_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_env_eq</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">generalize</span> <span class="id">nraenv_ignores_env_nraenv_core_eq</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nraenv_core_of_nraenv</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H0</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_merge_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">merge</span>-<span class="id">concat</span>/<span class="id">env</span> <span class="id">left</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">of</span> <span class="id">a</span> <span class="id">merge</span>-<span class="id">concat</span> <span class="kwd">where</span> <span class="id">the</span> <span class="id">left</span> <span class="id">part</span> <span class="id">is</span> <span class="id">ENV</span> <span class="id">and</span> <span class="id">the</span> <span class="id">right</span> <span class="id">part</span> <span class="id">ignores</span> <span class="id">the</span> <span class="id">environment</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_env_merge_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_env_merge_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_env_merge_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_env_merge_l_step</span> <span class="id">tappenv_over_env_merge_l_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">ttostring_on_string_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">AToString</span> (<span class="id">NRAEnvConst</span> (<span class="id">dstring</span> <span class="id">s</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvConst</span> (<span class="id">dstring</span> <span class="id">s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">AToString</span> (<span class="id">NRAEnvUnop</span> <span class="id">AToString</span> <span class="id">p</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AToString</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">AToString</span> (<span class="id">NRAEnvBinop</span> <span class="id">ASConcat</span> <span class="id">p1</span> <span class="id">p2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">ASConcat</span> <span class="id">p1</span> <span class="id">p2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">ttostring_on_string_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">ttostring_on_string_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2256')">Proof.</div>
<div class="proofscript" id="proof2256">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">ttostring_dstring_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">ttostring_sconcat_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">ttostring_tostring_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">ttostring_on_string_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">to</span>-<span class="id">string</span>/<span class="id">string</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Remove</span> <span class="id">ToString</span> <span class="id">operations</span> <span class="kwd">where</span> <span class="id">the</span> <span class="id">argument</span> <span class="id">is</span> <span class="id">statically</span> <span class="id">known</span> <span class="id">to</span> <span class="id">already</span> <span class="id">be</span> <span class="id">a</span> <span class="id">string</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">ttostring_on_string_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ttostring_on_string_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">ttostring_on_string_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">ttostring_on_string_step</span> <span class="id">ttostring_on_string_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_full_over_select_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">p0</span> (<span class="id">NRAEnvSelect</span> <span class="id">p1</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>)) =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">p0</span> (<span class="id">NRAEnvSelect</span> <span class="id">p1</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p2</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvApp</span> <span class="id">p0</span> <span class="id">p2</span>) (<span class="id">NRAEnvSelect</span> (<span class="id">NRAEnvApp</span> <span class="id">p1</span> <span class="id">p2</span>) (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_full_over_select_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmap_full_over_select_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2257')">Proof.</div>
<div class="proofscript" id="proof2257">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> 3 (<span class="id">match_destr</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p2_2</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmap_full_over_select_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_full_over_select_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>/<span class="id">select</span>/<span class="id">coll</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_full_over_select_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_full_over_select_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_full_over_select_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_full_over_select_step</span> <span class="id">tmap_full_over_select_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcompose_selects_in_mapenv_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NRAEnvAppEnv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMapEnv</span> (<span class="id">NRAEnvMap</span> <span class="id">NRAEnvEnv</span> (<span class="id">NRAEnvSelect</span> <span class="id">p1</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>)))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> <span class="id">NRAEnvEnv</span> (<span class="id">NRAEnvSelect</span> <span class="id">p2</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>)))) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> <span class="id">NRAEnvEnv</span> (<span class="id">NRAEnvSelect</span> <span class="id">p1</span> (<span class="id">NRAEnvSelect</span> <span class="id">p2</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tcompose_selects_in_mapenv_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tcompose_selects_in_mapenv_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2258')">Proof.</div>
<div class="proofscript" id="proof2258">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tcompose_selects_in_mapenv_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcompose_selects_in_mapenv_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">flatten</span>/<span class="id">map</span>-<span class="id">env</span>/<span class="id">map</span>/<span class="id">select</span>/<span class="id">coll</span>/<span class="id">id</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tcompose_selects_in_mapenv_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcompose_selects_in_mapenv_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcompose_selects_in_mapenv_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tcompose_selects_in_mapenv_step</span> <span class="id">tcompose_selects_in_mapenv_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_to_env_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvMapEnv</span> <span class="id">NRAEnvEnv</span>) <span class="id">p1</span>) =&gt; <span class="id">NRAEnvEnv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmapenv_to_env_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmapenv_to_env_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2259')">Proof.</div>
<div class="proofscript" id="proof2259">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmapenv_to_env_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_to_env_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">map</span>-<span class="id">env</span>/<span class="id">env</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">applications</span> <span class="kwd">with</span> <span class="id">body</span> <span class="id">that</span> <span class="id">map</span>-<span class="id">environments</span> <span class="id">over</span> <span class="id">the</span> <span class="id">environment</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmapenv_to_env_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmapenv_to_env_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_to_env_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmapenv_to_env_step</span> <span class="id">tmapenv_to_env_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tenv_appenv_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> <span class="id">NRAEnvEnv</span> <span class="id">p1</span> =&gt; <span class="id">p1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tenv_appenv_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tenv_appenv_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2260')">Proof.</div>
<div class="proofscript" id="proof2260">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_env_l_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tenv_appenv_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">env</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">environment</span> <span class="id">applications</span> <span class="id">of</span> <span class="id">the</span> <span class="id">environment</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tenv_appenv_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tenv_appenv_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tenv_appenv_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tenv_appenv_step</span> <span class="id">tenv_appenv_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_mapenv_coll_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMapEnv</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p1</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMapEnv</span> <span class="id">p1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span>  <span class="id">tflatten_mapenv_coll_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflatten_mapenv_coll_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2261')">Proof.</div>
<div class="proofscript" id="proof2261">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflatten_mapenv_coll_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_mapenv_coll_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">map</span>-<span class="id">env</span>/<span class="id">coll</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">flattening</span> <span class="id">a</span> <span class="id">map</span> <span class="id">environment</span> <span class="id">of</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_mapenv_coll_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_mapenv_coll_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_mapenv_coll_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_mapenv_coll_step</span> <span class="id">tflatten_mapenv_coll_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_nil_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span>  <span class="id">tflatten_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflatten_nil_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2262')">Proof.</div>
<div class="proofscript" id="proof2262">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tenvflatten_nil_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Remove</span> <span class="id">flatten</span> <span class="id">over</span> <span class="id">empty</span> <span class="id">records</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_nil_step</span> <span class="id">tflatten_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_through_appenv_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> <span class="id">p1</span>) <span class="id">p2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflatten_through_appenv_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflatten_through_appenv_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2263')">Proof.</div>
<div class="proofscript" id="proof2263">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflatten_through_appenv_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_through_appenv_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">app</span>-<span class="id">env</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">flatten</span> <span class="id">operations</span> <span class="id">through</span> <span class="id">environment</span> <span class="id">applications</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_through_appenv_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_through_appenv_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_through_appenv_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_through_appenv_step</span> <span class="id">tflatten_through_appenv_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_flatten_mapenv_to_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMapEnv</span> <span class="id">p2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">NRAEnvEnv</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">NRAEnvID</span>))) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvApp</span> <span class="id">p2</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">s</span>) <span class="id">NRAEnvEnv</span>)) <span class="id">NRAEnvID</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">NRAEnvEnv</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">NRAEnvID</span>))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_flatten_mapenv_to_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_flatten_mapenv_to_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2264')">Proof.</div>
<div class="proofscript" id="proof2264">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_flatten_mapenv_to_map_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_flatten_mapenv_to_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/(<span class="id">flatten</span>/<span class="id">map</span>-<span class="id">env</span>)(<span class="id">merge</span>-<span class="id">concat</span>/(<span class="id">env</span>)(<span class="id">rec</span>/<span class="id">id</span>))" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">of</span> <span class="id">a</span> <span class="id">flattened</span> <span class="id">environment</span> <span class="id">map</span> <span class="id">to</span> <span class="id">a</span> <span class="id">merge</span>-<span class="id">concat</span> <span class="id">of</span> <span class="id">the</span> <span class="id">environment</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">record</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_flatten_mapenv_to_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_flatten_mapenv_to_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_flatten_mapenv_to_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_flatten_mapenv_to_map_step</span> <span class="id">tappenv_flatten_mapenv_to_map_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_either_nil_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> <span class="id">p</span>₁ (<span class="id">NRAEnvEither</span> <span class="id">p</span>₂ (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvSelect</span> <span class="id">p</span>₁ (<span class="id">p</span>₂)) (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tselect_over_either_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tselect_over_either_nil_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2265')">Proof.</div>
<div class="proofscript" id="proof2265">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_tnraenv_eq_to_tnraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tselect_over_either</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tselect_over_nil</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tselect_over_either_nil_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_either_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">select</span>/<span class="id">either</span>/<span class="id">nil</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">selection</span> <span class="id">through</span> <span class="id">an</span> <span class="id">either</span> <span class="id">whose</span> <span class="id">right</span> <span class="id">side</span> <span class="id">returns</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tselect_over_either_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tselect_over_either_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_either_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tselect_over_either_nil_step</span> <span class="id">tselect_over_either_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_either_nil_app_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> <span class="id">p</span>₁ (<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> <span class="id">p</span>₂ (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₄) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvSelect</span> <span class="id">p</span>₁ <span class="id">p</span>₂) ((<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))) <span class="id">p</span>₄<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tselect_over_either_nil_app_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tselect_over_either_nil_app_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2266')">Proof.</div>
<div class="proofscript" id="proof2266">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_tnraenv_eq_to_tnraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tselect_over_app_either</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tselect_over_nil</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tselect_over_either_nil_app_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_either_nil_app_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">select</span>/<span class="id">app</span>/<span class="id">either</span>/<span class="id">nil</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">selection</span> <span class="id">through</span> <span class="id">an</span> <span class="id">application</span> <span class="id">of</span> <span class="id">an</span> <span class="id">either</span> <span class="id">whose</span> <span class="id">right</span> <span class="id">side</span> <span class="id">returns</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tselect_over_either_nil_app_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tselect_over_either_nil_app_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_either_nil_app_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tselect_over_either_nil_app_step</span> <span class="id">tselect_over_either_nil_app_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_either_nil_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">p</span>₁ (<span class="id">NRAEnvEither</span> <span class="id">p</span>₂ (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₁ <span class="id">p</span>₂) ((<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_over_either_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmap_over_either_nil_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2267')">Proof.</div>
<div class="proofscript" id="proof2267">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_tnraenv_eq_to_tnraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tmap_over_either</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tmap_over_nil</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmap_over_either_nil_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_either_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>/<span class="id">either</span>/<span class="id">nil</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">map</span> <span class="id">through</span> <span class="id">an</span> <span class="id">either</span> <span class="id">whose</span> <span class="id">right</span> <span class="id">side</span> <span class="id">returns</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_over_either_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_over_either_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_either_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_over_either_nil_step</span> <span class="id">tmap_over_either_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_either_nil_app_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">p</span>₁ (<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> <span class="id">p</span>₂ (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₄) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₁ <span class="id">p</span>₂) (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₄<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_over_either_nil_app_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmap_over_either_nil_app_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2268')">Proof.</div>
<div class="proofscript" id="proof2268">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_tnraenv_eq_to_tnraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tmap_over_either_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tmap_over_nil</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmap_over_either_nil_app_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_either_nil_app_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>/<span class="id">app</span>/<span class="id">either</span>/<span class="id">nil</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">map</span> <span class="id">through</span> <span class="id">an</span> <span class="id">application</span> <span class="id">of</span> <span class="id">an</span> <span class="id">either</span> <span class="id">whose</span> <span class="id">right</span> <span class="id">side</span> <span class="id">returns</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_over_either_nil_app_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_over_either_nil_app_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_either_nil_app_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_over_either_nil_app_step</span> <span class="id">tmap_over_either_nil_app_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_either_nil_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvEither</span> <span class="id">p</span>₂ (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₃ =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">nraenv_ignores_id_fun</span> <span class="id">p</span>₃ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NRAEnvEither</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p</span>₂ <span class="id">p</span>₃) ((<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_either_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_either_nil_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2269')">Proof.</div>
<div class="proofscript" id="proof2269">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1_2</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">d</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">l</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_case</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">ig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_id_eq</span> <span class="kwd">in</span> <span class="id">ig</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_tnraenv_eq_to_tnraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">autorewrite</span> <span class="kwd">with</span> <span class="id">tnraenv_core_optim</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">nraenv_ignores_id_nraenv_core_eq</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tappenv_over_either_nil_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_either_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">either</span>/<span class="id">nil</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Pushes</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">through</span> <span class="id">an</span> <span class="id">either</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">right</span> <span class="id">branch</span> <span class="id">that</span> <span class="id">builds</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_either_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_either_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_either_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_either_nil_step</span> <span class="id">tappenv_over_either_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_flatten_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> <span class="id">p</span>₁ (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> <span class="id">p</span>₂) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvSelect</span> <span class="id">p</span>₁ <span class="id">NRAEnvID</span>) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tselect_over_flatten_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tselect_over_flatten_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2270')">Proof.</div>
<div class="proofscript" id="proof2270">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tselect_over_flatten</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tselect_over_flatten_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_flatten_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">select</span>/<span class="id">flatten</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Pushes</span> <span class="id">selection</span> <span class="id">through</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">operation</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tselect_over_flatten_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tselect_over_flatten_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tselect_over_flatten_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tselect_over_flatten_step</span> <span class="id">tselect_over_flatten_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_flatten_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">p</span>₁ (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> <span class="id">p</span>₂) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₁ <span class="id">NRAEnvID</span>) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_over_flatten_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmap_over_flatten_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2271')">Proof.</div>
<div class="proofscript" id="proof2271">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmap_over_flatten</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmap_over_flatten_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_flatten_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>/<span class="id">flatten</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Pushes</span> <span class="id">map</span> <span class="id">through</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">operation</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_over_flatten_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_over_flatten_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_flatten_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_over_flatten_step</span> <span class="id">tmap_over_flatten_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_flatten_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">p</span>₁ (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₂ <span class="id">p</span>₃)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₁ <span class="id">p</span>₂) <span class="id">p</span>₃)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_over_flatten_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmap_over_flatten_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2272')">Proof.</div>
<div class="proofscript" id="proof2272">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmap_over_flatten_map</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmap_over_flatten_map_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_flatten_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>/<span class="id">flatten</span>/<span class="id">map</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Pushes</span> <span class="id">map</span> <span class="id">through</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_over_flatten_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_over_flatten_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_over_flatten_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_over_flatten_map_step</span> <span class="id">tmap_over_flatten_map_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_over_rec_eq_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>₁) <span class="id">p</span>₁) (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>₂) <span class="id">p</span>₂))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> <span class="id">string_dec</span> <span class="id">s</span>₁ <span class="id">s</span>₂ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>₂) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_over_rec_eq_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tconcat_over_rec_eq_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2273')">Proof.</div>
<div class="proofscript" id="proof2273">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">lift_tnraenv_eq_to_tnraenv_core_eq</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tconcat_over_rec_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tconcat_over_rec_eq_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_over_rec_eq_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">concat</span>/(<span class="id">rec</span>)(<span class="id">rec</span>)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">a</span> <span class="id">concatentation</span> <span class="id">of</span> <span class="id">two</span> <span class="id">record</span> <span class="id">constructors</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tconcat_over_rec_eq_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tconcat_over_rec_eq_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tconcat_over_rec_eq_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tconcat_over_rec_eq_step</span> <span class="id">tconcat_over_rec_eq_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_const_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvConst</span> <span class="id">d</span>) <span class="id">p1</span>) =&gt; (<span class="id">NRAEnvConst</span> <span class="id">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tapp_over_const_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tapp_over_const_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2274')">Proof.</div>
<div class="proofscript" id="proof2274">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tapp_over_const_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_const_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>/<span class="id">const</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">application</span> <span class="id">of</span> <span class="id">a</span> <span class="id">constant</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tapp_over_const_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tapp_over_const_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tapp_over_const_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tapp_over_const_step</span> <span class="id">tapp_over_const_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_const_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvConst</span> <span class="id">d</span>) <span class="id">p1</span>) =&gt; (<span class="id">NRAEnvConst</span> <span class="id">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_const_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_const_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2275')">Proof.</div>
<div class="proofscript" id="proof2275">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_const_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_const_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">const</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">of</span> <span class="id">a</span> <span class="id">constant</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_const_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_const_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_const_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_const_step</span> <span class="id">tappenv_over_const_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env1_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvMap</span> <span class="id">NRAEnvEnv</span> (<span class="id">NRAEnvSelect</span> <span class="id">q</span>₁ (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>))) <span class="id">q</span>₂ =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">q</span>₂ <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvID</span> =&gt; (<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvSelect</span> <span class="id">q</span>₁ (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>)) <span class="id">NRAEnvID</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_env_fun</span> <span class="id">q</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NRAEnvMap</span> <span class="id">q</span>₂ (<span class="id">NRAEnvSelect</span> <span class="id">q</span>₁ (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflip_env1_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflip_env1_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2276')">Proof.</div>
<div class="proofscript" id="proof2276">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1_1</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1_2</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1_2_2</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">u</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1_2_2</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p2</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="tactic">apply</span> <span class="id">tflip_env1_arrow</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_env_fun</span> <span class="id">p1_2_1</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">intros</span>; <span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_env_eq</span> <span class="kwd">in</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflip_env4_arrow</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">generalize</span> <span class="id">nraenv_ignores_env_nraenv_core_eq</span>; <span class="tactic">intros</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nraenv_core_of_nraenv</span> <span class="kwd">in</span> *;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H0</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env1_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">env</span> <span class="id">flip1</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflip_env1_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflip_env1_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env1_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflip_env1_step</span> <span class="id">tflip_env1_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env2_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvSelect</span> <span class="id">p</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>)) <span class="id">NRAEnvID</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvSelect</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p</span> <span class="id">NRAEnvID</span>) (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflip_env2_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflip_env2_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2277')">Proof.</div>
<div class="proofscript" id="proof2277">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflip_env2_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env2_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">select</span>/<span class="id">coll</span>/<span class="id">id</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Pushes</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">through</span> <span class="id">selection</span> <span class="id">of</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span> <span class="id">over</span> <span class="id">the</span> <span class="id">input</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflip_env2_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflip_env2_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env2_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflip_env2_step</span> <span class="id">tflip_env2_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_over_singleton_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvMapEnv</span> <span class="id">p1</span>) (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p2</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmapenv_over_singleton_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmapenv_over_singleton_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2278')">Proof.</div>
<div class="proofscript" id="proof2278">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmapenv_over_singleton_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_over_singleton_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/(<span class="id">map</span>-<span class="id">env</span>)(<span class="id">coll</span>)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">the</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span> <span class="id">environment</span> <span class="id">over</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmapenv_over_singleton_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmapenv_over_singleton_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_over_singleton_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmapenv_over_singleton_step</span> <span class="id">tmapenv_over_singleton_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_binop_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvBinop</span> <span class="id">b</span> <span class="id">p1</span> <span class="id">p2</span>) <span class="id">p0</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">b</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">p0</span>) (<span class="id">NRAEnvAppEnv</span> <span class="id">p2</span> <span class="id">p0</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_over_binop_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_over_binop_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2279')">Proof.</div>
<div class="proofscript" id="proof2279">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_over_binop</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_binop_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">binop</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Pushes</span> <span class="id">an</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">through</span> <span class="id">a</span> <span class="id">binary</span> <span class="id">operation</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_over_binop_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_over_binop_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_over_binop_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_over_binop_step</span> <span class="id">tappenv_over_binop_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env6_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> (<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">NRAEnvEnv</span> <span class="id">NRAEnvID</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvSelect</span> <span class="id">p1</span> (<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">NRAEnvEnv</span> <span class="id">p2</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">NRAEnvID</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvSelect</span> <span class="id">p1</span> (<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">NRAEnvEnv</span> <span class="id">p2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflip_env6_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tflip_env6_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2280')">Proof.</div>
<div class="proofscript" id="proof2280">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflip_env6_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env6_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">env</span> <span class="id">flip6</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflip_env6_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflip_env6_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflip_env6_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflip_env6_step</span> <span class="id">tflip_env6_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_to_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvMapEnv</span> <span class="id">p1</span>) <span class="id">p2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> (<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvAppEnv</span> <span class="id">p1</span> <span class="id">NRAEnvID</span>) <span class="id">p2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmapenv_to_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmapenv_to_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2281')">Proof.</div>
<div class="proofscript" id="proof2281">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p1</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case_eq</span> (<span class="id">nraenv_ignores_id_fun</span> <span class="id">p1</span>); <span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmapenv_to_map_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">nraenv_ignores_id_eq</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">generalize</span> <span class="id">nraenv_ignores_id_nraenv_core_eq</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nraenv_core_of_nraenv</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H0</span>; <span class="tactic">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_to_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/<span class="id">map</span>-<span class="id">env</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">environment</span> <span class="id">application</span> <span class="id">through</span> <span class="id">map</span> <span class="id">environment</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmapenv_to_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmapenv_to_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapenv_to_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmapenv_to_map_step</span> <span class="id">tmapenv_to_map_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_concat_to_concat_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>) <span class="id">p1</span>) (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">p2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">s1</span> == <span class="id">s2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">NRAEnvUnop</span> <span class="id">AColl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>) <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">p2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmerge_concat_to_concat_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmerge_concat_to_concat_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2282')">Proof.</div>
<div class="proofscript" id="proof2282">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmerge_concat_to_concat_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_concat_to_concat_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">merge</span>-<span class="id">concat</span>/(<span class="id">rec</span>)(<span class="id">rec</span>)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">a</span> <span class="id">merge</span>-<span class="id">concat</span> <span class="id">of</span> <span class="id">two</span> <span class="id">record</span> <span class="id">constructors</span> <span class="id">into</span> <span class="id">a</span> <span class="id">simpler</span> <span class="id">concatentation</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmerge_concat_to_concat_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmerge_concat_to_concat_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_concat_to_concat_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmerge_concat_to_concat_step</span> <span class="id">tmerge_concat_to_concat_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_with_concat_to_concat_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>) <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>') <span class="id">p1</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">p2</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">s1</span> == <span class="id">s2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">s1</span> == <span class="id">s1</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">p1</span> == <span class="id">p1</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>) <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">p2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmerge_with_concat_to_concat_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmerge_with_concat_to_concat_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2283')">Proof.</div>
<div class="proofscript" id="proof2283">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmerge_with_concat_to_concat_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_with_concat_to_concat_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">merge</span>-<span class="id">concat</span>/(<span class="id">rec</span>)(<span class="id">concat</span>(<span class="id">rec</span>)(<span class="id">rec</span>))" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">a</span> <span class="id">merge</span> <span class="id">concatenation</span> <span class="id">of</span> <span class="id">a</span> <span class="id">record</span> <span class="id">constructor</span> <span class="id">and</span> <span class="id">a</span> <span class="id">concatenation</span> <span class="id">of</span> <span class="id">record</span> <span class="id">constructors</span> <span class="id">into</span> <span class="id">a</span> <span class="id">simpler</span> <span class="id">concatenation</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmerge_with_concat_to_concat_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmerge_with_concat_to_concat_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_with_concat_to_concat_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmerge_with_concat_to_concat_step</span> <span class="id">tmerge_with_concat_to_concat_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_rec_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">s2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s1</span>) <span class="id">p1</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">s1</span> == <span class="id">s2</span>) <span class="kwd">then</span> <span class="id">p1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdot_over_rec_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tdot_over_rec_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2284')">Proof.</div>
<div class="proofscript" id="proof2284">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tdot_over_rec_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_rec_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">dot</span>/<span class="id">rec</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">field</span> <span class="id">lookup</span> <span class="id">of</span> <span class="id">a</span> <span class="id">record</span> <span class="id">construction</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdot_over_rec_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdot_over_rec_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_over_rec_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdot_over_rec_step</span> <span class="id">tdot_over_rec_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnested_map_over_singletons_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvSelect</span> <span class="id">q</span>₁ (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">q</span>₂)) <span class="id">q</span>₃) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvSelect</span> <span class="id">q</span>₁ (<span class="id">NRAEnvMap</span> <span class="id">q</span>₂ <span class="id">q</span>₃)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnested_map_over_singletons_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tnested_map_over_singletons_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2285')">Proof.</div>
<div class="proofscript" id="proof2285">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnested_map_over_singletons_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnested_map_over_singletons_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">select</span>/<span class="id">coll</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span> <span class="id">of</span> <span class="id">a</span> <span class="id">select</span> <span class="id">over</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tnested_map_over_singletons_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnested_map_over_singletons_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnested_map_over_singletons_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tnested_map_over_singletons_step</span> <span class="id">tnested_map_over_singletons_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_mapenv_to_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvMapEnv</span> <span class="id">q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">NRAEnvEnv</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">a</span>) <span class="id">NRAEnvID</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvAppEnv</span> (<span class="id">NRAEnvApp</span> <span class="id">q</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ADot</span> <span class="id">a</span>) <span class="id">NRAEnvEnv</span>)) <span class="id">NRAEnvID</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AMergeConcat</span> <span class="id">NRAEnvEnv</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">a</span>) <span class="id">NRAEnvID</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tappenv_mapenv_to_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tappenv_mapenv_to_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2286')">Proof.</div>
<div class="proofscript" id="proof2286">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tappenv_mapenv_to_map_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_mapenv_to_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">app</span>-<span class="id">env</span>/(<span class="id">map</span>-<span class="id">env</span>)(<span class="id">merge</span>-<span class="id">concat</span>(<span class="id">env</span>)(<span class="id">rec</span>/<span class="id">id</span>))" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tappenv_mapenv_to_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tappenv_mapenv_to_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tappenv_mapenv_to_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tappenv_mapenv_to_map_step</span> <span class="id">tappenv_mapenv_to_map_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_nil_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">nil</span>) <span class="id">p</span>₁<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NRAEnvConst</span> (<span class="id">drec</span> <span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">trproject_nil_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2287')">Proof.</div>
<div class="proofscript" id="proof2287">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">trproject_nil</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">trproject_nil_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">rproject</span>/<span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Remove</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">of</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">record</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">trproject_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">trproject_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">trproject_nil_step</span> <span class="id">trproject_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_const_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvConst</span> (<span class="id">drec</span> <span class="id">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NRAEnvConst</span> (<span class="id">drec</span> (<span class="id">rproject</span> <span class="id">l</span> <span class="id">sl</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_const_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">trproject_over_const_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2288')">Proof.</div>
<div class="proofscript" id="proof2288">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">trproject_over_const</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">trproject_over_const_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_const_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">rproject</span>/<span class="id">const</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">of</span> <span class="id">a</span> <span class="id">constant</span> <span class="id">record</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">trproject_over_const_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">trproject_over_const_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_const_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">trproject_over_const_step</span> <span class="id">trproject_over_const_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_rec_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> <span class="id">in_dec</span> <span class="id">string_dec</span> <span class="id">s</span> <span class="id">sl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₁<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">NRAEnvConst</span> (<span class="id">drec</span> <span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_rec_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">trproject_over_rec_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2289')">Proof.</div>
<div class="proofscript" id="proof2289">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">trproject_over_rec_in</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">trproject_over_rec_nin</span>; <span class="tactic">trivial</span>. <br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">trproject_over_rec_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_rec_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">rproject</span>/<span class="id">rec</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">of</span> <span class="id">a</span> <span class="id">record</span> <span class="id">construction</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">trproject_over_rec_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">trproject_over_rec_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_rec_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">trproject_over_rec_step</span> <span class="id">trproject_over_rec_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_concat_r_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span>₁ (<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₂))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> <span class="id">in_dec</span> <span class="id">string_dec</span> <span class="id">s</span> <span class="id">sl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NRAEnvBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> (<span class="id">remove</span> <span class="id">string_dec</span> <span class="id">s</span> <span class="id">sl</span>)) <span class="id">p</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">p</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_concat_r_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">trproject_over_concat_r_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2290')">Proof.</div>
<div class="proofscript" id="proof2290">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">trproject_over_concat_rec_r_in</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">trproject_over_concat_rec_r_nin</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">trproject_over_concat_r_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_concat_r_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">rproject</span>/<span class="id">concat</span>/<span class="id">rec</span> <span class="id">right</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">of</span> <span class="id">a</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">record</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">trproject_over_concat_r_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">trproject_over_concat_r_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_concat_r_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">trproject_over_concat_r_step</span> <span class="id">trproject_over_concat_r_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_concat_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₁) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> <span class="id">in_dec</span> <span class="id">string_dec</span> <span class="id">s</span> <span class="id">sl</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_concat_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">trproject_over_concat_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2291')">Proof.</div>
<div class="proofscript" id="proof2291">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">trproject_over_concat_rec_l_nin</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">trproject_over_concat_l_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_concat_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">rproject</span>/<span class="id">concat</span>/<span class="id">rec</span> <span class="id">left</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">of</span> <span class="id">a</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">record</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">trproject_over_concat_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">trproject_over_concat_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_concat_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">trproject_over_concat_l_step</span> <span class="id">trproject_over_concat_l_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_rproject_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl2</span>) <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> (<span class="id">set_inter</span> <span class="id">string_dec</span> <span class="id">sl2</span> <span class="id">sl1</span>)) <span class="id">p1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_rproject_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">trproject_over_rproject_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2292')">Proof.</div>
<div class="proofscript" id="proof2292">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">trproject_over_rproject</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">trproject_over_rproject_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_rproject_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">rproject</span>/<span class="id">rproject</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Fuse</span> <span class="id">nested</span> <span class="id">record</span> <span class="id">projections</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">trproject_over_rproject_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">trproject_over_rproject_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_rproject_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">trproject_over_rproject_step</span> <span class="id">trproject_over_rproject_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_either_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvEither</span> <span class="id">p</span>₁ <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NRAEnvEither</span> (<span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">p</span>₁) (<span class="id">NRAEnvUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_either_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">trproject_over_either_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2293')">Proof.</div>
<div class="proofscript" id="proof2293">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">trproject_over_either</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">trproject_over_either_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_either_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">rproject</span>/<span class="id">either</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">through</span> <span class="id">an</span> <span class="id">either</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">trproject_over_either_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">trproject_over_either_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">trproject_over_either_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">trproject_over_either_step</span> <span class="id">trproject_over_either_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">ACount</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₁ <span class="id">p</span>₂) =&gt; <span class="id">NRAEnvUnop</span> <span class="id">ACount</span> <span class="id">p</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tcount_over_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2294')">Proof.</div>
<div class="proofscript" id="proof2294">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tcount_over_map</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tcount_over_map_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">count</span>/<span class="id">map</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">count</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span> (<span class="tactic">by</span> <span class="id">removing</span> <span class="id">the</span> <span class="id">map</span>)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tcount_over_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcount_over_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tcount_over_map_step</span> <span class="id">tcount_over_map_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">ACount</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₁ <span class="id">p</span>₂) <span class="id">p</span>₃)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">ACount</span> (<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₂ <span class="id">p</span>₃))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tcount_over_flat_map_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2295')">Proof.</div>
<div class="proofscript" id="proof2295">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tcount_over_flat_map_map</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tcount_over_flat_map_map_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">count</span>/<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">map</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">the</span> <span class="id">count</span> <span class="id">of</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span>'<span class="id">ed</span> <span class="id">map</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tcount_over_flat_map_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcount_over_flat_map_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tcount_over_flat_map_map_step</span> <span class="id">tcount_over_flat_map_map_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">ACount</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₁ <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span>₃)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">ACount</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvEither</span> <span class="id">p</span>₂<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₃))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tcount_over_flat_map_either_nil_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2296')">Proof.</div>
<div class="proofscript" id="proof2296">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tcount_over_flat_map_either_nil_map</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tcount_over_flat_map_either_nil_map_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">count</span>/<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">either</span>(<span class="id">map</span>)(<span class="id">nil</span>)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">count</span> <span class="id">of</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span> <span class="id">over</span> <span class="id">an</span> <span class="id">either</span> <span class="kwd">where</span> <span class="id">the</span> <span class="id">right</span> <span class="id">part</span> <span class="id">builds</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tcount_over_flat_map_either_nil_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcount_over_flat_map_either_nil_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tcount_over_flat_map_either_nil_map_step</span> <span class="id">tcount_over_flat_map_either_nil_map_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_app_map_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">ACount</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvMap</span> <span class="id">p</span>₁ <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₄)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span>₃)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">ACount</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvApp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvEither</span> <span class="id">p</span>₂ (<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span>₄)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span>₃))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_app_map_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tcount_over_flat_map_either_nil_app_map_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2297')">Proof.</div>
<div class="proofscript" id="proof2297">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tcount_over_flat_map_either_nil_app_map</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tcount_over_flat_map_either_nil_app_map_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_app_map_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">count</span>/<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">app</span>/<span class="id">either</span>(<span class="id">map</span>)(<span class="id">nil</span>)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">count</span> <span class="id">of</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span> <span class="id">over</span> <span class="id">an</span> <span class="id">application</span> <span class="id">of</span> <span class="id">an</span> <span class="id">either</span> <span class="kwd">where</span> <span class="id">the</span> <span class="id">right</span> <span class="id">part</span> <span class="id">builds</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tcount_over_flat_map_either_nil_app_map_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcount_over_flat_map_either_nil_app_map_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_app_map_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tcount_over_flat_map_either_nil_app_map_step</span> <span class="id">tcount_over_flat_map_either_nil_app_map_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">ACount</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> <span class="id">p</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₃) <span class="id">p</span>₂)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvUnop</span> <span class="id">ACount</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvMap</span> (<span class="id">NRAEnvApp</span> (<span class="id">NRAEnvEither</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvConst</span> <span class="id">dunit</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NRAEnvConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">p</span>₃) <span class="id">p</span>₂))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tcount_over_flat_map_either_nil_app_singleton_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2298')">Proof.</div>
<div class="proofscript" id="proof2298">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tcount_over_flat_map_either_nil_app_singleton_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">count</span>/<span class="id">flatten</span>/<span class="id">map</span>/<span class="id">app</span>/<span class="id">either</span>(<span class="id">coll</span>)(<span class="id">nil</span>)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">count</span> <span class="id">of</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">map</span> <span class="id">over</span> <span class="id">an</span> <span class="id">application</span> <span class="id">of</span> <span class="id">an</span> <span class="id">either</span> <span class="kwd">where</span> <span class="id">the</span> <span class="id">left</span> <span class="id">side</span> <span class="id">builds</span> <span class="id">a</span> <span class="id">bag</span> <span class="id">and</span> <span class="id">the</span> <span class="id">right</span> <span class="id">part</span> <span class="id">builds</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tcount_over_flat_map_either_nil_app_singleton_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcount_over_flat_map_either_nil_app_singleton_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton_step</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapconcat_over_singleton_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>: <span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id">NRAEnvMapConcat</span> <span class="id">p</span> (<span class="id">NRAEnvUnop</span> <span class="id">AColl</span> (<span class="id">NRAEnvConst</span> (<span class="id">drec</span> []))) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NRAEnvApp</span> <span class="id">p</span> (<span class="id">NRAEnvConst</span> (<span class="id">drec</span> []))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmapconcat_over_singleton_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tmapconcat_over_singleton_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2299')">Proof.</div>
<div class="proofscript" id="proof2299">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmapconcat_over_singleton</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tmerge_empty_record_r_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapconcat_over_singleton_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">map</span>-<span class="id">concat</span>/<span class="id">coll</span> <span class="id">right</span>/<span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplufy</span> <span class="id">map</span> <span class="id">concat</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">bag</span> <span class="kwd">with</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">record</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmapconcat_over_singleton_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmapconcat_over_singleton_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmapconcat_over_singleton_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmapconcat_over_singleton_step</span> <span class="id">tmapconcat_over_singleton_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdup_elim_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">dup_elim_fun</span> <span class="id">p</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdup_elim_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">tdup_elim_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2300')">Proof.</div>
<div class="proofscript" id="proof2300">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">u</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_case</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">intros</span> <span class="id">nd</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tdup_elim</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">nodupA_checker_correct</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tdup_elim_fun_correctness</span> : <span class="id">optim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdup_elim_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">distinct</span>/<span class="id">nodup</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Removes</span> <span class="id">applications</span> <span class="id">of</span> <span class="id">the</span> <span class="id">distinct</span> <span class="id">operator</span> <span class="id">to</span> <span class="id">bags</span> <span class="id">statically</span> <span class="id">known</span> <span class="id">to</span> <span class="id">already</span> <span class="id">be</span> <span class="id">duplicate</span> <span class="id">free</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdup_elim_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdup_elim_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdup_elim_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdup_elim_step</span> <span class="id">tdup_elim_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnraenv_optim_list</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} : <span class="id">list</span> (@<span class="id">OptimizerStep</span> <span class="id">nraenv</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= [<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tand_comm_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_and_comm_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_and_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">select_union_distr_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_from_duplicate_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_from_duplicate_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tconcat_empty_record_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tconcat_empty_record_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_over_concat_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_over_concat_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_empty_record_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_empty_record_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_into_id_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_map_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_flatten_map_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_map_compose_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_id_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_env_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_id_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_ignoreid_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_env_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_env_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_ignoreenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_unop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_unop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tunop_over_either_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tunop_over_either_const_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_mapconcat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_product_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_binop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproduct_singletons_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproduct_empty_right_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproduct_empty_left_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdouble_flatten_map_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_over_double_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_over_double_map_with_either_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_env_merge_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">ttostring_on_string_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_full_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcompose_selects_in_mapenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmapenv_to_env_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tenv_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_mapenv_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_through_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_flatten_mapenv_to_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_over_either_nil_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_over_either_nil_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_over_flatten_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_over_flatten_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_over_flatten_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tconcat_over_rec_eq_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflip_env1_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflip_env2_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmapenv_over_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_binop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflip_env6_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmapenv_to_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_concat_to_concat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_with_concat_to_concat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_over_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tnested_map_over_singletons_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_mapenv_to_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_concat_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_concat_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_rproject_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_either_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_map_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_map_either_nil_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_map_either_nil_app_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_map_either_nil_app_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmapconcat_over_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdup_elim_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;].<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnraenv_optim_model_list</span> {<span class="id">model</span>:<span class="id">basic_model</span>} : <span class="id">list</span> (<span class="id">OptimizerStepModel</span> <span class="id">tnraenv_rewrites_to</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= [<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tand_comm_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_and_comm_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_and_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">select_union_distr_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_from_duplicate_r_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_from_duplicate_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_coll_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tconcat_empty_record_r_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tconcat_empty_record_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_over_concat_r_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_over_concat_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_empty_record_r_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_empty_lecord_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_into_id_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_map_coll_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_flatten_map_either_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_map_compose_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_singleton_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_id_r_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_env_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_id_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_ignoreid_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_env_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_env_r_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_ignoreenv_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_app_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_appenv_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_app_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_appenv_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_unop_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_unop_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tunop_over_either_const_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tunop_over_either_const_app_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_mapconcat_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_product_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_select_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_select_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_binop_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproduct_singletons_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproduct_empty_right_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproduct_empty_left_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdouble_flatten_map_coll_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_over_double_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_over_double_map_with_either_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_env_merge_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">ttostring_on_string_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_full_over_select_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcompose_selects_in_mapenv_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmapenv_to_env_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tenv_appenv_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_mapenv_coll_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_through_appenv_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_flatten_mapenv_to_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_over_either_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_over_either_nil_app_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_over_either_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_over_either_nil_app_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_either_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tselect_over_flatten_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_over_flatten_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_over_flatten_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tconcat_over_rec_eq_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tapp_over_const_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_const_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflip_env1_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflip_env2_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmapenv_over_singleton_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_over_binop_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflip_env6_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmapenv_to_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_concat_to_concat_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_with_concat_to_concat_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_over_rec_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tnested_map_over_singletons_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tappenv_mapenv_to_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_const_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_rec_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_concat_r_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_concat_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_rproject_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">trproject_over_either_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_map_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_map_either_nil_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_map_either_nil_app_map_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_map_either_nil_app_singleton_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmapconcat_over_singleton_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdup_elim_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;].<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnraenv_optim_model_list_complete</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">optim_model_list_complete</span> <span class="id">tnraenv_optim_list</span> <span class="id">tnraenv_optim_model_list</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2301')">Proof.</div>
<div class="proofscript" id="proof2301">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">optim_correct_list_complete_prover</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnraenv_optim_list_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">optim_list_correct</span> <span class="id">tnraenv_rewrites_to</span> <span class="id">tnraenv_optim_list</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">optim_list_correct_from_model</span> <span class="id">tnraenv_optim_model_list_complete</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnraenv_optim_list_distinct</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">optim_list_distinct</span> <span class="id">tnraenv_optim_list</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2302')">Proof.</div>
<div class="proofscript" id="proof2302">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">optim_list_distinct_prover</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vm_compute</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">eq_refl</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">run_nraenv_optims</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nraenv</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">opc</span>:<span class="id">optim_phases_config</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">run_phases</span> <span class="id">tnraenv_map_deep</span> <span class="id">nraenv_size</span> <span class="id">tnraenv_optim_list</span> <span class="id">opc</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">run_nraenv_optims_correctness</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">model</span>:<span class="id">basic_model</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nraenv</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">opc</span>:<span class="id">optim_phases_config</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">p</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnraenv_rewrites_to</span> <span class="id">p</span> ( <span class="id">run_nraenv_optims</span> <span class="id">opc</span> <span class="id">p</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2303')">Proof.</div>
<div class="proofscript" id="proof2303">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">run_nraenv_optims</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">run_phases_correctness</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">nraenv_map_deep_correctness</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tnraenv_optim_list_correct</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">default</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nraenv_default_head_optim_list</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} : <span class="id">list</span> <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">optim_step_name</span> <span class="id">tapp_over_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_into_id_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproduct_singletons_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproduct_empty_right_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproduct_empty_left_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_map_compose_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_map_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_id_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_id_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_unop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_binop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_mapconcat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_product_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_unop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcompose_selects_in_mapenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_full_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">ttostring_on_string_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_empty_record_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tselect_and_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">select_union_distr_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_from_duplicate_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_from_duplicate_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tconcat_empty_record_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tconcat_empty_record_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_over_concat_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_over_concat_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_empty_record_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_empty_record_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmapenv_to_env_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tenv_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_mapenv_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_through_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_flatten_mapenv_to_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflip_env1_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflip_env2_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmapenv_over_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_binop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflip_env6_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmapenv_to_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_ignoreid_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_ignoreenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_env_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_env_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_env_merge_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_concat_to_concat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_with_concat_to_concat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_over_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tnested_map_over_singletons_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_env_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tselect_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tselect_over_either_nil_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_over_either_nil_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tselect_over_flatten_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tconcat_over_rec_eq_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_concat_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_concat_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_rproject_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_either_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_map_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_map_either_nil_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_map_either_nil_app_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tunop_over_either_const_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tunop_over_either_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmapconcat_over_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;].<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Remark</span> <span class="id">nraenv_default_head_optim_list_valid</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">valid_optims</span> <span class="id">tnraenv_optim_list</span> <span class="id">nraenv_default_head_optim_list</span> = (<span class="id">nraenv_default_head_optim_list</span>,<span class="id">nil</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2304')">Proof.</div>
<div class="proofscript" id="proof2304">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vm_compute</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nraenv_default_tail_optim_list</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} : <span class="id">list</span> <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="id">optim_step_name</span> <span class="id">tflatten_flatten_map_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_over_flatten_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_into_id_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproduct_singletons_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproduct_empty_right_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproduct_empty_left_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_map_compose_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdouble_flatten_map_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_over_double_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_over_double_map_with_either_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_map_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_id_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_id_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_unop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_binop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_mapconcat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_product_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_unop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcompose_selects_in_mapenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_full_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">ttostring_on_string_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_empty_record_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tselect_and_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">select_union_distr_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_from_duplicate_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_from_duplicate_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tconcat_empty_record_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tconcat_empty_record_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_over_concat_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_over_concat_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_empty_record_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_empty_record_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmapenv_to_env_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tenv_appenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_mapenv_coll_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflip_env1_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflip_env2_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmapenv_over_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_binop_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflip_env6_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmapenv_to_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_ignoreid_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_ignoreenv_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_env_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_env_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_env_merge_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_select_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_concat_to_concat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_with_concat_to_concat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_over_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tnested_map_over_singletons_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tapp_over_env_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_mapenv_to_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tselect_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tselect_over_either_nil_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_over_either_nil_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tappenv_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tselect_over_flatten_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_over_flatten_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tconcat_over_rec_eq_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_concat_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_concat_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_rproject_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">trproject_over_either_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_map_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_map_either_nil_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_map_either_nil_app_map_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_map_either_nil_app_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tunop_over_either_const_app_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tunop_over_either_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmapconcat_over_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;].<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Remark</span> <span class="id">nraenv_default_tail_optim_list_valid</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">valid_optims</span> <span class="id">tnraenv_optim_list</span> <span class="id">nraenv_default_tail_optim_list</span> = (<span class="id">nraenv_default_tail_optim_list</span>,<span class="id">nil</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2305')">Proof.</div>
<div class="proofscript" id="proof2305">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vm_compute</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">default_nraenv_optim_phases</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;("[<span class="id">nraenv</span>] <span class="id">head</span>"%<span class="id">string</span>,<span class="id">nraenv_default_head_optim_list</span>,5)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: ("[<span class="id">nraenv</span>] <span class="id">tail</span>"%<span class="id">string</span>,<span class="id">nraenv_default_tail_optim_list</span>,15)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id">nil</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">default</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">toptim_old_nraenv_head</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nraenv</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">run_nraenv_optims</span> (("<span class="id">head</span>",<span class="id">nraenv_default_head_optim_list</span>,5)::<span class="id">nil</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">toptim_old_nraenv_head_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nraenv</span>} <span class="id">p</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">toptim_old_nraenv_head</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2306')">Proof.</div>
<div class="proofscript" id="proof2306">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">toptim_old_nraenv_head</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">run_nraenv_optims_correctness</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">toptim_old_nraenv_tail</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nraenv</span>} <br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">run_nraenv_optims</span> (("<span class="id">tail</span>",<span class="id">nraenv_default_head_optim_list</span>,15)::<span class="id">nil</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">toptim_old_nraenv_tail_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nraenv</span>} <span class="id">p</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">toptim_old_nraenv_tail</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2307')">Proof.</div>
<div class="proofscript" id="proof2307">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">toptim_old_nraenv_tail</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">run_nraenv_optims_correctness</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">toptim_old_nraenv</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nraenv</span>} :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">compose</span> <span class="id">toptim_old_nraenv_tail</span> <span class="id">toptim_old_nraenv_head</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">compose_transitivity</span> {<span class="id">A</span>:<span class="kwd">Type</span>} {<span class="id">R</span>:<span class="id">relation</span> <span class="id">A</span>} {<span class="id">trans</span>:<span class="id">Transitive</span> <span class="id">R</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">x</span> <span class="id">y</span>:<span class="id">A</span>) (<span class="id">f</span> <span class="id">g</span> :<span class="id">A</span>-&gt;<span class="id">A</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">R</span> <span class="id">x</span> (<span class="id">g</span> <span class="id">y</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">R</span> (<span class="id">g</span> <span class="id">y</span>) (<span class="id">f</span> (<span class="id">g</span> <span class="id">y</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">R</span> <span class="id">x</span> ((<span class="id">compose</span> <span class="id">f</span> <span class="id">g</span>) <span class="id">y</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2308')">Proof.</div>
<div class="proofscript" id="proof2308">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">etransitivity</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">toptim_old_nraenv_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nraenv</span>} <span class="id">p</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ₓ <span class="id">toptim_old_nraenv</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2309')">Proof.</div>
<div class="proofscript" id="proof2309">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">toptim_old_nraenv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">compose_transitivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">toptim_old_nraenv_head_correctness</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">toptim_old_nraenv_tail_correctness</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">NRAEnvOptimizer</span>.<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</div>
</body>
</html>
