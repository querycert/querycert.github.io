
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Qcert.Translation.NNRCMRtoCldMR</title>
<meta name="description" content="Documentation of Coq module Qcert.Translation.NNRCMRtoCldMR" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Qcert.Translation.NNRCMRtoCldMR</h1>
<div class="coq">
<br/>
<span class="kwd">Section</span> <span class="id">NNRCMRToCldMR</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">List</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Sorting.Mergesort</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">EquivDec</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Utils</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">BasicRuntime</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCRuntime</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCMRRuntime</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ForeignCloudant</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ForeignToCloudant</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">CldMRUtil</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">CldMR</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">list_scope</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fredop</span>:<span class="id">foreign_reduce_op</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fcloudant</span>:<span class="id">foreign_cloudant</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">ftocloudant</span>:<span class="id">foreign_to_cloudant</span>}.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> (<span class="id">h</span>:<span class="id">list</span>(<span class="id">string</span>*<span class="id">string</span>)).<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">MRtoMapCld</span> (<span class="id">mrmap</span>: <span class="id">NNRCMR.map_fun</span>) (<span class="id">collectflag</span>:<span class="id">bool</span>) (<span class="id">index</span>:<span class="id">nat</span>) : <span class="id">cld_map</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">emit</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">collectflag</span> <span class="kwd">then</span> <span class="id">CldEmitCollect</span> <span class="id">O</span> <span class="kwd">else</span> <span class="id">CldEmitDist</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mrmap</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">MapDist</span> (<span class="id">x</span>, <span class="id">n</span>) =&gt; <span class="id">mkMapCld</span> (<span class="id">CldMapId</span> (<span class="id">x</span>, <span class="id">n</span>)) <span class="id">emit</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">MapDistFlatten</span> (<span class="id">x</span>, <span class="id">n</span>) =&gt; <span class="id">mkMapCld</span> (<span class="id">CldMapFlatten</span> (<span class="id">x</span>, <span class="id">n</span>)) <span class="id">emit</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">MapScalar</span> (<span class="id">x</span>, <span class="id">n</span>) =&gt; <span class="id">mkMapCld</span> (<span class="id">CldMapFlatten</span> (<span class="id">x</span>,<span class="id">n</span>)) <span class="id">emit</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">pushReduce</span> (<span class="id">avoiddb</span>: <span class="id">list</span> <span class="id">var</span>) (<span class="id">r</span>:(<span class="id">var</span>*<span class="id">nnrc</span>)) : <span class="id">cld_reduce</span> * (<span class="id">var</span>*<span class="id">cld_map</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">fresh_outputdb</span> := <span class="id">fresh_var</span> "<span class="id">output_</span>" <span class="id">avoiddb</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">pushed_reduce</span> := <span class="id">collectReduce</span> (<span class="id">Some</span> <span class="id">fresh_outputdb</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">v_red</span> := <span class="id">fst</span> <span class="id">r</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">f_red</span> := <span class="id">snd</span> <span class="id">r</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">pushed_map</span> := <span class="id">MRtoMapCld</span> (<span class="id">MapScalar</span> (<span class="id">v_red</span>,<span class="id">NNRCUnop</span> <span class="id">AColl</span> <span class="id">f_red</span>)) <span class="id">true</span> 0 <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">pushed_reduce</span>, (<span class="id">fresh_outputdb</span>, <span class="id">pushed_map</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">pushMR</span> (<span class="id">dbinput</span> <span class="id">dboutput</span>:<span class="id">var</span>) (<span class="id">pushed_map</span>: <span class="id">cld_map</span>) (<span class="id">mrempty</span>:<span class="id">option</span> <span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRCld</span> <span class="id">dbinput</span> <span class="id">pushed_map</span> (<span class="id">Some</span> (<span class="id">idReduce</span> (<span class="id">Some</span> <span class="id">dboutput</span>))) <span class="id">mrempty</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">pushMRNoRed</span> (<span class="id">dbinput</span>:<span class="id">var</span>) (<span class="id">pushed_map</span>: <span class="id">cld_map</span>) (<span class="id">mrempty</span>:<span class="id">option</span> <span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRCld</span> <span class="id">dbinput</span> <span class="id">pushed_map</span> <span class="id">None</span> <span class="id">mrempty</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">minMap</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">x</span> := "<span class="id">x</span>"%<span class="id">string</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">map_fun</span> := (<span class="id">x</span>, <span class="id">NNRCUnop</span> (<span class="id">ADot</span> "<span class="id">min</span>") (<span class="id">NNRCVar</span> <span class="id">x</span>)) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMapCld</span> (<span class="id">CldMapId</span> <span class="id">map_fun</span>) (<span class="id">CldEmitCollect</span> <span class="id">O</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">minMR</span> (<span class="id">stats_v</span> <span class="id">out_v</span>: <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRCld</span> <span class="id">stats_v</span> <span class="id">minMap</span> (<span class="id">Some</span> (<span class="id">idReduce</span> (<span class="id">Some</span> <span class="id">out_v</span>))).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">minMRNoRed</span> (<span class="id">stats_v</span>: <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRCld</span> <span class="id">stats_v</span> <span class="id">minMap</span> <span class="id">None</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">maxMap</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">x</span> := "<span class="id">x</span>"%<span class="id">string</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">map_fun</span> := (<span class="id">x</span>, <span class="id">NNRCUnop</span> (<span class="id">ADot</span> "<span class="id">max</span>") (<span class="id">NNRCVar</span> <span class="id">x</span>)) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMapCld</span> (<span class="id">CldMapId</span> <span class="id">map_fun</span>) (<span class="id">CldEmitCollect</span> <span class="id">O</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">maxMR</span> (<span class="id">stats_v</span> <span class="id">out_v</span>: <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRCld</span> <span class="id">stats_v</span> <span class="id">maxMap</span> (<span class="id">Some</span> (<span class="id">idReduce</span> (<span class="id">Some</span> <span class="id">out_v</span>))).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">maxMRNoRed</span> (<span class="id">stats_v</span>: <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRCld</span> <span class="id">stats_v</span> <span class="id">maxMap</span> <span class="id">None</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">MRtoReduceCld</span> (<span class="id">v_key</span>:<span class="id">var</span>) (<span class="id">out_v</span>:<span class="id">var</span>) (<span class="id">avoiddb</span>: <span class="id">list</span> <span class="id">var</span>) (<span class="id">mrr</span>: <span class="id">NNRCMR.reduce_fun</span>) (<span class="id">mrempty</span>:<span class="id">option</span> <span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bool</span> * <span class="id">cld_reduce</span> * (<span class="id">option</span> <span class="id">cldmr_step</span>) * (<span class="id">list</span> <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mrr</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">RedId</span> =&gt; (<span class="id">false</span>, <span class="id">idReduce</span> (<span class="id">Some</span> <span class="id">out_v</span>), <span class="id">None</span>, <span class="id">avoiddb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">RedCollect</span> <span class="id">redf</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">pushed_red</span>, (<span class="id">newdbout</span>,<span class="id">pushed_map</span>)) := <span class="id">pushReduce</span> <span class="id">avoiddb</span> <span class="id">redf</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">pushed_mr</span> := <span class="id">pushMR</span> <span class="id">newdbout</span> <span class="id">out_v</span> <span class="id">pushed_map</span> <span class="id">mrempty</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">true</span>, <span class="id">pushed_red</span>, <span class="id">Some</span> <span class="id">pushed_mr</span>, <span class="id">newdbout</span>::<span class="id">avoiddb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">RedOp</span> <span class="id">op</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">op</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">RedOpForeign</span> <span class="id">frop</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">true</span>, <span class="id">opReduce</span> (<span class="id">foreign_to_cloudant_reduce_op</span> <span class="id">frop</span>) (<span class="id">Some</span> <span class="id">out_v</span>), <span class="id">None</span>, <span class="id">avoiddb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">RedSingleton</span> =&gt; (<span class="id">true</span>, <span class="id">idReduce</span> (<span class="id">Some</span> <span class="id">out_v</span>), <span class="id">None</span>, <span class="id">avoiddb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">MRtoMRCld</span> (<span class="id">avoiddb</span>: <span class="id">list</span> <span class="id">var</span>) (<span class="id">mr</span>: <span class="id">mr</span>) : (<span class="id">list</span> <span class="id">cldmr_step</span>) * (<span class="id">list</span> <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">cld_input</span> := <span class="id">mr_input</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">cld_output</span> := <span class="id">mr_output</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mrmap</span> := <span class="id">mr_map</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mrred</span> := <span class="id">mr_reduce</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mrempty</span> := <span class="id">mr_reduce_empty</span> <span class="id">h</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">v_key</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mrmap</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">MapDist</span> (<span class="id">x</span>, <span class="id">_</span>) =&gt; <span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">MapDistFlatten</span> (<span class="id">x</span>, <span class="id">_</span>) =&gt; <span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">MapScalar</span> (<span class="id">x</span>, <span class="id">_</span>) =&gt; <span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">collectflag</span>, <span class="id">first_reduce</span>,<span class="id">pushedmr</span>,<span class="id">avoiddb</span>') := <span class="id">MRtoReduceCld</span> <span class="id">v_key</span> <span class="id">cld_output</span> <span class="id">avoiddb</span> <span class="id">mrred</span> <span class="id">mrempty</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">cld_map</span> := <span class="id">MRtoMapCld</span> <span class="id">mrmap</span> <span class="id">collectflag</span> 0 <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">pushedmr</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; (<span class="id">mkMRCld</span> <span class="id">cld_input</span> <span class="id">cld_map</span> (<span class="id">Some</span> <span class="id">first_reduce</span>) <span class="id">mrempty</span> :: <span class="id">nil</span>, <span class="id">avoiddb</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">nextmr</span> =&gt; ((<span class="id">mkMRCld</span> <span class="id">cld_input</span> <span class="id">cld_map</span> (<span class="id">Some</span> <span class="id">first_reduce</span>) (<span class="id">Some</span> (<span class="id">NNRCConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))) :: <span class="id">nextmr</span> :: <span class="id">nil</span>, <span class="id">avoiddb</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">cld_data_of_localized_data</span> (<span class="id">locd</span>:<span class="id">ddata</span>) : <span class="id">list</span> <span class="id">data</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">locd</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Dlocal</span> <span class="id">d</span> =&gt; (<span class="id">d</span>::<span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Ddistr</span> <span class="id">dl</span> =&gt; <span class="id">dl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">rmap_with_key</span> (<span class="id">prefix</span>:<span class="id">list</span> <span class="id">nat</span>) (<span class="id">i</span>:<span class="id">nat</span>) (<span class="id">v</span>:<span class="id">var</span>) (<span class="id">n</span>:<span class="id">nnrc</span>) (<span class="id">coll</span>: <span class="id">list</span> <span class="id">data</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">rmap</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">d</span> : <span class="id">data</span> * <span class="id">data</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">k</span>, <span class="id">v0</span>) := <span class="id">d</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> ((<span class="id">v</span>, <span class="id">v0</span>) :: <span class="id">nil</span>) <span class="id">n</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">res</span> =&gt; <span class="id">Some</span> (<span class="id">k</span>, <span class="id">res</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>) (<span class="id">init_keys_aux</span> <span class="id">prefix</span> <span class="id">i</span> <span class="id">coll</span>)) =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lift</span> (<span class="id">init_keys_aux</span> <span class="id">prefix</span> <span class="id">i</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">rmap</span> (<span class="kwd">fun</span> <span class="id">d</span> : <span class="id">data</span> =&gt; <span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> ((<span class="id">v</span>, <span class="id">d</span>) :: <span class="id">nil</span>) <span class="id">n</span>) <span class="id">coll</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2883')">Proof.</div>
<div class="proofscript" id="proof2883">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">i</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">coll</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> ((<span class="id">v</span>, <span class="id">a</span>) :: <span class="id">nil</span>) <span class="id">n</span>); <span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">IHcoll</span> (<span class="id">S</span> <span class="id">i</span>)); <span class="tactic">clear</span> <span class="id">IHcoll</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> ((<span class="id">rmap</span> (<span class="kwd">fun</span> <span class="id">d0</span> : <span class="id">data</span> =&gt; <span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> ((<span class="id">v</span>, <span class="id">d0</span>) :: <span class="id">nil</span>) <span class="id">n</span>) <span class="id">coll</span>)); <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">rmap_eval_through_init_keys</span> (<span class="id">l</span>:<span class="id">list</span> <span class="id">data</span>) (<span class="id">n</span>:<span class="id">nnrc</span>) (<span class="id">v</span>:<span class="id">var</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">rmap</span> (<span class="kwd">fun</span> <span class="id">d</span> : <span class="id">data</span> * <span class="id">data</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">k</span>, <span class="id">v0</span>) := <span class="id">d</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> ((<span class="id">v</span>, <span class="id">v0</span>) :: <span class="id">nil</span>) <span class="id">n</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">res0</span> =&gt; <span class="id">Some</span> (<span class="id">k</span>, <span class="id">res0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>) (<span class="id">init_keys</span> <span class="id">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;= <span class="id">lift</span> <span class="id">init_keys</span> (<span class="id">rmap</span> (<span class="kwd">fun</span> <span class="id">d</span> : <span class="id">data</span> =&gt; <span class="id">nnrc_core_eval</span> <span class="id">h</span> <span class="id">nil</span> ((<span class="id">v</span>, <span class="id">d</span>) :: <span class="id">nil</span>) <span class="id">n</span>) <span class="id">l</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2884')">Proof.</div>
<div class="proofscript" id="proof2884">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">init_keys</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">rmap_with_key</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">MRtoMRCld_preserves_causally_consistent</span> (<span class="id">init_unit</span>:<span class="id">var</span>) (<span class="id">mr</span>:<span class="id">mr</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr</span>.(<span class="id">mr_input</span>) &lt;&gt; <span class="id">mr</span>.(<span class="id">mr_output</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr</span>.(<span class="id">mr_output</span>) &lt;&gt; <span class="id">init_unit</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">init_unit</span> &lt;&gt; <span class="id">mr</span>.(<span class="id">mr_input</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_chain_causally_consistent</span> (<span class="id">fst</span> (<span class="id">MRtoMRCld</span> (<span class="id">mr</span>.(<span class="id">mr_input</span>) :: <span class="id">mr</span>.(<span class="id">mr_output</span>) :: <span class="id">init_unit</span> :: <span class="id">nil</span>) <span class="id">mr</span>)) = <span class="id">true</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2885')">Proof.</div>
<div class="proofscript" id="proof2885">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">MRtoMRCld</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">MRtoReduceCld</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">mr</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">mr_reduce</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_chain_causally_consistent</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_step_causally_consistent</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nequiv_decb</span>, <span class="id">equiv_decb</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">match_destr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">destruct</span> (<span class="id">equiv_dec</span> <span class="id">mr_input</span> <span class="id">mr_output</span>); [ <span class="tactic">congruence</span> | ].<br/>
<div class="doc">TODO: currently false </div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">admit</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">destruct</span> <span class="id">r</span>; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">match_destr</span>; <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;Admitted.</div>
<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">mr_chain_to_cldmr_chain</span> (<span class="id">avoiddb</span>: <span class="id">list</span> <span class="id">var</span>) (<span class="id">l</span>: <span class="id">list</span> <span class="id">mr</span>) : <span class="id">list</span> <span class="id">cldmr_step</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">l</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">nil</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">mr</span> :: <span class="id">l</span>' =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">cldmr_step</span>,<span class="id">avoiddb</span>') := (<span class="id">MRtoMRCld</span> <span class="id">avoiddb</span> <span class="id">mr</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_step</span> ++ (<span class="id">mr_chain_to_cldmr_chain</span> <span class="id">avoiddb</span>' <span class="id">l</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mr_last_to_cldmr_last</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr_last_closure</span>:(<span class="id">list</span> <span class="id">var</span> * <span class="id">nnrc</span>) * <span class="id">list</span> (<span class="id">var</span> * <span class="id">dlocalization</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: (<span class="id">list</span> <span class="id">var</span> * <span class="id">nnrc</span>) * <span class="id">list</span> <span class="id">var</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">fvs</span>, <span class="id">mr_last</span>) := <span class="id">fst</span> <span class="id">mr_last_closure</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">vars_loc</span> := <span class="id">snd</span> <span class="id">mr_last_closure</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">cldmr_last</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">List.fold_right</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">fv</span> <span class="id">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lookup</span> <span class="id">equiv_dec</span> <span class="id">vars_loc</span> <span class="id">fv</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">k</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">Vdistr</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCLet</span> <span class="id">fv</span> (<span class="id">NNRCVar</span> <span class="id">fv</span>) <span class="id">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">Vlocal</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCLet</span> <span class="id">fv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCEither</span> (<span class="id">NNRCUnop</span> <span class="id">ASingleton</span> (<span class="id">NNRCVar</span> <span class="id">fv</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fv</span> (<span class="id">NNRCVar</span> <span class="id">fv</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fv</span> (<span class="id">NNRCConst</span> <span class="id">dunit</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_last</span> <span class="id">fvs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">fvs</span>, <span class="id">cldmr_last</span>), <span class="id">map</span> <span class="id">fst</span> <span class="id">vars_loc</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">NNRCMRtoNNRCMRCloudant</span> (<span class="id">avoiddb</span>: <span class="id">list</span> <span class="id">var</span>) (<span class="id">mrl</span>: <span class="id">nnrcmr</span>) : <span class="id">cldmr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkMRCldChain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr_chain_to_cldmr_chain</span> <span class="id">avoiddb</span> <span class="id">mrl</span>.(<span class="id">mr_chain</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mr_last_to_cldmr_last</span> <span class="id">mrl</span>.(<span class="id">mr_last</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Bool</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">MRtoMRCld_causally_consistent</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">avoiddb</span> (<span class="id">mr</span>:<span class="id">mr</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">In</span> <span class="id">mr</span>.(<span class="id">mr_input</span>) <span class="id">avoiddb</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_causally_consistent</span> <span class="id">mr</span> <span class="id">mr</span> = <span class="id">true</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forallb</span> (<span class="kwd">fun</span> <span class="id">y</span> =&gt; <span class="id">cldmr_step_input</span> <span class="id">y</span> &lt;&gt;<span class="id">b</span> <span class="id">mr</span>.(<span class="id">mr_output</span>)) <span class="id">x</span> = <span class="id">true</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_chain_causally_consistent</span> <span class="id">x</span> = <span class="id">true</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incl</span> (<span class="id">mr</span>.(<span class="id">mr_output</span>) :: <span class="id">map</span> <span class="id">cldmr_step_input</span> <span class="id">x</span>) <span class="id">avoiddb</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_chain_causally_consistent</span> (<span class="id">x</span> ++ <span class="id">fst</span> (<span class="id">MRtoMRCld</span> <span class="id">avoiddb</span> <span class="id">mr</span>)) = <span class="id">true</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2886')">Proof.</div>
<div class="proofscript" id="proof2886">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">MRtoMRCld</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">MRtoReduceCld</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">mr</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">mr_reduce</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_chain_causally_consistent</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_step_causally_consistent</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_causally_consistent</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nequiv_decb</span>, <span class="id">equiv_decb</span> <span class="kwd">in</span> *; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">forallb_ordpairs_refl_app_cons</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">rewrite</span> <span class="id">app_cons_cons_expand</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">forallb_ordpairs_refl_app_cons</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">apply</span> <span class="id">forallb_ordpairs_refl_app_cons</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">match_destr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">e</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">fresh_var_fresh</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">rewrite</span> <span class="id">forallb_forall</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">aa</span> <span class="id">inn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">incl</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H3</span> (<span class="id">cldmr_step_input</span> <span class="id">aa</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">e</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eelim</span> <span class="id">fresh_var_fresh</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">in_map_iff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id">match_destr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">e</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">incl</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eelim</span> <span class="id">fresh_var_fresh</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr_in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">forallb_app</span>; <span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">destruct</span> <span class="id">r</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span> [ <span class="tactic">apply</span> <span class="id">forallb_ordpairs_refl_app_cons</span>; <span class="tactic">simpl</span>; <span class="tactic">trivial</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">forallb_ordpairs_refl_app_cons</span>; <span class="tactic">simpl</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">MRtoMRCid_avoids</span> <span class="id">avoiddb</span> <span class="id">a</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">l0</span>, <span class="id">l1</span>) := <span class="id">MRtoMRCld</span> <span class="id">avoiddb</span> <span class="id">a</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incl</span> (<span class="id">mr_input</span> <span class="id">a</span> :: <span class="id">nil</span>) <span class="id">avoiddb</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incl</span> (<span class="id">avoiddb</span> ++ <span class="id">map</span> <span class="id">cldmr_step_input</span> <span class="id">l0</span>) <span class="id">l1</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2887')">Proof.</div>
<div class="proofscript" id="proof2887">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">MRtoMRCld</span>, <span class="id">MRtoReduceCld</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">mr_reduce</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">unfold</span> <span class="id">incl</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">in_app_iff</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">unfold</span> <span class="id">incl</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">in_app_iff</span> <span class="kwd">in</span> <span class="id">H0</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">destruct</span> <span class="id">r</span>; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">incl</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">in_app_iff</span> <span class="kwd">in</span> <span class="id">H0</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H0</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">unfold</span> <span class="id">incl</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">in_app_iff</span> <span class="kwd">in</span> <span class="id">H0</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">MRtoMRCid_input_avoids</span> <span class="id">avoiddb</span> <span class="id">a</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">l0</span>, <span class="id">l1</span>) := <span class="id">MRtoMRCld</span> <span class="id">avoiddb</span> <span class="id">a</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Forall</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">cldmr_step_input</span> <span class="id">x</span> = <span class="id">mr_input</span> <span class="id">a</span> \/ ~ <span class="id">In</span> (<span class="id">cldmr_step_input</span> <span class="id">x</span>) <span class="id">avoiddb</span>) <span class="id">l0</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2888')">Proof.</div>
<div class="proofscript" id="proof2888">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="kwd">Resolve</span> <span class="id">fresh_var_fresh</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">MRtoMRCld</span>, <span class="id">MRtoReduceCld</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">mr_reduce</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">econstructor</span>; <span class="tactic">simpl</span>; [<span class="tactic">intuition</span> | ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">simpl</span>; [| <span class="tactic">intuition</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">destruct</span> <span class="id">r</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">NNRCMRtoNNRCMRCloudant_causally_consistent</span> <span class="id">avoiddb</span> <span class="id">l</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mr_chain_causally_consistent</span> <span class="id">l</span> = <span class="id">true</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_chain_causally_consistent</span> <span class="id">x</span> = <span class="id">true</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forallb</span> (<span class="kwd">fun</span> <span class="id">a</span> =&gt; <span class="id">forallb</span> (<span class="kwd">fun</span> <span class="id">y</span> : <span class="id">cldmr_step</span> =&gt; <span class="id">cldmr_step_input</span> <span class="id">y</span> &lt;&gt;<span class="id">b</span> <span class="id">mr_output</span> <span class="id">a</span>) <span class="id">x</span>) <span class="id">l</span> = <span class="id">true</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incl</span> (<span class="id">map</span> <span class="id">mr_input</span> <span class="id">l</span> ++ <span class="id">map</span> <span class="id">mr_output</span> <span class="id">l</span> ++ <span class="id">map</span> <span class="id">cldmr_step_input</span> <span class="id">x</span>) <span class="id">avoiddb</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_chain_causally_consistent</span> (<span class="id">x</span> ++ <span class="id">mr_chain_to_cldmr_chain</span> <span class="id">avoiddb</span> <span class="id">l</span>) = <span class="id">true</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2889')">Proof.</div>
<div class="proofscript" id="proof2889">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_chain_causally_consistent</span>, <span class="id">cldmr_chain_causally_consistent</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">avoiddb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l</span>; <span class="tactic">intros</span> <span class="id">avoiddb</span> <span class="id">lcc</span> <span class="id">x</span> <span class="id">xcc</span> <span class="id">avoided</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="tactic">rewrite</span> <span class="id">app_nil_r</span>; <span class="tactic">trivial</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">andb_true_iff</span> <span class="kwd">in</span> * .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">admit</span>. <span class="comment">(*&nbsp;XXXXXXXXXXXXX&nbsp;*)</span><br/>
&nbsp;rewrite&nbsp;app_nil_r.&nbsp;*)</span>&nbsp;apply&nbsp;MRtoMRCldLast_causually_consistent;&nbsp;trivial.&nbsp;*)</span>&nbsp;simpl&nbsp;in&nbsp;*.&nbsp;*)</span>&nbsp;unfold&nbsp;incl&nbsp;in&nbsp;*;&nbsp;simpl&nbsp;in&nbsp;*;&nbsp;intuition.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">match_case</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">app_ass</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">simpl</span> <span class="kwd">in</span> * .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">andb_true_iff</span> <span class="kwd">in</span> * .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">generalize</span> (<span class="id">MRtoMRCld_causally_consistent</span> <span class="id">avoiddb</span> <span class="id">a</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span> <span class="id">HH</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">HH</span>; <span class="tactic">clear</span> <span class="id">HH</span>; <span class="tactic">simpl</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">unfold</span> <span class="id">incl</span> <span class="kwd">in</span> *; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">unfold</span> <span class="id">incl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">aa</span> <span class="id">inn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">aa</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> (<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">rewrite</span> <span class="id">in_app_iff</span> <span class="kwd">in</span> <span class="id">H</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">andb_true_iff</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">forallb_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">generalize</span> (<span class="id">MRtoMRCid_input_avoids</span> <span class="id">avoiddb</span> <span class="id">a</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Forall_forall</span>, <span class="id">forallb_forall</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">HH</span> ? <span class="id">inn2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">HH</span> <span class="id">_</span> <span class="id">inn2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nequiv_decb</span>, <span class="id">equiv_decb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">e</span> <span class="kwd">in</span> * .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="tactic">destruct</span> <span class="id">HH</span> <span class="kwd">as</span> [<span class="id">eqq</span>|<span class="id">inn3</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">unfold</span> <span class="id">mr_causally_consistent</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nequiv_decb</span>, <span class="id">equiv_decb</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr_in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">elim</span> <span class="id">inn3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> (<span class="id">H</span> (<span class="id">mr_output</span> <span class="id">m</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> (<span class="tactic">simpl</span>; <span class="tactic">rewrite</span> <span class="id">in_app_iff</span>); <span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">rewrite</span> <span class="id">forallb_forall</span> <span class="kwd">in</span> <span class="id">H8</span> |- *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> ? <span class="id">inn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H8</span> <span class="id">_</span> <span class="id">inn</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">forallb_app</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id">MRtoMRCid_input_avoids</span> <span class="id">avoiddb</span> <span class="id">a</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Forall_forall</span>, <span class="id">forallb_forall</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">HH</span> ? <span class="id">inn2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">HH</span> <span class="id">_</span> <span class="id">inn2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nequiv_decb</span>, <span class="id">equiv_decb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">e</span> <span class="kwd">in</span> * .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="tactic">destruct</span> <span class="id">HH</span> <span class="kwd">as</span> [<span class="id">eqq</span>|<span class="id">inn3</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">rewrite</span> <span class="id">forallb_forall</span> <span class="kwd">in</span> <span class="id">H9</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H9</span> <span class="id">_</span> <span class="id">inn</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">mr_causally_consistent</span> <span class="kwd">in</span> <span class="id">H9</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nequiv_decb</span>, <span class="id">equiv_decb</span> <span class="kwd">in</span> <span class="id">H9</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_destr_in</span> <span class="id">H9</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">elim</span> <span class="id">inn3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> (<span class="id">H</span> (<span class="id">mr_output</span> <span class="id">x0</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">cut</span> (<span class="id">In</span> (<span class="id">mr_output</span> <span class="id">x0</span>) (<span class="id">map</span> <span class="id">mr_output</span> <span class="id">l</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">repeat</span> (<span class="tactic">simpl</span>; <span class="tactic">rewrite</span> <span class="id">in_app_iff</span>); <span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">rewrite</span> <span class="id">in_map_iff</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="tactic">generalize</span> (<span class="id">MRtoMRCid_avoids</span> <span class="id">avoiddb</span> <span class="id">a</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>; <span class="tactic">intros</span> <span class="id">inc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">inc</span>; <span class="tactic">clear</span> <span class="id">inc</span>; <span class="tactic">unfold</span> <span class="id">incl</span> <span class="kwd">in</span> *; <span class="tactic">simpl</span> <span class="kwd">in</span> *;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">aa</span> <span class="id">inn</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">aa</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> (<span class="tactic">rewrite</span> <span class="id">in_app_iff</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">rewrite</span> <span class="id">in_app_iff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">map_app</span> <span class="kwd">in</span> <span class="id">inn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> (<span class="tactic">rewrite</span> <span class="id">in_app_iff</span> <span class="kwd">in</span> <span class="id">inn</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">inn</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;Admitted.</div>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcmr_to_cldmr_top</span> (<span class="id">mrl</span>: <span class="id">nnrcmr</span>) : <span class="id">cldmr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">avoiddb</span> := <span class="id">List.map</span> <span class="id">mr_input</span> <span class="id">mrl</span>.(<span class="id">mr_chain</span>) ++ <span class="id">List.map</span> <span class="id">mr_output</span> <span class="id">mrl</span>.(<span class="id">mr_chain</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCMRtoNNRCMRCloudant</span> <span class="id">avoiddb</span> <span class="id">mrl</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrcmr_to_cldmr_top_causally_consistent</span> <span class="id">mrl</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcmr_causally_consistent</span> <span class="id">mrl</span> = <span class="id">true</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cldmr_chain_causally_consistent</span> (<span class="id">nnrcmr_to_cldmr_top</span> <span class="id">mrl</span>).(<span class="id">cldmr_chain</span>) = <span class="id">true</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2890')">Proof.</div>
<div class="proofscript" id="proof2890">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">cc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">nnrcmr_to_cldmr_top</span>.<br/>
&nbsp;&nbsp;&nbsp;generalize&nbsp;(NNRCMRtoNNRCMRCloudantInit_causally_consistent&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(List.map&nbsp;mr_input&nbsp;l&nbsp;++&nbsp;List.map&nbsp;mr_output&nbsp;l)&nbsp;l&nbsp;cc&nbsp;nil);&nbsp;simpl;&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intros&nbsp;HH.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;apply&nbsp;HH.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;-&nbsp;reflexivity.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;-&nbsp;rewrite&nbsp;forallb_forall;&nbsp;intuition.&nbsp;*)</span>&nbsp;&nbsp;&nbsp;-&nbsp;rewrite&nbsp;app_nil_r.&nbsp;reflexivity.&nbsp;*)</span>&nbsp;Qed.&nbsp;*)</span>&nbsp;&nbsp;Admitted.</div>
<br/>
<span class="kwd">End</span> <span class="id">NNRCMRToCldMR</span>.<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</div>
</body>
</html>
