
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Qcert.NNRC.Optim.NNRCOptimizer</title>
<meta name="description" content="Documentation of Coq module Qcert.NNRC.Optim.NNRCOptimizer" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Qcert.NNRC.Optim.NNRCOptimizer</h1>
<div class="coq">
<br/>
<br/>
<span class="kwd">Section</span> <span class="id">NNRCOptimizer</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">List</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ListSet</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Arith</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Equivalence</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Morphisms</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Setoid</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">EquivDec</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="kwd">Program</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">BasicSystem</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">cNNRCSystem</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCSystem</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCRewriteUtil</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCRewrite</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">TNNRCRewrite</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">OptimizerLogger</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">OptimizerStep</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">nnrc_scope</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">engine</span>.<br/>
<div class="doc">Apply the function f to the direct child of p </div>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrc_map</span> (<span class="id">f</span>: <span class="id">nnrc</span> -&gt; <span class="id">nnrc</span>) (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCGetConstant</span> <span class="id">v</span> =&gt; <span class="id">NNRCGetConstant</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCVar</span> <span class="id">v</span> =&gt; <span class="id">NNRCVar</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCConst</span> <span class="id">d</span> =&gt; <span class="id">NNRCConst</span> <span class="id">d</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCBinop</span> <span class="id">bop</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NNRCBinop</span> <span class="id">bop</span> (<span class="id">f</span> <span class="id">e1</span>) (<span class="id">f</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> <span class="id">uop</span> <span class="id">e1</span> =&gt; <span class="id">NNRCUnop</span> <span class="id">uop</span> (<span class="id">f</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCLet</span> <span class="id">v</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NNRCLet</span> <span class="id">v</span> (<span class="id">f</span> <span class="id">e1</span>) (<span class="id">f</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCFor</span> <span class="id">v</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NNRCFor</span> <span class="id">v</span> (<span class="id">f</span> <span class="id">e1</span>) (<span class="id">f</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCIf</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">e3</span> =&gt; <span class="id">NNRCIf</span> (<span class="id">f</span> <span class="id">e1</span>) (<span class="id">f</span> <span class="id">e2</span>) (<span class="id">f</span> <span class="id">e3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCEither</span> <span class="id">ed</span> <span class="id">xl</span> <span class="id">el</span> <span class="id">xr</span> <span class="id">er</span> =&gt; <span class="id">NNRCEither</span> (<span class="id">f</span> <span class="id">ed</span>) <span class="id">xl</span> (<span class="id">f</span> <span class="id">el</span>) <span class="id">xr</span> (<span class="id">f</span> <span class="id">er</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCGroupBy</span> <span class="id">g</span> <span class="id">sl</span> <span class="id">e1</span> =&gt; <span class="id">NNRCGroupBy</span> <span class="id">g</span> <span class="id">sl</span> (<span class="id">f</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrc_map_correctness</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">f</span>: <span class="id">nnrc</span> -&gt; <span class="id">nnrc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">e</span>: <span class="id">nnrc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">e</span>', <span class="id">nnrc_ext_eq</span> (<span class="id">f</span> <span class="id">e</span>') <span class="id">e</span>') -&gt; <span class="id">nnrc_ext_eq</span> (<span class="id">nnrc_map</span> <span class="id">f</span> <span class="id">e</span>) <span class="id">e</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2554')">Proof.</div>
<div class="proofscript" id="proof2554">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">f</span> <span class="id">e</span> <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_cases</span> (<span class="tactic">induction</span> <span class="id">e</span>) <span class="id">Case</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">simpl</span>; <span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">Hf</span>; <span class="tactic">reflexivity</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Qed.</div>
<br/>
<div class="doc">Apply the function f to all subexpression of e. </div>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">nnrc_map_deep</span> (<span class="id">f</span>: <span class="id">nnrc</span> -&gt; <span class="id">nnrc</span>) (<span class="id">e</span>: <span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCGetConstant</span> <span class="id">v</span> =&gt; <span class="id">f</span> (<span class="id">NNRCGetConstant</span> <span class="id">v</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCVar</span> <span class="id">v</span> =&gt; <span class="id">f</span> (<span class="id">NNRCVar</span> <span class="id">v</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCConst</span> <span class="id">d</span> =&gt; <span class="id">f</span> (<span class="id">NNRCConst</span> <span class="id">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCBinop</span> <span class="id">bop</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">f</span> (<span class="id">NNRCBinop</span> <span class="id">bop</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e1</span>) (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> <span class="id">uop</span> <span class="id">e1</span> =&gt; <span class="id">f</span> (<span class="id">NNRCUnop</span> <span class="id">uop</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCLet</span> <span class="id">v</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">f</span> (<span class="id">NNRCLet</span> <span class="id">v</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e1</span>) (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCFor</span> <span class="id">v</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">f</span> (<span class="id">NNRCFor</span> <span class="id">v</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e1</span>) (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCIf</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">e3</span> =&gt; <span class="id">f</span> (<span class="id">NNRCIf</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e1</span>) (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e2</span>) (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e3</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCEither</span> <span class="id">ed</span> <span class="id">xl</span> <span class="id">el</span> <span class="id">xr</span> <span class="id">er</span> =&gt; <span class="id">f</span> (<span class="id">NNRCEither</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">ed</span>) <span class="id">xl</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span>  <span class="id">el</span>) <span class="id">xr</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">er</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCGroupBy</span> <span class="id">g</span> <span class="id">sl</span> <span class="id">e1</span> =&gt; <span class="id">f</span> (<span class="id">NNRCGroupBy</span> <span class="id">g</span> <span class="id">sl</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nnrc_map_deep_corretness</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">f</span>: <span class="id">nnrc</span> -&gt; <span class="id">nnrc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">e</span>: <span class="id">nnrc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">e</span>', <span class="id">nnrc_ext_eq</span> (<span class="id">f</span> <span class="id">e</span>') <span class="id">e</span>') -&gt; <span class="id">nnrc_ext_eq</span> (<span class="id">nnrc_map_deep</span> <span class="id">f</span> <span class="id">e</span>) <span class="id">e</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2555')">Proof.</div>
<div class="proofscript" id="proof2555">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">f</span> <span class="id">e</span> <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_cases</span> (<span class="tactic">induction</span> <span class="id">e</span>) <span class="id">Case</span>; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">Hf</span>; <span class="tactic">reflexivity</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">Hf</span>; <span class="tactic">rewrite</span> <span class="id">IHe</span>; <span class="tactic">reflexivity</span> ];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">Hf</span>; <span class="tactic">rewrite</span> <span class="id">IHe1</span>; <span class="tactic">rewrite</span> <span class="id">IHe2</span>; <span class="tactic">reflexivity</span> ];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">Hf</span>; <span class="tactic">rewrite</span> <span class="id">IHe1</span>; <span class="tactic">rewrite</span> <span class="id">IHe2</span>; <span class="tactic">rewrite</span> <span class="id">IHe3</span>; <span class="tactic">reflexivity</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Qed.</div>
<br/>
<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nunshadow</span> := <span class="id">unshadow_simpl</span> <span class="id">nil</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">head_rew</span> (<span class="id">e</span>: <span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nunshadow</span> <span class="id">e</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">head_rew_correctness</span> <span class="id">e</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_ext_eq</span> (<span class="id">head_rew</span> <span class="id">e</span>) <span class="id">e</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2556')">Proof.</div>
<div class="proofscript" id="proof2556">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">head_rew</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">unshadow_ext_preserves</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">rewriter_simpl_rew_no_free_var</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">op</span> : <span class="id">nnrc</span>) (<span class="id">x</span> : <span class="id">var</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">In</span> <span class="id">x</span> (<span class="id">nnrc_free_vars</span> (<span class="id">head_rew</span> <span class="id">op</span>)) -&gt; <span class="id">In</span> <span class="id">x</span> (<span class="id">nnrc_free_vars</span> <span class="id">op</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2557')">Proof.</div>
<div class="proofscript" id="proof2557">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">head_rew</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">unshadow_free_vars</span>; <span class="tactic">eapply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">engine</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Ltac</span> <span class="id">tcorrectness_prover</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>; <span class="tactic">repeat</span> <span class="tactic">progress</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="tactic">try</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| [|- <span class="id">context</span> [<span class="kwd">match</span> ?<span class="id">p</span> <span class="kwd">with</span> | <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>] ] =&gt; <span class="tactic">destruct</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">try</span> <span class="tactic">unfold</span> <span class="id">Equivalence.equiv</span> <span class="kwd">in</span> *; <span class="tactic">try</span> <span class="tactic">subst</span>).<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Ltac</span> <span class="id">tprove_correctness</span> <span class="id">p</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcorrectness_prover</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnnrc_ext_rewrites_to_trans</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">e1</span> <span class="id">e2</span> <span class="id">e3</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e1</span> <span class="id">e2</span> -&gt; <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e2</span> <span class="id">e3</span> -&gt; <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e1</span> <span class="id">e3</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2558')">Proof.</div>
<div class="proofscript" id="proof2558">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="tactic">transitivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">AUX</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">f</span> <span class="id">e</span> <span class="id">e</span>' :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">e</span>, <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">f</span> <span class="id">e</span>)) -&gt; <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> <span class="id">e</span>' -&gt; <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">f</span> <span class="id">e</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2559')">Proof.</div>
<div class="proofscript" id="proof2559">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span> <span class="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">e</span>') <span class="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnnrc_map</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} := <span class="id">nnrc_map</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnnrc_map_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>}:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">f</span>: <span class="id">nnrc</span> -&gt; <span class="id">nnrc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>: <span class="id">nnrc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">p</span>', <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">p</span>' (<span class="id">f</span> <span class="id">p</span>')) -&gt; <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">p</span> (<span class="id">tnnrc_map</span> <span class="id">f</span> <span class="id">p</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2560')">Proof.</div>
<div class="proofscript" id="proof2560">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_cases</span> (<span class="tactic">induction</span> <span class="id">p</span>) <span class="id">Case</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">simpl</span>; <span class="tactic">apply</span> <span class="id">Hf</span>]; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p1</span>) <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p2</span>) <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p</span>) <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p1</span>) <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p2</span>) <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p3</span>) <span class="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p1</span>) <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p2</span>) <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p3</span>) <span class="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">H</span> <span class="id">p</span>) <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnnrc_map_deep</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} := <span class="id">nnrc_map_deep</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnnrc_map_deep_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>}:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">f</span>: <span class="id">nnrc</span> -&gt; <span class="id">nnrc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>: <span class="id">nnrc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">p</span>', <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">p</span>' (<span class="id">f</span> <span class="id">p</span>')) -&gt; <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">p</span> (<span class="id">tnnrc_map_deep</span> <span class="id">f</span> <span class="id">p</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2561')">Proof.</div>
<div class="proofscript" id="proof2561">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">f</span> <span class="id">p</span> <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrc_cases</span> (<span class="tactic">induction</span> <span class="id">p</span>) <span class="id">Case</span>; <span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">simpl</span>; <span class="tactic">apply</span> <span class="id">Hf</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="tactic">rewrite</span> <span class="id">IHp1</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">IHp2</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">Hf</span> <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="tactic">rewrite</span> <span class="id">IHp</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">Hf</span> <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">IHp1</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">IHp2</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">IHp3</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">Hf</span> <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">IHp1</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">IHp2</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">IHp3</span> <span class="tactic">at</span> 1; <span class="tactic">rewrite</span> <span class="id">Hf</span> <span class="tactic">at</span> 1; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunshadow_preserves_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unshadow_simpl</span> <span class="id">nil</span> <span class="id">e</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tunshadow_preserves_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tunshadow_preserves_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2562')">Proof.</div>
<div class="proofscript" id="proof2562">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">tunshadow_preserves_fun</span>, <span class="id">unshadow_simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tunshadow_preserves_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunshadow_preserves_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">unshadow</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Renames</span> <span class="id">variables</span> <span class="id">to</span> <span class="id">avoid</span> <span class="id">shadowing</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tunshadow_preserves_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tunshadow_preserves_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunshadow_preserves_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tunshadow_preserves_step</span> <span class="id">tunshadow_preserves_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_nil_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCFor</span> <span class="id">x</span> ‵{||} <span class="id">e2</span> =&gt; ‵{||}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tfor_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tfor_nil_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2563')">Proof.</div>
<div class="proofscript" id="proof2563">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tfor_nil_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="kwd">for</span>/<span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Remove</span> <span class="id">loop</span> <span class="id">comprehensions</span> <span class="id">over</span> <span class="id">empty</span> <span class="id">bags</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tfor_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tfor_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tfor_nil_step</span> <span class="id">tfor_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_singleton_to_let_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCFor</span> <span class="id">x</span> (<span class="id">NNRCUnop</span> <span class="id">AColl</span> <span class="id">e1</span>) <span class="id">e2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NNRCUnop</span> <span class="id">AColl</span> (<span class="id">NNRCLet</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tfor_singleton_to_let_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tfor_singleton_to_let_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2564')">Proof.</div>
<div class="proofscript" id="proof2564">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tfor_singleton_to_let_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_singleton_to_let_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="kwd">for</span>/<span class="id">singleton</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Lower</span> <span class="id">a</span> <span class="id">loop</span> <span class="id">comprehension</span> <span class="id">over</span> <span class="id">a</span> <span class="id">singleton</span> <span class="id">into</span> <span class="id">a</span> <span class="id">singleton</span> <span class="id">of</span> <span class="id">a</span> <span class="kwd">let</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tfor_singleton_to_let_step</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tfor_singleton_to_let_fun</span> .<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_singleton_to_let_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tfor_singleton_to_let_step</span> <span class="id">tfor_singleton_to_let_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_singleton_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| ♯<span class="id">flatten</span>(‵{| <span class="id">e1</span> |}) =&gt; <span class="id">e1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflatten_singleton_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tflatten_singleton_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2565')">Proof.</div>
<div class="proofscript" id="proof2565">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflatten_singleton_nnrc_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_singleton_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">singleton</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">a</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">a</span> <span class="id">singleton</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_singleton_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_singleton_fun</span> .<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_singleton_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_singleton_step</span> <span class="id">tflatten_singleton_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_nil_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| ♯<span class="id">flatten</span>(‵{||}) =&gt; ‵{||}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tflatten_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tflatten_nil_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2566')">Proof.</div>
<div class="proofscript" id="proof2566">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tflatten_nil_nnrc_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">flatten</span>/<span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">flatten</span> <span class="id">of</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tflatten_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tflatten_nil_fun</span> .<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tflatten_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tflatten_nil_step</span> <span class="id">tflatten_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tsigma_to_if_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NNRCUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCFor</span> <span class="id">v1</span> (<span class="id">NNRCUnop</span> <span class="id">AColl</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCIf</span> <span class="id">e1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> <span class="id">AColl</span> (<span class="id">NNRCVar</span> <span class="id">v2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))))) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">v1</span> == <span class="id">v2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> (<span class="id">NNRCLet</span> <span class="id">v1</span> <span class="id">e2</span> (<span class="id">NNRCIf</span> <span class="id">e1</span> (<span class="id">NNRCUnop</span> <span class="id">AColl</span> (<span class="id">NNRCVar</span> <span class="id">v1</span>)) (<span class="id">NNRCConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tsigma_to_if_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tsigma_to_if_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2567')">Proof.</div>
<div class="proofscript" id="proof2567">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tsigma_to_if_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tsigma_to_if_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">sigma</span>/<span class="kwd">if</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tsigma_to_if_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tsigma_to_if_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tsigma_to_if_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tsigma_to_if_step</span> <span class="id">tsigma_to_if_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_sigma_fusion_samevar_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NNRCFor</span> <span class="id">v2</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCFor</span> <span class="id">v1</span> <span class="id">e1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCIf</span> <span class="id">e2</span> (<span class="id">NNRCUnop</span> <span class="id">AColl</span> (<span class="id">NNRCVar</span> <span class="id">v1</span>')) (<span class="id">NNRCConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">e3</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">v1</span> == <span class="id">v1</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">v1</span> == <span class="id">v2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> <span class="id">AFlatten</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCFor</span> <span class="id">v1</span> <span class="id">e1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCIf</span> <span class="id">e2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> <span class="id">AColl</span> <span class="id">e3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmap_sigma_fusion_samevar_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tmap_sigma_fusion_samevar_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2568')">Proof.</div>
<div class="proofscript" id="proof2568">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tmap_sigma_fusion_samevar_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_sigma_fusion_samevar_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">sigma</span>/<span class="id">same</span> <span class="id">var</span> <span class="id">fusion</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmap_sigma_fusion_samevar_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmap_sigma_fusion_samevar_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmap_sigma_fusion_samevar_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmap_sigma_fusion_samevar_step</span> <span class="id">tmap_sigma_fusion_samevar_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_of_rec_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NNRCUnop</span> (<span class="id">ADot</span> <span class="id">s1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">e1</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> (<span class="id">s1</span> == <span class="id">s2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">e1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdot_of_rec_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tdot_of_rec_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2569')">Proof.</div>
<div class="proofscript" id="proof2569">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tdot_of_rec</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_of_rec_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">dot</span>/<span class="id">rec</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">lookup</span> <span class="id">of</span> <span class="id">a</span> <span class="id">new</span> <span class="id">record</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdot_of_rec_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdot_of_rec_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_of_rec_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdot_of_rec_step</span> <span class="id">tdot_of_rec_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_concat_to_concat_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (‵[| (<span class="id">s1</span>, <span class="id">p1</span>)|] ⊗ ‵[| (<span class="id">s2</span>, <span class="id">p2</span>)|])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> (<span class="id">equiv_decb</span> <span class="id">s1</span> <span class="id">s2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> (‵{|‵[| (<span class="id">s1</span>, <span class="id">p1</span>)|] ⊕ ‵[| (<span class="id">s2</span>, <span class="id">p2</span>)|]|})<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tmerge_concat_to_concat_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tmerge_concat_to_concat_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2570')">Proof.</div>
<div class="proofscript" id="proof2570">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">b</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e1</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">u</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e2</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">u</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">equiv_decb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">equiv_dec</span> <span class="id">s</span> <span class="id">s0</span>); <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrc_merge_concat_to_concat_arrow</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_concat_to_concat_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">merge</span>-<span class="id">concat</span>-&gt;<span class="id">merge</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">a</span> <span class="id">merge</span>-<span class="id">concat</span> <span class="id">of</span> <span class="id">two</span> <span class="id">singleton</span> <span class="id">records</span> <span class="kwd">with</span> <span class="id">different</span> <span class="id">fields</span> <span class="kwd">using</span> <span class="id">concat</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tmerge_concat_to_concat_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tmerge_concat_to_concat_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tmerge_concat_to_concat_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tmerge_concat_to_concat_step</span> <span class="id">tmerge_concat_to_concat_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_of_concat_rec_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">NNRCUnop</span> (<span class="id">ADot</span> <span class="id">s</span>) (<span class="id">NNRCBinop</span> <span class="id">AConcat</span> <span class="id">e1</span> (<span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>) <span class="id">e2</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> <span class="id">equiv_decb</span> <span class="id">s</span> <span class="id">s2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">e2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> (<span class="id">NNRCUnop</span> (<span class="id">ADot</span> <span class="id">s</span>) <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tdot_of_concat_rec_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tdot_of_concat_rec_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2571')">Proof.</div>
<div class="proofscript" id="proof2571">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">u</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">b</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e2</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">u</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">equiv_decb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">equiv_dec</span> <span class="id">s</span> <span class="id">s0</span>); <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">e</span>; <span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrc_dot_of_concat_rec_eq_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tnnrc_dot_of_concat_rec_neq_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_of_concat_rec_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">dot</span>/<span class="id">concat</span>/<span class="id">rec</span> 2" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplifies</span> <span class="id">lookup</span> <span class="id">of</span> <span class="id">a</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">record</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tdot_of_concat_rec_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tdot_of_concat_rec_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tdot_of_concat_rec_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tdot_of_concat_rec_step</span> <span class="id">tdot_of_concat_rec_fun_correctness</span>.<br/>
<br/>
<div class="doc">Inlining </div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">is_small_unop</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">u</span>:<span class="id">unaryOp</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">u</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AIdOp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANeg</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AColl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ALeft</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ARight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABrand</span> <span class="id">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ARec</span> <span class="id">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">should_inline_small</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">from</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">from</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCVar</span> <span class="id">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCConst</span> <span class="id">_</span> =&gt; <span class="id">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> <span class="id">u</span> <span class="id">e</span> =&gt; <span class="id">is_small_unop</span> <span class="id">u</span> &amp;&amp; <span class="id">should_inline_small</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCBinop</span> <span class="id">AConcat</span> (<span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">_</span>) <span class="id">e1</span>) (<span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">_</span>) <span class="id">e2</span>) =&gt; <span class="id">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">should_inline_few_occurences</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">x</span>:<span class="id">var</span>) (<span class="id">to</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">use_count</span> <span class="id">x</span> <span class="id">to</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NotUsed</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">UsedOnce</span> =&gt; <span class="id">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">should_inline</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">x</span>:<span class="id">var</span>) (<span class="id">from</span> <span class="id">to</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">should_inline_small</span> <span class="id">from</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| <span class="id">should_inline_few_occurences</span> <span class="id">x</span> <span class="id">to</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tinline_let_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCLet</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">should_inline</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">nnrc_subst</span> (<span class="id">unshadow_simpl</span> (<span class="id">nnrc_free_vars</span> <span class="id">e1</span>) <span class="id">e2</span>) <span class="id">x</span> <span class="id">e1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tinline_let_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tinline_let_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2572')">Proof.</div>
<div class="proofscript" id="proof2572">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tlet_inline_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tinline_let_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="kwd">let</span> <span class="id">inline</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="kwd">Inline</span> <span class="kwd">let</span> <span class="id">statements</span> <span class="id">heuristically</span> <span class="id">deemed</span> <span class="id">suitable</span> <span class="kwd">for</span> <span class="id">inlining</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tinline_let_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tinline_let_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tinline_let_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tinline_let_step</span> <span class="id">tinline_let_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_over_if_nil_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCFor</span> <span class="id">x</span> (<span class="id">NNRCIf</span> <span class="id">e1</span> <span class="id">e2</span> ‵{||}) <span class="id">ebody</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCIf</span> <span class="id">e1</span> (<span class="id">NNRCFor</span> <span class="id">x</span> <span class="id">e2</span> <span class="id">ebody</span>) ‵{||})<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tfor_over_if_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tfor_over_if_nil_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2573')">Proof.</div>
<div class="proofscript" id="proof2573">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tfor_over_if_arrow</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tfor_nil_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_over_if_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="kwd">for</span>/<span class="kwd">if</span>/<span class="kwd">else</span> <span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">loop</span> <span class="id">comprehension</span> <span class="id">over</span> <span class="id">an</span> <span class="kwd">if</span> <span class="id">statement</span> <span class="id">through</span> <span class="id">the</span> <span class="kwd">if</span> <span class="id">statement</span> <span class="id">when</span> <span class="id">the</span> <span class="kwd">else</span> <span class="id">clause</span> <span class="id">just</span> <span class="id">constructs</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tfor_over_if_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tfor_over_if_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_over_if_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tfor_over_if_nil_step</span> <span class="id">tfor_over_if_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_over_either_nil_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  (<span class="id">NNRCFor</span> <span class="id">x</span> (<span class="id">NNRCEither</span> <span class="id">e1</span> <span class="id">xl</span> <span class="id">el</span> <span class="id">xr</span> ‵{||}) <span class="id">ebody</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(    <span class="kwd">let</span> <span class="id">xl</span>' := <span class="id">really_fresh_in</span> <span class="id">nnrc_unshadow_sep</span> <span class="id">xl</span> (<span class="id">nnrc_free_vars</span> <span class="id">el</span> ++ <span class="id">nnrc_bound_vars</span> <span class="id">el</span>) <span class="id">ebody</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCEither</span> <span class="id">e1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">xl</span>' (<span class="id">NNRCFor</span> <span class="id">x</span> (<span class="id">nnrc_subst</span> <span class="id">el</span> <span class="id">xl</span> (<span class="id">NNRCVar</span> <span class="id">xl</span>')) <span class="id">ebody</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">xr</span> ‵{||}))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tfor_over_either_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tfor_over_either_nil_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2574')">Proof.</div>
<div class="proofscript" id="proof2574">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tfor_over_either_arrow</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tfor_nil_arrow</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">tnnrceither_rename_r_arrow</span> <span class="tactic">by</span> <span class="tactic">intuition</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_over_either_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="kwd">for</span>/<span class="id">either</span>/<span class="id">right</span> <span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">loop</span> <span class="id">comprehension</span> <span class="id">over</span> <span class="id">an</span> <span class="id">either</span> <span class="id">statement</span> <span class="id">through</span> <span class="id">the</span> <span class="id">either</span> <span class="id">statement</span> <span class="id">when</span> <span class="id">the</span> <span class="id">right</span> <span class="id">clause</span> <span class="id">just</span> <span class="id">constructs</span> <span class="id">an</span> <span class="id">empty</span> <span class="id">bag</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tfor_over_either_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tfor_over_either_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tfor_over_either_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tfor_over_either_nil_step</span> <span class="id">tfor_over_either_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> <span class="id">op</span> (<span class="id">NNRCEither</span> <span class="id">e1</span> <span class="id">xl</span> <span class="id">el</span> <span class="id">xr</span> (<span class="id">NNRCConst</span> <span class="id">d</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCEither</span> <span class="id">e1</span> <span class="id">xl</span> (<span class="id">NNRCUnop</span> <span class="id">op</span> <span class="id">el</span>) <span class="id">xr</span> (<span class="id">NNRCUnop</span> <span class="id">op</span> (<span class="id">NNRCConst</span> <span class="id">d</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tunop_over_either_const_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tunop_over_either_const_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2575')">Proof.</div>
<div class="proofscript" id="proof2575">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrcunop_over_either_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">unary</span>/<span class="id">either</span>/<span class="id">right</span> <span class="id">const</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">unary</span> <span class="id">operators</span> <span class="id">through</span> <span class="id">either</span> <span class="id">when</span> <span class="id">the</span> <span class="id">right</span> <span class="id">branch</span> <span class="id">is</span> <span class="id">a</span> <span class="id">constant</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tunop_over_either_const_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tunop_over_either_const_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_either_const_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tunop_over_either_const_step</span> <span class="id">tunop_over_either_const_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_if_const_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> <span class="id">op</span> (<span class="id">NNRCIf</span> <span class="id">e1</span> <span class="id">e2</span> (<span class="id">NNRCConst</span> <span class="id">d</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">NNRCIf</span> <span class="id">e1</span> (<span class="id">NNRCUnop</span> <span class="id">op</span> <span class="id">e2</span>) (<span class="id">NNRCUnop</span> <span class="id">op</span> (<span class="id">NNRCConst</span> <span class="id">d</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tunop_over_if_const_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tunop_over_if_const_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2576')">Proof.</div>
<div class="proofscript" id="proof2576">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">e</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrcunop_over_if_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_if_const_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">unary</span>/<span class="kwd">if</span>/<span class="kwd">else</span> <span class="id">const</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">unary</span> <span class="id">operators</span> <span class="id">through</span> <span class="kwd">if</span> <span class="id">when</span> <span class="id">the</span> <span class="kwd">else</span> <span class="id">branch</span> <span class="id">is</span> <span class="id">a</span> <span class="id">constant</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tunop_over_if_const_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tunop_over_if_const_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tunop_over_if_const_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tunop_over_if_const_step</span> <span class="id">tunop_over_if_const_fun_correctness</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_nil_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">nil</span>) <span class="id">e</span>₁<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NNRCConst</span> (<span class="id">drec</span> <span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ᶜ <span class="id">tproject_nil_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2577')">Proof.</div>
<div class="proofscript" id="proof2577">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrcproject_nil</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproject_nil_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">project</span>/<span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">over</span> <span class="id">empty</span> <span class="id">bags</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproject_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproject_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproject_nil_step</span> <span class="id">tproject_nil_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_const_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCConst</span> (<span class="id">drec</span> <span class="id">l</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NNRCConst</span> (<span class="id">drec</span> (<span class="id">rproject</span> <span class="id">l</span> <span class="id">sl</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_const_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ᶜ <span class="id">tproject_over_const_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2578')">Proof.</div>
<div class="proofscript" id="proof2578">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrcproject_over_const</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproject_over_const_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_const_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">project</span>/<span class="id">const</span> <span class="id">rec</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">over</span> <span class="id">constant</span> <span class="id">records</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproject_over_const_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproject_over_const_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_const_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproject_over_const_step</span> <span class="id">tproject_over_const_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_rec_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> <span class="id">in_dec</span> <span class="id">string_dec</span> <span class="id">s</span> <span class="id">sl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₁<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> ‵[||]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_rec_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ᶜ <span class="id">tproject_over_rec_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2579')">Proof.</div>
<div class="proofscript" id="proof2579">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tnnrcproject_over_rec_in</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tnnrcproject_over_rec_nin</span>; <span class="tactic">trivial</span>. <br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproject_over_rec_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_rec_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">project</span>/<span class="id">rec</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">over</span> <span class="id">a</span> <span class="id">record</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproject_over_rec_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproject_over_rec_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_rec_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproject_over_rec_step</span> <span class="id">tproject_over_rec_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_concat_r_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span>₁ (<span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₂))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> <span class="id">in_dec</span> <span class="id">string_dec</span> <span class="id">s</span> <span class="id">sl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">NNRCBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> (<span class="id">remove</span> <span class="id">string_dec</span> <span class="id">s</span> <span class="id">sl</span>)) <span class="id">p</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> (<span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">p</span>₁)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_concat_r_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ᶜ <span class="id">tproject_over_concat_r_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2580')">Proof.</div>
<div class="proofscript" id="proof2580">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tnnrcproject_over_concat_rec_r_in</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tnnrcproject_over_concat_rec_r_nin</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproject_over_concat_r_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_concat_r_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">project</span>/<span class="id">concat</span>/<span class="id">right</span> <span class="id">rec</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">over</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">record</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproject_over_concat_r_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproject_over_concat_r_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_concat_r_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproject_over_concat_r_step</span> <span class="id">tproject_over_concat_r_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_concat_l_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">p</span>₁) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="kwd">if</span> <span class="id">in_dec</span> <span class="id">string_dec</span> <span class="id">s</span> <span class="id">sl</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> (<span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_concat_l_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ᶜ <span class="id">tproject_over_concat_l_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2581')">Proof.</div>
<div class="proofscript" id="proof2581">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrcproject_over_concat_rec_l_nin</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproject_over_concat_l_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_concat_l_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">project</span>/<span class="id">concat</span>/<span class="id">left</span> <span class="id">rec</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Simplify</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">over</span> <span class="id">concatenation</span> <span class="kwd">with</span> <span class="id">a</span> <span class="id">record</span> <span class="id">constructor</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproject_over_concat_l_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproject_over_concat_l_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_concat_l_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproject_over_concat_l_step</span> <span class="id">tproject_over_concat_l_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_project_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl2</span>) <span class="id">p1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> (<span class="id">set_inter</span> <span class="id">string_dec</span> <span class="id">sl2</span> <span class="id">sl1</span>)) <span class="id">p1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_project_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ᶜ <span class="id">tproject_over_project_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2582')">Proof.</div>
<div class="proofscript" id="proof2582">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrcproject_over_nnrcproject</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproject_over_project_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_project_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">project</span>/<span class="id">project</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Fuse</span> <span class="id">nested</span> <span class="id">record</span> <span class="id">projections</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproject_over_project_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproject_over_project_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_project_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproject_over_project_step</span> <span class="id">tproject_over_project_fun_correctness</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_either_fun</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCEither</span> <span class="id">p</span> <span class="id">xl</span> <span class="id">p</span>₁ <span class="id">xr</span> <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">NNRCEither</span> <span class="id">p</span> <span class="id">xl</span> (<span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">p</span>₁) <span class="id">xr</span> (<span class="id">NNRCUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">p</span>₂)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_either_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} <span class="id">p</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> ⇒ᶜ <span class="id">tproject_over_either_fun</span> <span class="id">p</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2583')">Proof.</div>
<div class="proofscript" id="proof2583">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tprove_correctness</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tnnrcproject_over_either</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Hint</span> <span class="id">Rewrite</span> @<span class="id">tproject_over_either_fun_correctness</span> : <span class="id">toptim_correct</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_either_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">project</span>/<span class="id">either</span>/" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Push</span> <span class="id">record</span> <span class="id">projection</span> <span class="id">through</span> <span class="id">either</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tproject_over_either_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tproject_over_either_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tproject_over_either_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tproject_over_either_step</span> <span class="id">tproject_over_either_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_for_either_if_nil_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} (<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (♯<span class="id">count</span>(♯<span class="id">flatten</span>(<span class="id">NNRCFor</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ehead</span> (<span class="id">NNRCEither</span> <span class="id">e1</span> <span class="id">xl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCIf</span> <span class="id">e11</span>(‵{| <span class="id">e12</span>|}) ‵{||}) <span class="id">xr</span> ‵{||}))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; (♯<span class="id">count</span>(♯<span class="id">flatten</span>(<span class="id">NNRCFor</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ehead</span> (<span class="id">NNRCEither</span> <span class="id">e1</span> <span class="id">xl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCIf</span> <span class="id">e11</span>(‵{| ‵(<span class="id">dunit</span>) |}) ‵{||}) <span class="id">xr</span> ‵{||}))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tcount_over_flat_for_either_if_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tcount_over_flat_for_either_if_nil_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2584')">Proof.</div>
<div class="proofscript" id="proof2584">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> (<span class="id">match_destr</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tcount_over_flat_for_either_if_nil_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_for_either_if_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">count</span>/<span class="id">flatten</span>/<span class="kwd">for</span>/<span class="id">either</span>/<span class="id">right</span> <span class="kwd">if</span>/<span class="kwd">else</span> <span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Remove</span> <span class="id">work</span> <span class="id">that</span> <span class="id">is</span> <span class="id">not</span> <span class="id">needed</span> <span class="id">when</span> <span class="id">only</span> <span class="id">the</span> <span class="id">bag</span> <span class="id">count</span> <span class="id">is</span> <span class="id">needed</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tcount_over_flat_for_either_if_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcount_over_flat_for_either_if_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_for_either_if_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tcount_over_flat_for_either_if_nil_step</span> <span class="id">tcount_over_flat_for_either_if_nil_fun_correctness</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_for_either_either_nil_fun</span>  {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}(<span class="id">e</span>:<span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (♯<span class="id">count</span>(♯<span class="id">flatten</span>(<span class="id">NNRCFor</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ehead</span> (<span class="id">NNRCEither</span> <span class="id">e1</span> <span class="id">xl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCEither</span> <span class="id">e11</span> <span class="id">xll</span> (‵{| <span class="id">e12</span>|}) <span class="id">xrr</span> ‵{||}) <span class="id">xr</span> ‵{||}))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; (♯<span class="id">count</span>(♯<span class="id">flatten</span>(<span class="id">NNRCFor</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ehead</span> (<span class="id">NNRCEither</span> <span class="id">e1</span> <span class="id">xl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NNRCEither</span> <span class="id">e11</span> <span class="id">xll</span> (‵{| ‵(<span class="id">dunit</span>) |}) <span class="id">xrr</span> ‵{||}) <span class="id">xr</span> ‵{||}))))<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tcount_over_flat_for_either_either_nil_fun_correctness</span> {<span class="id">model</span>:<span class="id">basic_model</span>} (<span class="id">e</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">e</span> (<span class="id">tcount_over_flat_for_either_either_nil_fun</span> <span class="id">e</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2585')">Proof.</div>
<div class="proofscript" id="proof2585">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> (<span class="id">match_destr</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tcount_over_flat_for_either_either_nil_arrow</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_for_either_either_nil_step</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStep</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">count</span>/<span class="id">flatten</span>/<span class="kwd">for</span>/<span class="id">either</span>/<span class="id">right</span> <span class="id">either</span>/<span class="id">right</span> <span class="id">nil</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Remove</span> <span class="id">work</span> <span class="id">that</span> <span class="id">is</span> <span class="id">not</span> <span class="id">needed</span> <span class="id">when</span> <span class="id">only</span> <span class="id">the</span> <span class="id">bag</span> <span class="id">count</span> <span class="id">is</span> <span class="id">needed</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">tcount_over_flat_for_either_either_nil_fun</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tcount_over_flat_for_either_either_nil_fun</span> .<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tcount_over_flat_for_either_either_nil_step_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">mkOptimizerStepModel</span> <span class="id">tcount_over_flat_for_either_either_nil_step</span> <span class="id">tcount_over_flat_for_either_either_nil_fun_correctness</span>.  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnnrc_optim_list</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} : <span class="id">list</span> (@<span class="id">OptimizerStep</span> <span class="id">nnrc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= [<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tfor_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tfor_singleton_to_let_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tsigma_to_if_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_sigma_fusion_samevar_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_of_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_concat_to_concat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_of_concat_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tinline_let_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tfor_over_if_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tfor_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tunop_over_either_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tunop_over_if_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_concat_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_concat_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_project_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_either_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_for_either_if_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_for_either_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;].<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnnrc_optim_model_list</span> {<span class="id">model</span>:<span class="id">basic_model</span>} : <span class="id">list</span> (<span class="id">OptimizerStepModel</span> <span class="id">tnnrc_ext_rewrites_to</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= [<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tfor_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tfor_singleton_to_let_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_singleton_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tflatten_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tsigma_to_if_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmap_sigma_fusion_samevar_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_of_rec_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tmerge_concat_to_concat_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tdot_of_concat_rec_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tinline_let_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tfor_over_if_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tfor_over_either_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tunop_over_either_const_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tunop_over_if_const_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_const_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_rec_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_concat_r_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_concat_l_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_project_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tproject_over_either_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_for_either_if_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">tcount_over_flat_for_either_either_nil_step_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;].<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnnrc_optim_model_list_complete</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">optim_model_list_complete</span> <span class="id">tnnrc_optim_list</span> <span class="id">tnnrc_optim_model_list</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2586')">Proof.</div>
<div class="proofscript" id="proof2586">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">optim_correct_list_complete_prover</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">tnnrc_optim_list_correct</span> {<span class="id">model</span>:<span class="id">basic_model</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">optim_list_correct</span> <span class="id">tnnrc_ext_rewrites_to</span> <span class="id">tnnrc_optim_list</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">optim_list_correct_from_model</span> <span class="id">tnnrc_optim_model_list_complete</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">tnnrc_optim_list_distinct</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">optim_list_distinct</span> <span class="id">tnnrc_optim_list</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2587')">Proof.</div>
<div class="proofscript" id="proof2587">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">optim_list_distinct_prover</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vm_compute</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">eq_refl</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">run_nnrc_optims</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nnrc</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">opc</span>:<span class="id">optim_phases_config</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">nnrc</span> -&gt; <span class="id">nnrc</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">run_phases</span> <span class="id">tnnrc_map_deep</span> <span class="id">NNRCSize.nnrc_size</span> <span class="id">tnnrc_optim_list</span> <span class="id">opc</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">run_nnrc_optims_correctness</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">model</span>:<span class="id">basic_model</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nnrc</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">opc</span>:<span class="id">optim_phases_config</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">p</span>:<span class="id">nnrc</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">p</span> (<span class="id">run_nnrc_optims</span> <span class="id">opc</span> <span class="id">p</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2588')">Proof.</div>
<div class="proofscript" id="proof2588">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">run_nnrc_optims</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">run_phases_correctness</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">tnnrc_map_deep_correctness</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">tnnrc_optim_list_correct</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">default</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrc_default_optim_list</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} : <span class="id">list</span> <span class="id">string</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= [<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">optim_step_name</span> <span class="id">tinline_let_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_for_either_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tcount_over_flat_for_either_if_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmerge_concat_to_concat_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_of_concat_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tdot_of_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_singleton_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tflatten_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tfor_singleton_to_let_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tunop_over_either_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tunop_over_if_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tfor_over_either_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tfor_over_if_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tfor_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tmap_sigma_fusion_samevar_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproject_nil_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproject_over_const_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproject_over_rec_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproject_over_concat_r_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproject_over_concat_l_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproject_over_project_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id">optim_step_name</span> <span class="id">tproject_over_either_step</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Remark</span> <span class="id">nnrc_default_optim_list_all_valid</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">valid_optims</span> <span class="id">tnnrc_optim_list</span> <span class="id">nnrc_default_optim_list</span> = (<span class="id">nnrc_default_optim_list</span>,<span class="id">nil</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2589')">Proof.</div>
<div class="proofscript" id="proof2589">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vm_compute</span>; <span class="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">default_nnrc_optim_phases</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;("[<span class="id">nnrc</span>] <span class="id">default</span>"%<span class="id">string</span>,<span class="id">nnrc_default_optim_list</span>,10)::<span class="id">nil</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">default</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">run_nnrc_optims_default</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nnrc</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">run_nnrc_optims</span> <span class="id">default_nnrc_optim_phases</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">run_nnrc_optims_default_correct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">model</span>:<span class="id">basic_model</span>} {<span class="id">logger</span>:<span class="id">optimizer_logger</span> <span class="id">string</span> <span class="id">nnrc</span>} <span class="id">p</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tnnrc_ext_rewrites_to</span> <span class="id">p</span> (<span class="id">run_nnrc_optims_default</span> <span class="id">p</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2590')">Proof.</div>
<div class="proofscript" id="proof2590">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">run_nnrc_optims_default</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">run_nnrc_optims_correctness</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">NNRCOptimizer</span>.<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</div>
</body>
</html>
