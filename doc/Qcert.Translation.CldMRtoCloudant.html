
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Qcert.Translation.CldMRtoCloudant</title>
<meta name="description" content="Documentation of Coq module Qcert.Translation.CldMRtoCloudant" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Qcert.Translation.CldMRtoCloudant</h1>
<div class="coq">
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">List</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Utils</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">BasicRuntime</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ForeignToJavaScript</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ForeignCloudant</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCRuntime</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">CldMRRuntime</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">CloudantRuntime</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCtoJavaScript</span>.<br/>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string_scope</span>.<br/>
<br/>
<span class="kwd">Section</span> <span class="id">CldMRtoCloudant</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">ftojavascript</span>:<span class="id">foreign_to_javascript</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fcloudant</span>:<span class="id">foreign_cloudant</span>}.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">MRJS</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">emitIdToString</span> (<span class="id">vkey</span> <span class="id">vout</span>:<span class="id">string</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"  <span class="id">emit</span>(" ++ <span class="id">vkey</span> ++ ", " ++ <span class="id">vout</span> ++ ");" ++ <span class="id">eol</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">emitConstIdToString</span> (<span class="id">n</span>:<span class="id">nat</span>) (<span class="id">vkey</span> <span class="id">vout</span>:<span class="id">string</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"  <span class="id">emit</span>(" ++ (<span class="id">nat_to_string10</span> <span class="id">n</span>) ++ ", " ++ <span class="id">vout</span> ++ ");" ++ <span class="id">eol</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">emitConstToString</span> (<span class="id">n</span>:<span class="id">nat</span>) (<span class="id">vkey</span> <span class="id">vout</span>:<span class="id">string</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"  <span class="kwd">for</span> (<span class="id">var</span> <span class="id">srcout</span>="<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">vout</span> ++ ", <span class="id">iout</span>=0; <span class="id">iout</span>&lt;" ++ <span class="id">vout</span> ++ ".<span class="id">length</span>; <span class="id">iout</span>++) {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "    <span class="id">emit</span>(" ++ (<span class="id">nat_to_string10</span> <span class="id">n</span>) ++ ",<span class="id">srcout</span>[<span class="id">iout</span>]);" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  }" ++ <span class="id">eol</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">emitInventToString</span> (<span class="id">vkey</span> <span class="id">vout</span>:<span class="id">string</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"  <span class="kwd">for</span> (<span class="id">var</span> <span class="id">srcout</span>="<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">vout</span> ++ ", <span class="id">iout</span>=0; <span class="id">iout</span>&lt;" ++ <span class="id">vout</span> ++ ".<span class="id">length</span>; <span class="id">iout</span>++) {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "    <span class="id">emit</span>(" ++ <span class="id">vkey</span> ++ ".<span class="id">concat</span>(<span class="id">iout</span>),<span class="id">srcout</span>[<span class="id">iout</span>]);" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  }" ++ <span class="id">eol</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">createMapFunFirst</span> (<span class="id">v_map</span>:<span class="id">string</span>) (<span class="id">e</span>:<span class="id">nnrc</span>) (<span class="id">emitString</span>:<span class="id">string</span>) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">j0</span>, <span class="id">v0</span>, <span class="id">t0</span>) := <span class="id">nnrcToJSunshadow</span> <span class="id">e</span> 1 1 <span class="id">eol</span> <span class="id">quotel</span> (<span class="id">v_map</span>::<span class="id">nil</span>) ((<span class="id">v_map</span>,"<span class="id">doc</span>")::<span class="id">nil</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">function</span> (<span class="id">doc</span>) {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="id">var</span> <span class="id">v0</span> = <span class="id">null</span>;" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="id">var</span> <span class="id">key</span> = <span class="id">doc._id</span>;" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="id">var</span> <span class="id">doc</span> = <span class="id">unwrap</span>(<span class="id">doc</span>);" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="kwd">if</span> (<span class="id">doc</span> != <span class="id">null</span>) {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">j0</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="id">var</span> <span class="id">out</span> = " ++ <span class="id">v0</span> ++ ";" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">emitString</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  }"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<span class="kwd">if</span> <span class="id">harness</span> <span class="kwd">then</span> " %<span class="id">HARNESS</span>% " <span class="kwd">else</span> "")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "}".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">createMapFunRest</span> (<span class="id">v_map</span>:<span class="id">string</span>) (<span class="id">e</span>:<span class="id">nnrc</span>) (<span class="id">emitString</span>:<span class="id">string</span>) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">j0</span>, <span class="id">v0</span>, <span class="id">t0</span>) := <span class="id">nnrcToJSunshadow</span> <span class="id">e</span> 1 1 <span class="id">eol</span> <span class="id">quotel</span> (<span class="id">v_map</span>::<span class="id">nil</span>) ((<span class="id">v_map</span>,"<span class="id">doc</span>")::<span class="id">nil</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">function</span> (<span class="id">doc</span>) {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="id">var</span> <span class="id">v0</span> = <span class="id">null</span>;" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="id">var</span> <span class="id">key</span> = <span class="id">doc.key</span>;" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="id">var</span> <span class="id">doc</span> = <span class="id">doc.value</span>;" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">j0</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="id">var</span> <span class="id">out</span> = " ++ <span class="id">v0</span> ++ ";" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">emitString</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<span class="kwd">if</span> <span class="id">harness</span> <span class="kwd">then</span> " %<span class="id">HARNESS</span>% " <span class="kwd">else</span> "")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "}".<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcToJSMapFirst</span> (<span class="id">cldmap</span>:<span class="id">cld_map</span>) (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">map_fun</span> <span class="id">cldmap</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldMapId</span> (<span class="id">v_map</span>, <span class="id">e</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">map_emit</span> <span class="id">cldmap</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldEmitDist</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">createMapFunFirst</span> <span class="id">v_map</span> <span class="id">e</span> (<span class="id">emitIdToString</span> "<span class="id">key</span>" "<span class="id">out</span>" <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldEmitCollect</span> <span class="id">index</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">createMapFunFirst</span> <span class="id">v_map</span> <span class="id">e</span> (<span class="id">emitConstIdToString</span> <span class="id">index</span> "<span class="id">key</span>" "<span class="id">out</span>" <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldMapFlatten</span> (<span class="id">v_map</span>, <span class="id">e</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">map_emit</span> <span class="id">cldmap</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldEmitDist</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">createMapFunFirst</span> <span class="id">v_map</span> <span class="id">e</span> (<span class="id">emitInventToString</span> "<span class="id">key</span>" "<span class="id">out</span>" <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldEmitCollect</span> <span class="id">index</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">createMapFunFirst</span> <span class="id">v_map</span> <span class="id">e</span> (<span class="id">emitConstToString</span> <span class="id">index</span> "<span class="id">key</span>" "<span class="id">out</span>" <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcToJSMapRest</span> (<span class="id">cldmap</span>:<span class="id">cld_map</span>) (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">map_fun</span> <span class="id">cldmap</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldMapId</span> (<span class="id">v_map</span>, <span class="id">e</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">map_emit</span> <span class="id">cldmap</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldEmitDist</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">createMapFunRest</span> <span class="id">v_map</span> <span class="id">e</span> (<span class="id">emitIdToString</span> "<span class="id">key</span>" "<span class="id">out</span>" <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldEmitCollect</span> <span class="id">index</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">createMapFunRest</span> <span class="id">v_map</span> <span class="id">e</span> (<span class="id">emitConstIdToString</span> <span class="id">index</span> "<span class="id">key</span>" "<span class="id">out</span>" <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldMapFlatten</span> (<span class="id">v_map</span>, <span class="id">e</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">map_emit</span> <span class="id">cldmap</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldEmitDist</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">createMapFunRest</span> <span class="id">v_map</span> <span class="id">e</span> (<span class="id">emitInventToString</span> "<span class="id">key</span>" "<span class="id">out</span>" <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldEmitCollect</span> <span class="id">index</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">createMapFunRest</span> <span class="id">v_map</span> <span class="id">e</span> (<span class="id">emitConstToString</span> <span class="id">index</span> "<span class="id">key</span>" "<span class="id">out</span>" <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcToJSReduce</span> (<span class="id">e1</span>:<span class="id">nnrc</span>) (<span class="id">e2</span>:<span class="id">nnrc</span>) (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) (<span class="id">values_iv</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">j0</span>, <span class="id">v0</span>, <span class="id">t0</span>) := <span class="id">nnrcToJSunshadow</span> <span class="id">e1</span> 1 1 <span class="id">eol</span> <span class="id">quotel</span> (<span class="id">values_iv</span>::<span class="id">nil</span>) ((<span class="id">values_iv</span>,"<span class="id">values</span>")::<span class="id">nil</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">j1</span>, <span class="id">v1</span>, <span class="id">t1</span>) := <span class="id">nnrcToJSunshadow</span> <span class="id">e2</span> <span class="id">t0</span> 1 <span class="id">eol</span> <span class="id">quotel</span> (<span class="id">values_iv</span>::<span class="id">nil</span>) ((<span class="id">values_iv</span>,"<span class="id">values</span>")::<span class="id">nil</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">function</span> (<span class="id">keys</span>, <span class="id">values</span>, <span class="id">rereduce</span>) {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="kwd">if</span> (<span class="id">rereduce</span>) {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">j1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "    <span class="kwd">return</span> " ++ <span class="id">v1</span> ++ ";" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  }" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  <span class="kwd">else</span> {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">j0</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "    <span class="kwd">return</span> " ++ <span class="id">v0</span> ++ ";" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "  }" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<span class="kwd">if</span> <span class="id">harness</span> <span class="kwd">then</span> " %<span class="id">HARNESS</span>% " <span class="kwd">else</span> "")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "}".<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">idJSReduce</span> (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">function</span> (<span class="id">keys</span>, <span class="id">values</span>, <span class="id">rereduce</span>) {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "   <span class="kwd">return</span> <span class="id">values</span>[0];" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "}".<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcToJSDefault</span> (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">e_def</span>:<span class="id">nnrc</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">j0</span>, <span class="id">v0</span>, <span class="id">t0</span>) := <span class="id">nnrcToJSunshadow</span> <span class="id">e_def</span> 1 1 <span class="id">eol</span> <span class="id">quotel</span> <span class="id">nil</span> <span class="id">nil</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcToJSFunStub</span> <span class="id">harness</span> <span class="id">e_def</span> <span class="id">eol</span> <span class="id">quotel</span> <span class="id">nil</span> "<span class="id">db_default</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nnrcToJSGen</span> (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">e_closure</span>:(<span class="id">list</span> <span class="id">var</span>) * <span class="id">nnrc</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">params</span>, <span class="id">e</span>) := <span class="id">e_closure</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcToJSFunStub</span> <span class="id">harness</span> <span class="id">e</span> <span class="id">eol</span> <span class="id">quotel</span> <span class="id">params</span> "<span class="id">db_post</span>".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mapReduceStringstoJS_pair</span> (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">index</span>:<span class="id">nat</span>) (<span class="id">mr</span>:<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mr</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">i</span>,<span class="id">o</span>,<span class="id">def</span>,<span class="id">None</span>,<span class="id">m</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">iname</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">i</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">INPUT</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">s</span> =&gt; <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">oname</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">o</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">RESULT</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">s</span> =&gt; <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"// <span class="id">Input</span> <span class="id">DB</span>: " ++ <span class="id">iname</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "// <span class="id">Output</span> <span class="id">DB</span>: " ++ <span class="id">oname</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "// <span class="id">Map</span> <span class="id">Nb</span> " ++ (<span class="id">nat_to_string10</span> <span class="id">index</span>) ++ <span class="id">eol</span> ++ <span class="id">m</span> ++ <span class="id">eol</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">i</span>,<span class="id">o</span>,<span class="id">def</span>, <span class="id">Some</span> <span class="id">r</span>, <span class="id">m</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">iname</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">i</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">INPUT</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">s</span> =&gt; <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">oname</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">o</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">RESULT</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">s</span> =&gt; <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"// <span class="id">Input</span> <span class="id">DB</span>: " ++ <span class="id">iname</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "// <span class="id">Output</span> <span class="id">DB</span>: " ++ <span class="id">oname</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "// <span class="id">Map</span> <span class="id">Nb</span> " ++ (<span class="id">nat_to_string10</span> <span class="id">index</span>) ++ <span class="id">eol</span> ++ <span class="id">m</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "// <span class="id">Reduce</span> <span class="id">Nb</span> " ++ (<span class="id">nat_to_string10</span> <span class="id">index</span>) ++ <span class="id">eol</span> ++ <span class="id">r</span> ++ <span class="id">eol</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mapReduceStringstoJS</span> (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">mrp</span>:<span class="id">list</span> (<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>)) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fst</span> (<span class="id">fold_right</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">y</span> =&gt; (<span class="id">append</span> (<span class="id">mapReduceStringstoJS_pair</span> <span class="id">eol</span> (<span class="id">snd</span> <span class="id">y</span>) <span class="id">x</span>) (<span class="id">fst</span> <span class="id">y</span>), <span class="id">S</span> (<span class="id">snd</span> <span class="id">y</span>))) ("",0) <span class="id">mrp</span>).<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">MRJS</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">CloudantJS</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">cldmrToJS</span> (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">ini</span>:<span class="id">bool</span>) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) (<span class="id">mr</span>:<span class="id">cldmr_step</span>) : <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">v_input</span> := <span class="id">cldmr_step_input</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">vs_input</span> := <span class="id">Some</span> <span class="id">v_input</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">cldmap</span> := <span class="id">cldmr_step_map</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">clddefault</span> := <span class="id">cldmr_step_reduce_default</span> <span class="id">mr</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">map_string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">ini</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">nnrcToJSMapFirst</span> <span class="id">cldmap</span> <span class="id">h</span> <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">nnrcToJSMapRest</span> <span class="id">cldmap</span> <span class="id">h</span> <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">default_string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">clddefault</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">clddef</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">nnrcToJSDefault</span> <span class="id">harness</span> <span class="id">clddef</span> <span class="id">eol</span> <span class="id">quotel</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">cldmr_step_reduce</span> <span class="id">mr</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">vs_input</span>, <span class="id">None</span>, <span class="id">default_string</span>, <span class="id">None</span>, <span class="id">map_string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">mred</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">v_output</span> := <span class="id">reduce_output</span> <span class="id">mred</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">vs_output</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">v_output</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">v</span> =&gt; <span class="id">Some</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mred</span>.(<span class="id">reduce_fun</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldRedId</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">reduce_string</span> := <span class="id">idJSReduce</span> <span class="id">h</span> <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">vs_input</span>, <span class="id">vs_output</span>, <span class="id">default_string</span>, <span class="id">Some</span> <span class="id">reduce_string</span>, <span class="id">map_string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldRedAggregate</span> (<span class="id">vs_reduce</span>, <span class="id">f_reduce</span>) (<span class="id">v_rereduce</span>, <span class="id">f_rereduce</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">v_key</span>, <span class="id">v_reduce</span>) := <span class="id">vs_reduce</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">reduce_string</span> := <span class="id">nnrcToJSReduce</span> <span class="id">f_reduce</span> <span class="id">f_rereduce</span> <span class="id">h</span> <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span> <span class="id">v_reduce</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">vs_input</span>, <span class="id">vs_output</span>, <span class="id">default_string</span>, <span class="id">Some</span> <span class="id">reduce_string</span>, <span class="id">map_string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldRedOp</span> <span class="id">CldRedOpCount</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">vs_input</span>, <span class="id">vs_output</span>, <span class="id">default_string</span>, <span class="id">Some</span> "<span class="id">_count</span>", <span class="id">map_string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldRedOp</span> (<span class="id">CldRedOpSum</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">vs_input</span>, <span class="id">vs_output</span>, <span class="id">default_string</span>, <span class="id">Some</span> "<span class="id">_sum</span>", <span class="id">map_string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CldRedOp</span> (<span class="id">CldRedOpStats</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">vs_input</span>, <span class="id">vs_output</span>, <span class="id">default_string</span>, <span class="id">Some</span> "<span class="id">_stats</span>", <span class="id">map_string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">cld_mr_chainToJS</span> (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) (<span class="id">mrl</span>:<span class="id">list</span> <span class="id">cldmr_step</span>) : <span class="id">list</span> (<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mrl</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">nil</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">mr1</span> :: <span class="id">mrl</span>' =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">cldmrToJS</span> <span class="id">h</span> <span class="id">true</span> <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span> <span class="id">mr1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<span class="id">map</span> (<span class="id">cldmrToJS</span> <span class="id">h</span> <span class="id">false</span> <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span>) <span class="id">mrl</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">cld_mrToJS</span> (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) (<span class="id">mrl</span>:<span class="id">cldmr</span>) : <span class="id">list</span> (<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cld_mr_chainToJS</span> <span class="id">h</span> <span class="id">harness</span> <span class="id">eol</span> <span class="id">quotel</span> <span class="id">mrl</span>.(<span class="id">cldmr_chain</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">cld_mrToLastJS</span> (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">harness</span>:<span class="id">bool</span>) (<span class="id">eol</span>:<span class="id">string</span>) (<span class="id">quotel</span>:<span class="id">string</span>) (<span class="id">e_closure</span>: (<span class="id">list</span> <span class="id">var</span>) * <span class="id">nnrc</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nnrcToJSGen</span> <span class="id">harness</span> <span class="id">e_closure</span> <span class="id">eol</span> <span class="id">quotel</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">buildDesignDoc</span> (<span class="id">view_name</span>:<span class="id">string</span>) (<span class="id">s_map</span>:<span class="id">string</span>) (<span class="id">s_reduce</span>:<span class="id">option</span> <span class="id">string</span>) (<span class="id">s_dboutput</span>:<span class="id">option</span> <span class="id">string</span>) (<span class="id">s_dbdefault</span>:<span class="id">option</span> <span class="id">string</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dmap</span> := ("<span class="id">map</span>", <span class="id">dstring</span> <span class="id">s_map</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dreduce</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">s_reduce</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">s_r</span> =&gt; ("<span class="id">reduce</span>", <span class="id">dstring</span> <span class="id">s_r</span>)::<span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dbcopy</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">s_dboutput</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">s_db</span> =&gt; ("<span class="id">dbcopy</span>", <span class="id">dstring</span> (<span class="id">view_name</span> ++ <span class="id">s_db</span>))::<span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dbdefault</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">s_dbdefault</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">s_dbd</span> =&gt; ("<span class="id">dbdefault</span>", <span class="id">dstring</span> <span class="id">s_dbd</span>)::<span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">drec</span> (("<span class="id">views</span>", <span class="id">drec</span> ((<span class="id">view_name</span>, <span class="id">drec</span> (<span class="id">dmap</span>::(<span class="id">List.app</span> <span class="id">dreduce</span> (<span class="id">List.app</span> <span class="id">dbcopy</span> <span class="id">dbdefault</span>))))::<span class="id">nil</span>))::<span class="id">nil</span>).<br/>
<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">db_of_var</span> (<span class="id">rulename</span>:<span class="id">string</span>) (<span class="id">var</span>:<span class="id">string</span>) : <span class="id">string</span> := <span class="id">rulename</span> ++ <span class="id">var</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">makeInputDB</span> (<span class="id">rulename</span>:<span class="id">string</span>) (<span class="id">ins</span>: <span class="id">option</span> <span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">ins</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">rulename</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">x</span> =&gt; <span class="id">db_of_var</span> <span class="id">rulename</span> <span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">makeInputDesignDoc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">quotel</span>:<span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">rulename</span>:<span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mrp</span>:<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">cloudant_design</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mrp</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">inputdb</span>, <span class="id">outputdb</span>, <span class="id">defaultdb</span>, <span class="id">mreduce</span>, <span class="id">mmap</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">view_name</span> := <span class="id">rulename</span> <span class="kwd">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkCloudantDesign</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">makeInputDB</span> <span class="id">rulename</span> <span class="id">None</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">view_name</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">dataToJS</span> <span class="id">quotel</span> (<span class="id">buildDesignDoc</span> <span class="id">view_name</span> <span class="id">mmap</span> <span class="id">mreduce</span> <span class="id">outputdb</span> <span class="id">defaultdb</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">makeDesignDoc</span> (<span class="id">quotel</span>:<span class="id">string</span>) (<span class="id">rulename</span>:<span class="id">string</span>) (<span class="id">mrp</span>:<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>) : <span class="id">cloudant_design</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mrp</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">inputdb</span>, <span class="id">outputdb</span>, <span class="id">defaultdb</span>, <span class="id">mreduce</span>, <span class="id">mmap</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">view_name</span> := <span class="id">rulename</span> <span class="kwd">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkCloudantDesign</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">makeInputDB</span> <span class="id">rulename</span> <span class="id">inputdb</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">view_name</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">dataToJS</span> <span class="id">quotel</span> (<span class="id">buildDesignDoc</span> <span class="id">view_name</span> <span class="id">mmap</span> <span class="id">mreduce</span> <span class="id">outputdb</span> <span class="id">defaultdb</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">makeCloudantDesignDocs</span> (<span class="id">quotel</span>:<span class="id">string</span>) (<span class="id">rulename</span>:<span class="id">string</span>) (<span class="id">mrp</span>:<span class="id">list</span> (<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>)) : <span class="id">list</span> <span class="id">cloudant_design</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">List.map</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">makeDesignDoc</span> <span class="id">quotel</span> <span class="id">rulename</span> <span class="id">x</span>) <span class="id">mrp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">makeCloudantDesignDocsTop</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">quotel</span>:<span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">rulename</span>:<span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">mrp</span>:<span class="id">list</span> (<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">last_expr</span>:<span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">cld_eff</span>:<span class="id">list</span> <span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">cloudant</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mrp</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkCloudant</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">last_expr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cld_eff</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">x</span> :: <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkCloudant</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">makeInputDesignDoc</span> <span class="id">quotel</span> <span class="id">rulename</span> <span class="id">x</span>) :: <span class="id">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">last_expr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cld_eff</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">x</span> :: <span class="id">mrp</span>' =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mkCloudant</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">makeInputDesignDoc</span> <span class="id">quotel</span> <span class="id">rulename</span> <span class="id">x</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<span class="id">makeCloudantDesignDocs</span> <span class="id">quotel</span> <span class="id">rulename</span> <span class="id">mrp</span>'))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">last_expr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cld_eff</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">makeOneCurl</span> (<span class="id">mrp</span>: <span class="id">string</span>*<span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mrp</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">dbname</span>,<span class="id">design</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">curl</span> -<span class="id">X</span> <span class="id">PUT</span> ""<span class="id">https</span>://<span class="id">fe0a4004</span>-9<span class="id">ff8</span>-4<span class="id">bc4</span>-9<span class="id">de8</span>-906<span class="id">e1831cc78</span>-<span class="id">bluemix</span>:8<span class="id">a67972aa73304b3b7cc9b0cc4525d2e6c26988dd08c787ae29d5d68079c0b54</span>@<span class="id">fe0a4004</span>-9<span class="id">ff8</span>-4<span class="id">bc4</span>-9<span class="id">de8</span>-906<span class="id">e1831cc78</span>-<span class="id">bluemix.cloudant.com</span>/" ++ <span class="id">dbname</span> ++ "/<span class="id">_design</span>/" ++ <span class="id">dbname</span> ++ """ -<span class="id">H</span> '<span class="id">Content</span>-<span class="id">type</span>: <span class="id">application</span>/<span class="id">json</span>' -<span class="id">d</span> '" ++ <span class="id">design</span> ++ "'" ++ <span class="id">eol_newline</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">mapReduceStringstoDesignDocs</span> (<span class="id">mrp</span>:<span class="id">list</span> (<span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">option</span> <span class="id">string</span> * <span class="id">string</span>)) (<span class="id">last_expr</span>:<span class="id">string</span>) (<span class="id">cld_eff</span>:<span class="id">list</span> <span class="id">string</span>) (<span class="id">rulename</span>:<span class="id">string</span>) : <span class="id">cloudant</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">makeCloudantDesignDocsTop</span> <span class="id">quotel_double</span> <span class="id">rulename</span> <span class="id">mrp</span> <span class="id">last_expr</span> <span class="id">cld_eff</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">cld_mrParamsLast</span> (<span class="id">rulename</span>:<span class="id">string</span>) (<span class="id">params</span>:<span class="id">list</span> <span class="id">var</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">map</span> (<span class="id">db_of_var</span> <span class="id">rulename</span>) <span class="id">params</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">cldmr_to_cloudant_top</span> (<span class="id">h</span>:<span class="id">list</span> (<span class="id">string</span>*<span class="id">string</span>)) (<span class="id">mrl</span> : <span class="id">cldmr</span>) (<span class="id">rulename</span>:<span class="id">string</span>) : <span class="id">cloudant</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">mrpl</span> := <span class="id">cld_mrToJS</span> <span class="id">h</span> <span class="id">true</span> <span class="id">eol_backn</span> <span class="id">quotel_double</span> <span class="id">mrl</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">last_fun</span> := <span class="id">cld_mrToLastJS</span> <span class="id">h</span> <span class="id">true</span> <span class="id">eol_backn</span> <span class="id">quotel_backdouble</span> (<span class="id">fst</span> (<span class="id">mrl</span>.(<span class="id">cldmr_last</span>))) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">cld_eff_params</span> := <span class="id">cld_mrParamsLast</span> <span class="id">rulename</span> (<span class="id">snd</span> (<span class="id">mrl</span>.(<span class="id">cldmr_last</span>))) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mapReduceStringstoDesignDocs</span> <span class="id">mrpl</span> <span class="id">last_fun</span> <span class="id">cld_eff_params</span> <span class="id">rulename</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">CloudantJS</span>.<br/>
&nbsp;&nbsp;<br/>
<span class="kwd">End</span> <span class="id">CldMRtoCloudant</span>.<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</div>
</body>
</html>
