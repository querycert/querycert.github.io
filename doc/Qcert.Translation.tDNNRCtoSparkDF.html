
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Qcert.Translation.tDNNRCtoSparkDF</title>
<meta name="description" content="Documentation of Coq module Qcert.Translation.tDNNRCtoSparkDF" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Qcert.Translation.tDNNRCtoSparkDF</h1>
<div class="coq">
<br/>
<span class="kwd">Section</span> <span class="id">Helpers</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">eol</span> := <span class="id">String</span> (<span class="id">Ascii.ascii_of_nat</span> 10) <span class="id">EmptyString</span>.<br/>
<span class="kwd">End</span> <span class="id">Helpers</span>.<br/>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">List</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Peano_dec</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">EquivDec</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">BasicSystem</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">NNRCRuntime</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">tDNNRCSystem</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ForeignToScala</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">DatatoSparkDF</span>.<br/>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string_scope</span>.<br/>
<br/>
<span class="kwd">Section</span> <span class="id">tDNNRCtoSparkDF</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">f</span>:<span class="id">foreign_runtime</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">h</span>:<span class="id">brand_relation_t</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">ftype</span>:<span class="id">foreign_type</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">m</span>:<span class="id">brand_model</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fdtyping</span>:<span class="id">foreign_data_typing</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fboptyping</span>:<span class="id">foreign_binary_op_typing</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fuoptyping</span>:<span class="id">foreign_unary_op_typing</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fttjs</span>: <span class="id">ForeignToJavaScript.foreign_to_javascript</span>}.<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fts</span>: <span class="id">ForeignToScala.foreign_to_scala</span>}.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">quote_string</span> (<span class="id">s</span>: <span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;"""" ++ <span class="id">s</span> ++ """".<br/>
<br/>
<div class="doc">Get code for a Spark DataType corresping to an rtype.
   *
   * These are things like StringType, ArrayType(...), StructType(Seq(FieldType(...), ...)), ...
   *
   * This function encodes details of our data representation, e.g. records are StructFields
   * with two toplevel fields $blob and $known, and the $known contains a record with the
   * statically known fields and their types.
   </div>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">rtype_to_spark_DataType</span> (<span class="id">r</span>: <span class="id">rtype</span>₀) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">r</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Bottom</span>₀ =&gt; "<span class="id">NullType</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Top</span>₀ =&gt; "<span class="id">StringType</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Unit</span>₀ =&gt; "<span class="id">NullType</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Nat</span>₀ =&gt; "<span class="id">LongType</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Bool</span>₀ =&gt; "<span class="id">BooleanType</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">String</span>₀ =&gt; "<span class="id">StringType</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Coll</span>₀ <span class="id">e</span> =&gt; "<span class="id">ArrayType</span>(" ++ <span class="id">rtype_to_spark_DataType</span> <span class="id">e</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Rec</span>₀ <span class="id">_</span> <span class="id">fields</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">known_fields</span>: <span class="id">list</span> <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">map</span> (<span class="kwd">fun</span> <span class="id">p</span> =&gt; "<span class="id">StructField</span>(""" ++ <span class="id">fst</span> <span class="id">p</span> ++ """, " ++ <span class="id">rtype_to_spark_DataType</span> (<span class="id">snd</span> <span class="id">p</span>) ++ ")")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fields</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">known_struct</span> := "<span class="id">StructType</span>(<span class="id">Seq</span>(" ++ <span class="id">joinStrings</span> ", " <span class="id">known_fields</span> ++ "))" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">StructType</span>(<span class="id">Seq</span>(<span class="id">StructField</span>(""$<span class="id">blob</span>"", <span class="id">StringType</span>), <span class="id">StructField</span>(""$<span class="id">known</span>"", " ++ <span class="id">known_struct</span> ++ ")))"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Either</span>₀ <span class="id">l</span> <span class="id">r</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">StructType</span>(<span class="id">Seq</span>(<span class="id">StructField</span>(""$<span class="id">left</span>"", " ++ <span class="id">rtype_to_spark_DataType</span> <span class="id">l</span> ++ "), <span class="id">StructField</span>(""$<span class="id">right</span>"", " ++ <span class="id">rtype_to_spark_DataType</span> <span class="id">r</span> ++ ")))"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Brand</span>₀ <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">StructType</span>(<span class="id">Seq</span>(<span class="id">StructField</span>(""$<span class="id">data</span>"", <span class="id">StringType</span>), <span class="id">StructField</span>(""$<span class="id">type</span>"", <span class="id">ArrayType</span>(<span class="id">StringType</span>))))"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Arrow</span>₀ <span class="id">_</span> <span class="id">_</span> =&gt; "<span class="id">ARROW</span> <span class="id">TYPE</span>?"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Foreign</span>₀ <span class="id">ft</span> =&gt; <span class="id">foreign_to_scala_spark_datatype</span> <span class="id">ft</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Scala-level type of an rtype.
   *
   * These are things like Long, String, Boolean, Array<span class="bracket">...</span>, Row.
   *
   * We need to annotate some expressions with Scala-level types
   * (e.g. Array<span class="bracket"><span class="id">Row</span></span>() for an empty Array of Records) to help
   * the Scala compiler because it does not infer types everywhere.
   </div>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">rtype_to_scala_type</span> (<span class="id">t</span>: <span class="id">rtype</span>₀): <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Bottom</span>₀ =&gt; "<span class="id">BOTTOM</span>?"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Top</span>₀ =&gt; "<span class="id">TOP</span>?"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Unit</span>₀ =&gt; "<span class="id">Unit</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Nat</span>₀ =&gt; "<span class="id">Long</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Bool</span>₀ =&gt; "<span class="id">Boolean</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">String</span>₀ =&gt; "<span class="id">String</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Coll</span>₀ <span class="id">r</span> =&gt; "<span class="id">Array</span>[" ++ <span class="id">rtype_to_scala_type</span> <span class="id">r</span> ++ "]"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Rec</span>₀ <span class="id">_</span> <span class="id">_</span> =&gt; "<span class="kwd">Record</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Either</span>₀ <span class="id">tl</span> <span class="id">tr</span> =&gt; "<span class="id">Either</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Brand</span>₀ <span class="id">bs</span> =&gt; "<span class="id">BrandedValue</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Arrow</span>₀ <span class="id">tin</span> <span class="id">t</span> =&gt; "<span class="id">CANNOT</span> <span class="id">PUT</span> <span class="id">AN</span> <span class="id">ARROW</span> <span class="id">INTO</span> <span class="id">A</span> <span class="id">DATAFRAME</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Foreign</span>₀ <span class="id">f</span> =&gt; "<span class="id">FOREIGN</span>?"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">drtype_to_scala</span> (<span class="id">t</span>: <span class="id">drtype</span>): <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tlocal</span> <span class="id">r</span> =&gt; <span class="id">rtype_to_scala_type</span> (<span class="id">proj1_sig</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tdistr</span> <span class="id">r</span> =&gt; "<span class="id">Dataset</span>[" ++ <span class="id">rtype_to_scala_type</span> (<span class="id">proj1_sig</span> <span class="id">r</span>) ++ "]"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">scala_literal_data</span> (<span class="id">d</span>: <span class="id">data</span>) (<span class="id">t</span>: <span class="id">rtype</span>₀) {<span class="kwd">struct</span> <span class="id">t</span>}: <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t</span>, <span class="id">d</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Unit</span>₀, <span class="id">d</span> =&gt; "()"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Nat</span>₀, <span class="id">dnat</span> <span class="id">i</span> =&gt; <span class="id">Z_to_string10</span> <span class="id">i</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Bool</span>₀, <span class="id">dbool</span> <span class="id">true</span> =&gt; "<span class="id">true</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Bool</span>₀, <span class="id">dbool</span> <span class="id">false</span> =&gt; "<span class="id">false</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">String</span>₀, <span class="id">dstring</span> <span class="id">s</span> =&gt; <span class="id">quote_string</span> <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Coll</span>₀ <span class="id">r</span>, <span class="id">dcoll</span> <span class="id">xs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">element_type</span> := <span class="id">rtype_to_scala_type</span> <span class="id">r</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">elements</span> := <span class="id">map</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">scala_literal_data</span> <span class="id">x</span> <span class="id">r</span>) <span class="id">xs</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">Array</span>[" ++ <span class="id">element_type</span> ++ "](" ++ <span class="id">joinStrings</span> ", " <span class="id">elements</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Rec</span>₀ <span class="id">_</span> <span class="id">fts</span>, <span class="id">drec</span> <span class="id">fds</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">blob</span> := <span class="id">quote_string</span> (<span class="id">data_to_blob</span> <span class="id">d</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">known_schema</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">StructType</span>(<span class="id">Seq</span>("<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">joinStrings</span> ", "<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">map</span> (<span class="kwd">fun</span> <span class="id">ft</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">StructField</span>(""" ++ <span class="id">fst</span> <span class="id">ft</span> ++ """, " ++ <span class="id">rtype_to_spark_DataType</span> (<span class="id">snd</span> <span class="id">ft</span>) ++ ")")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fts</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "))" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">fields</span> := <span class="id">map</span> (<span class="kwd">fun</span> <span class="id">ft</span> =&gt; <span class="kwd">match</span> <span class="id">lookup</span> <span class="id">string_dec</span> <span class="id">fds</span> (<span class="id">fst</span> <span class="id">ft</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">d</span> =&gt; <span class="id">scala_literal_data</span> <span class="id">d</span> (<span class="id">snd</span> <span class="id">ft</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">FIELD_IN_TYPE_BUT_NOT_IN_DATA</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>) <span class="id">fts</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">known</span> := "<span class="id">srow</span>(" ++ <span class="id">joinStrings</span> ", " (<span class="id">known_schema</span> :: <span class="id">fields</span>) ++ ")" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">srow</span>(<span class="id">StructType</span>(<span class="id">Seq</span>(<span class="id">StructField</span>(""$<span class="id">blob</span>"", <span class="id">StringType</span>), <span class="id">StructField</span>(""$<span class="id">known</span>"", " ++ <span class="id">known_schema</span> ++ "))), " ++ <span class="id">blob</span> ++ ", " ++ <span class="id">known</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; "<span class="id">UNIMPLEMENTED_SCALA_LITERAL_DATA</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">code_of_column</span> (<span class="id">c</span>: <span class="id">column</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">c</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CCol</span> <span class="id">s</span> =&gt; "<span class="id">column</span>(""" ++ <span class="id">s</span> ++ """)"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CDot</span> <span class="id">fld</span> <span class="id">c</span> =&gt; <span class="id">code_of_column</span> <span class="id">c</span> ++ ".<span class="id">getField</span>(" ++ <span class="id">quote_string</span> <span class="id">fld</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CEq</span> <span class="id">c1</span> <span class="id">c2</span> =&gt; <span class="id">code_of_column</span> <span class="id">c1</span> ++ ".<span class="id">equalTo</span>(" ++ <span class="id">code_of_column</span> <span class="id">c2</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CLessThan</span> <span class="id">c1</span> <span class="id">c2</span> =&gt; <span class="id">code_of_column</span> <span class="id">c1</span> ++ ".<span class="id">lt</span>(" ++ <span class="id">code_of_column</span> <span class="id">c2</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CLit</span> (<span class="id">d</span>, <span class="id">r</span>) =&gt; "<span class="id">lit</span>(" ++ <span class="id">scala_literal_data</span> <span class="id">d</span> <span class="id">r</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CNeg</span> <span class="id">c</span> =&gt; "<span class="id">not</span>(" ++ <span class="id">code_of_column</span> <span class="id">c</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CPlus</span> <span class="id">c1</span> <span class="id">c2</span> =&gt; <span class="id">code_of_column</span> <span class="id">c1</span> ++ ".<span class="id">plus</span>(" ++ <span class="id">code_of_column</span> <span class="id">c2</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CSConcat</span> <span class="id">c1</span> <span class="id">c2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">concat</span>(" ++ <span class="id">code_of_column</span> <span class="id">c1</span> ++ ", " ++ <span class="id">code_of_column</span> <span class="id">c2</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CToString</span> <span class="id">c</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">toQcertStringUDF</span>(" ++ <span class="id">code_of_column</span> <span class="id">c</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CUDFCast</span> <span class="id">bs</span> <span class="id">c</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">castUDF</span>(" ++ <span class="id">joinStrings</span> ", " ("<span class="id">HIERARCHY</span>"%<span class="id">string</span> :: <span class="id">map</span> <span class="id">quote_string</span> <span class="id">bs</span>) ++ ")(" ++ <span class="id">code_of_column</span> <span class="id">c</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">CUDFUnbrand</span> <span class="id">t</span> <span class="id">c</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">unbrandUDF</span>(" ++ <span class="id">rtype_to_spark_DataType</span> <span class="id">t</span> ++ ")(" ++ <span class="id">code_of_column</span> <span class="id">c</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">code_of_dataframe</span> (<span class="id">e</span>: <span class="id">dataframe</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DSVar</span> <span class="id">s</span> =&gt; <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DSSelect</span> <span class="id">cs</span> <span class="id">d</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">columns</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">map</span> (<span class="kwd">fun</span> <span class="id">nc</span> =&gt; <span class="id">code_of_column</span> (<span class="id">snd</span> <span class="id">nc</span>) ++ ".<span class="kwd">as</span>(""" ++ <span class="id">fst</span> <span class="id">nc</span> ++ """)") <span class="id">cs</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">code_of_dataframe</span> <span class="id">d</span> ++ ".<span class="id">select</span>(" ++ <span class="id">joinStrings</span> ", " <span class="id">columns</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DSFilter</span> <span class="id">c</span> <span class="id">d</span> =&gt; <span class="id">code_of_dataframe</span> <span class="id">d</span> ++ ".<span class="id">filter</span>(" ++ <span class="id">code_of_column</span> <span class="id">c</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DSCartesian</span> <span class="id">d1</span> <span class="id">d2</span> =&gt; <span class="id">code_of_dataframe</span> <span class="id">d1</span> ++ ".<span class="id">join</span>(" ++ (<span class="id">code_of_dataframe</span> <span class="id">d2</span>) ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DSExplode</span> <span class="id">s</span> <span class="id">d1</span> =&gt; <span class="id">code_of_dataframe</span> <span class="id">d1</span> ++ ".<span class="id">select</span>(<span class="id">explode</span>(" ++ <span class="id">code_of_column</span> (<span class="id">CCol</span> <span class="id">s</span>) ++ ").<span class="kwd">as</span>(""" ++ <span class="id">s</span> ++ """))"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">spark_of_unop</span> (<span class="id">op</span>: <span class="id">unaryOp</span>) (<span class="id">x</span>: <span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">op</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ACount</span> =&gt; <span class="id">x</span> ++ ".<span class="id">count</span>()" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ASum</span> =&gt; <span class="id">x</span> ++ ".<span class="id">select</span>(<span class="id">sum</span>(""<span class="id">value</span>"")).<span class="id">first</span>().<span class="id">getLong</span>(0)" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AFlatten</span> =&gt; <span class="id">x</span> ++ ".<span class="id">flatMap</span>(<span class="id">r</span> =&gt; <span class="id">r</span>)"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; "<span class="id">SPARK_OF_UNOP</span> <span class="id">don</span>'<span class="id">t</span> <span class="id">know</span> <span class="id">how</span> <span class="id">to</span> <span class="id">generate</span> <span class="id">Spark</span> <span class="id">code</span> <span class="kwd">for</span> <span class="id">this</span> <span class="id">operator</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">scala_of_unop</span> (<span class="id">required_type</span>: <span class="id">drtype</span>) (<span class="id">op</span>: <span class="id">unaryOp</span>) (<span class="id">x</span>: <span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">prefix</span> <span class="id">s</span> := <span class="id">s</span> ++ "(" ++ <span class="id">x</span> ++ ")" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">postfix</span> <span class="id">s</span> := <span class="id">x</span> ++ "." ++ <span class="id">s</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">op</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AArithMean</span> =&gt; <span class="id">prefix</span> "<span class="id">arithMean</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABrand</span> <span class="id">bs</span> =&gt; "<span class="id">brand</span>(" ++ <span class="id">joinStrings</span> ", " (<span class="id">x</span>::(<span class="id">map</span> <span class="id">quote_string</span> <span class="id">bs</span>)) ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ACast</span> <span class="id">bs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">cast</span>(<span class="id">HIERARCHY</span>, " ++ <span class="id">x</span> ++ ", " ++ <span class="id">joinStrings</span> ", " (<span class="id">map</span> <span class="id">quote_string</span> <span class="id">bs</span>) ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AColl</span> =&gt; <span class="id">prefix</span> "<span class="id">Array</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ACount</span> =&gt; <span class="id">postfix</span> "<span class="id">length</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ADot</span> <span class="id">n</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lift_tlocal</span> <span class="id">required_type</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">r</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">prefix</span> ("<span class="id">dot</span>[" ++ <span class="id">rtype_to_scala_type</span> (<span class="id">proj1_sig</span> <span class="id">r</span>) ++ "](""" ++ <span class="id">n</span> ++ """)")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">NONLOCAL</span> <span class="id">EXPECTED</span> <span class="id">TYPE</span> <span class="id">IN</span> <span class="id">DOT</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AFlatten</span> =&gt; <span class="id">postfix</span> "<span class="id">flatten.sorted</span>(<span class="id">QcertOrdering</span>)"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AIdOp</span> =&gt; <span class="id">prefix</span> "<span class="id">identity</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ALeft</span> =&gt; <span class="id">prefix</span> "<span class="id">left</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANeg</span> =&gt; "(!" ++ <span class="id">x</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANumMax</span> =&gt; <span class="id">prefix</span> "<span class="id">anummax</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANumMin</span> =&gt; <span class="id">prefix</span> "<span class="id">anummin</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ARec</span> <span class="id">n</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lift_tlocal</span> <span class="id">required_type</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">exist</span> <span class="id">_</span> (<span class="id">Rec</span>₀ <span class="id">Closed</span> ((<span class="id">_</span>, <span class="id">ft</span>)::<span class="id">nil</span>)) <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">singletonRecord</span>(" ++ <span class="id">quote_string</span> <span class="id">n</span> ++ ", " ++ <span class="id">rtype_to_spark_DataType</span> <span class="id">ft</span> ++ ", " ++ <span class="id">x</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; "<span class="id">AREC_WITH_UNEXPECTED_REQUIRED_TYPE</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ARecProject</span> <span class="id">fs</span> =&gt; <span class="id">prefix</span> ("<span class="id">recProject</span>(" ++ <span class="id">joinStrings</span> ", " (<span class="id">map</span> <span class="id">quote_string</span> <span class="id">fs</span>) ++ ")")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ARight</span> =&gt; <span class="id">prefix</span> "<span class="id">right</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ASum</span> =&gt; <span class="id">postfix</span> "<span class="id">sum</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AToString</span> =&gt; <span class="id">prefix</span> "<span class="id">toQcertString</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ASubstring</span> <span class="id">start</span> <span class="id">olen</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"(" ++ <span class="id">x</span> ++ ").<span class="id">substring</span>(" ++ <span class="id">toString</span> <span class="id">start</span> ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">olen</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">len</span> =&gt; ", " ++ <span class="id">toString</span> <span class="id">len</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; ""<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ALike</span> <span class="id">pat</span> <span class="id">oescape</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">ALike</span> <span class="id">currently</span> <span class="id">implemented</span>.  <span class="id">Please</span> <span class="id">implement</span> <span class="kwd">as</span> <span class="kwd">in</span> <span class="id">the</span> <span class="id">java</span> <span class="id">backend</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AUArith</span> <span class="id">ArithAbs</span> =&gt; <span class="id">prefix</span> "<span class="id">Math.abs</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AUnbrand</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lift_tlocal</span> <span class="id">required_type</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">exist</span> <span class="id">_</span> <span class="id">r</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">schema</span> := <span class="id">rtype_to_spark_DataType</span> <span class="id">r</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">scala</span> := <span class="id">rtype_to_scala_type</span> <span class="id">r</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">unbrand</span>[" ++ <span class="id">scala</span> ++ "](" ++ <span class="id">schema</span> ++ ", " ++ <span class="id">x</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">UNBRAND_REQUIRED_TYPE_ISSUE</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ADistinct</span> =&gt; <span class="id">postfix</span> "<span class="id">distinct</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AOrderBy</span> <span class="id">scl</span> =&gt; "<span class="id">SORT</span>???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AForeignUnaryOp</span> <span class="id">o</span> =&gt; <span class="id">foreign_to_scala_unary_op</span> <span class="id">o</span> <span class="id">x</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ARecRemove</span> <span class="id">_</span> =&gt; "<span class="id">ARECREMOVE</span>???"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ASingleton</span> =&gt; "<span class="id">SINGLETON</span>???"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AUArith</span> <span class="id">ArithLog2</span> =&gt; "<span class="id">LOG2</span>???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AUArith</span> <span class="id">ArithSqrt</span> =&gt; "<span class="id">SQRT</span>???" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">spark_of_binop</span> (<span class="id">op</span>: <span class="id">binOp</span>) (<span class="id">x</span>: <span class="id">string</span>) (<span class="id">y</span>: <span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">op</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AUnion</span> =&gt; <span class="id">x</span> ++ ".<span class="id">union</span>(" ++ <span class="id">y</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; "<span class="id">SPARK_OF_BINOP</span> <span class="id">don</span>'<span class="id">t</span> <span class="id">know</span> <span class="id">how</span> <span class="id">to</span> <span class="id">generate</span> <span class="id">Spark</span> <span class="id">code</span> <span class="kwd">for</span> <span class="id">this</span> <span class="id">operator</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">scala_of_binop</span> (<span class="id">op</span>: <span class="id">binOp</span>) (<span class="id">l</span>: <span class="id">string</span>) (<span class="id">r</span>: <span class="id">string</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">infix</span> <span class="id">s</span> := <span class="id">l</span> ++ "." ++ <span class="id">s</span> ++ "(" ++ <span class="id">r</span> ++ ")" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">infix</span>' <span class="id">s</span> := "(" ++ <span class="id">l</span> ++ " " ++ <span class="id">s</span> ++ " " ++ <span class="id">r</span> ++ ")" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">prefix</span> <span class="id">s</span> := <span class="id">s</span> ++ "(" ++ <span class="id">l</span> ++ ", " ++ <span class="id">r</span> ++ ")" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">op</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AAnd</span> =&gt; <span class="id">infix</span> "&amp;&amp;"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABArith</span> <span class="id">ArithDivide</span> =&gt; <span class="id">infix</span> "/"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABArith</span> <span class="id">ArithMax</span> =&gt; <span class="id">infix</span> "<span class="id">max</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABArith</span> <span class="id">ArithMin</span> =&gt; <span class="id">infix</span> "<span class="id">min</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABArith</span> <span class="id">ArithMinus</span> =&gt; <span class="id">infix</span> "-"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABArith</span> <span class="id">ArithMult</span> =&gt; <span class="id">infix</span> "*"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABArith</span> <span class="id">ArithPlus</span> =&gt; <span class="id">infix</span> "+"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ABArith</span> <span class="id">ArithRem</span> =&gt; <span class="id">infix</span> "%" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AConcat</span> =&gt; <span class="id">prefix</span> "<span class="id">recordConcat</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AContains</span> =&gt; <span class="id">prefix</span> "<span class="id">AContains</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AEq</span> =&gt; <span class="id">prefix</span> "<span class="id">equal</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ALe</span> =&gt; <span class="id">prefix</span> "<span class="id">lessOrEqual</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ALt</span> =&gt; <span class="id">prefix</span> "<span class="id">lessThan</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AMax</span> =&gt; <span class="id">l</span> ++ ".++(" ++ <span class="id">r</span> ++ ".<span class="id">diff</span>(" ++ <span class="id">l</span> ++ "))" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AMin</span> =&gt; <span class="id">l</span> ++ ".<span class="id">diff</span>(" ++ <span class="id">l</span> ++ ".<span class="id">diff</span>(" ++ <span class="id">r</span> ++ "))" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AMinus</span> =&gt; <span class="id">r</span> ++ ".<span class="id">diff</span>(" ++ <span class="id">l</span> ++ ")" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AMergeConcat</span> =&gt; <span class="id">prefix</span> "<span class="id">mergeConcat</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AOr</span> =&gt; <span class="id">infix</span> "||"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ASConcat</span> =&gt; <span class="id">infix</span> "+" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AUnion</span> =&gt; <span class="id">infix</span> "++" ++ ".<span class="id">sorted</span>(<span class="id">QcertOrdering</span>)" <br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">AForeignBinaryOp</span> <span class="id">op</span> =&gt; "<span class="id">FOREIGNBINARYOP</span>???"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">primitive_type</span> (<span class="id">t</span>: <span class="id">rtype</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">proj1_sig</span> <span class="id">t</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| ⊥₀ | ⊤₀ | <span class="id">Unit</span>₀ | <span class="id">Nat</span>₀ | <span class="id">String</span>₀ | <span class="id">Bool</span>₀ =&gt; <span class="id">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Coll</span>₀ <span class="id">_</span> | <span class="id">Rec</span>₀ <span class="id">_</span> <span class="id">_</span> | <span class="id">Either</span>₀ <span class="id">_</span> <span class="id">_</span> | <span class="id">Arrow</span>₀ <span class="id">_</span> <span class="id">_</span> | <span class="id">Brand</span>₀ <span class="id">_</span> =&gt; <span class="id">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Foreign</span>₀ <span class="id">_</span> =&gt; <span class="id">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">scala_of_dnnrc</span> {<span class="id">A</span>: <span class="kwd">Set</span>} (<span class="id">d</span>:@<span class="id">dnnrc</span> <span class="id">_</span> (<span class="id">type_annotation</span> <span class="id">A</span>) <span class="id">dataframe</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">code</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">d</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCGetConstant</span> <span class="id">t</span> <span class="id">n</span> =&gt; <span class="id">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCVar</span> <span class="id">t</span> <span class="id">n</span> =&gt; <span class="id">n</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCConst</span> <span class="id">t</span> <span class="id">c</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> (<span class="id">lift_tlocal</span> (<span class="id">di_required_typeof</span> <span class="id">d</span>)) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">r</span> =&gt; <span class="id">scala_literal_data</span> <span class="id">c</span> (<span class="id">proj1_sig</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">Don</span>'<span class="id">t</span> <span class="id">know</span> <span class="id">how</span> <span class="id">to</span> <span class="id">construct</span> <span class="id">a</span> <span class="id">distributed</span> <span class="id">constant</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCBinop</span> <span class="id">t</span> <span class="id">op</span> <span class="id">x</span> <span class="id">y</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">di_typeof</span> <span class="id">x</span>, <span class="id">di_typeof</span> <span class="id">y</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tlocal</span> <span class="id">_</span>, <span class="id">Tlocal</span> <span class="id">_</span> =&gt; <span class="id">scala_of_binop</span> <span class="id">op</span> (<span class="id">scala_of_dnnrc</span> <span class="id">x</span>) (<span class="id">scala_of_dnnrc</span> <span class="id">y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tdistr</span> <span class="id">_</span>, <span class="id">Tdistr</span> <span class="id">_</span> =&gt; <span class="id">spark_of_binop</span> <span class="id">op</span> (<span class="id">scala_of_dnnrc</span> <span class="id">x</span>) (<span class="id">scala_of_dnnrc</span> <span class="id">y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; "<span class="id">DONT_SUPPORT_MIXED_LOCAL_DISTRIBUTED_BINARY_OPERATORS</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCUnop</span> <span class="id">t</span> <span class="id">op</span> <span class="id">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">di_typeof</span> <span class="id">x</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tlocal</span> <span class="id">_</span> =&gt; <span class="id">scala_of_unop</span> (<span class="id">di_required_typeof</span> <span class="id">d</span>) <span class="id">op</span> (<span class="id">scala_of_dnnrc</span> <span class="id">x</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tdistr</span> <span class="id">_</span> =&gt; <span class="id">spark_of_unop</span> <span class="id">op</span> (<span class="id">scala_of_dnnrc</span> <span class="id">x</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCLet</span> <span class="id">t</span> <span class="id">n</span> <span class="id">x</span> <span class="id">y</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"((( " ++ <span class="id">n</span> ++ ": " ++ <span class="id">drtype_to_scala</span> (<span class="id">di_typeof</span> <span class="id">x</span>) ++ ") =&gt; " ++ <span class="id">scala_of_dnnrc</span> <span class="id">y</span> ++ ")(" ++ <span class="id">scala_of_dnnrc</span> <span class="id">x</span> ++ "))"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCFor</span> <span class="id">t</span> <span class="id">n</span> <span class="id">x</span> <span class="id">y</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">scala_of_dnnrc</span> <span class="id">x</span> ++ ".<span class="id">map</span>((" ++ <span class="id">n</span> ++ ") =&gt; { " ++ <span class="id">scala_of_dnnrc</span> <span class="id">y</span> ++ " })"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCIf</span> <span class="id">t</span> <span class="id">x</span> <span class="id">y</span> <span class="id">z</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"(<span class="kwd">if</span> (" ++ <span class="id">scala_of_dnnrc</span> <span class="id">x</span> ++ ") " ++ <span class="id">scala_of_dnnrc</span> <span class="id">y</span> ++ " <span class="kwd">else</span> " ++ <span class="id">scala_of_dnnrc</span> <span class="id">z</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCEither</span> <span class="id">t</span> <span class="id">x</span> <span class="id">vy</span> <span class="id">y</span> <span class="id">vz</span> <span class="id">z</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">olift</span> <span class="id">tuneither</span> (<span class="id">lift_tlocal</span> (<span class="id">di_required_typeof</span> <span class="id">x</span>)) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">lt</span>, <span class="id">rt</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">either</span>(" ++ <span class="id">scala_of_dnnrc</span> <span class="id">x</span> ++ ", (" ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vy</span> ++ ": " ++ <span class="id">rtype_to_scala_type</span> (<span class="id">proj1_sig</span> <span class="id">lt</span>) ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;") =&gt; { " ++ <span class="id">scala_of_dnnrc</span> <span class="id">y</span> ++ " }, (" ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vz</span> ++ ": " ++ <span class="id">rtype_to_scala_type</span> (<span class="id">proj1_sig</span> <span class="id">rt</span>) ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;") =&gt; { " ++ <span class="id">scala_of_dnnrc</span> <span class="id">z</span> ++ " })"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">DNNRCEither</span>'<span class="id">s</span> <span class="id">first</span> <span class="id">argument</span> <span class="id">is</span> <span class="id">not</span> <span class="id">of</span> <span class="id">type</span> <span class="id">Either</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCGroupBy</span> <span class="id">t</span> <span class="id">g</span> <span class="id">sl</span> <span class="id">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">DNNRC_GROUPBY_CODEGEN_IS_NOT_CURRENTLY_IMPLEMENTED</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCCollect</span> <span class="id">t</span> <span class="id">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">postfix</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">olift</span> <span class="id">tuncoll</span> (<span class="id">lift_tdistr</span> (<span class="id">di_typeof</span> <span class="id">x</span>)) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">rt</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">proj1_sig</span> <span class="id">rt</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Nat</span>₀ =&gt; ".<span class="id">map</span>((<span class="id">row</span>) =&gt; <span class="id">row.getLong</span>(0))"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Foreign</span>₀ <span class="id">_</span> =&gt; ".<span class="id">map</span>((<span class="id">row</span>) =&gt; <span class="id">row.getFloat</span>(0))" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; "" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">ARGUMENT_TO_COLLECT_SHOULD_BE_A_DISTRIBUTED_COLLECTION</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">scala_of_dnnrc</span> <span class="id">x</span> ++ ".<span class="id">collect</span>()" ++ <span class="id">postfix</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCDispatch</span> <span class="id">t</span> <span class="id">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">olift</span> <span class="id">tuncoll</span> (<span class="id">lift_tlocal</span> (<span class="id">di_typeof</span> <span class="id">x</span>)) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">et</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">dispatch</span>(" ++ <span class="id">rtype_to_spark_DataType</span> (<span class="id">proj1_sig</span> <span class="id">et</span>) ++ ", " ++ <span class="id">scala_of_dnnrc</span> <span class="id">x</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">Argument</span> <span class="id">to</span> <span class="id">dispatch</span> <span class="id">is</span> <span class="id">not</span> <span class="id">a</span> <span class="id">local</span> <span class="id">collection</span>."<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCAlg</span> <span class="id">t</span> <span class="id">a</span> ((<span class="id">x</span>, <span class="id">d</span>)::<span class="id">nil</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"{ <span class="id">val</span> " ++ <span class="id">x</span> ++ " = " ++ <span class="id">scala_of_dnnrc</span> <span class="id">d</span> ++ "; " ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">code_of_dataframe</span> <span class="id">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ " }"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DNNRCAlg</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">NON_UNARY_ALG_CODEGEN_IS_NOT_CURRENTLY_IMPLEMENTED</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">di_typeof</span> <span class="id">d</span> == <span class="id">di_required_typeof</span> <span class="id">d</span> <span class="kwd">then</span> <span class="id">code</span> <span class="kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lift_tlocal</span> (<span class="id">di_required_typeof</span> <span class="id">d</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">r</span> =&gt; "<span class="id">identity</span>/*<span class="id">CAST</span>*/(" ++ <span class="id">code</span> ++ ")"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; "<span class="id">CANTCASTTODISTRIBUTEDTYPE</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">initBrandHierarchy</span> : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">lines</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">map</span> (<span class="kwd">fun</span> <span class="id">p</span> =&gt; "(""" ++ <span class="id">fst</span> <span class="id">p</span> ++ """ -&gt; """ ++ <span class="id">snd</span> <span class="id">p</span> ++ """)")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">brand_relation_brands</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">joinStrings</span> ", " <span class="id">lines</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">emitGlobals</span> (<span class="id">tenv</span>: <span class="id">tdbindings</span>) (<span class="id">fileArgCounter</span>: <span class="id">nat</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">tenv</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">nil</span> =&gt; ""<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">name</span>, <span class="id">Tlocal</span> <span class="id">lt</span>) :: <span class="id">rest</span> =&gt; "<span class="id">LOCAL</span> <span class="id">INPUT</span> <span class="id">UNIMPLEMENTED</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">name</span>, <span class="id">Tdistr</span> <span class="id">elt</span>) :: <span class="id">rest</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class="id">val</span> " ++ <span class="id">name</span> ++ " = <span class="id">sparkSession.read.schema</span>(" ++ <span class="id">rtype_to_spark_DataType</span> (<span class="id">proj1_sig</span> <span class="id">elt</span>) ++ ").<span class="id">json</span>(<span class="id">args</span>(" ++ <span class="id">nat_to_string10</span> <span class="id">fileArgCounter</span> ++ "))" ++ <span class="id">eol</span> ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">emitGlobals</span> <span class="id">rest</span> (<span class="id">fileArgCounter</span> + 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Toplevel entry to Spark2/Scala codegen </div>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">dnnrc_typed_to_spark_df_top</span> {<span class="id">A</span> : <span class="kwd">Set</span>} (<span class="id">tenv</span>:<span class="id">tdbindings</span>) (<span class="id">name</span>: <span class="id">string</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">e</span>:<span class="id">dnnrc_dataframe_typed</span>) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;""<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">import</span> <span class="id">org.apache.spark.SparkContext</span>" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">import</span> <span class="id">org.apache.spark.sql.functions._</span>" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">import</span> <span class="id">org.apache.spark.sql.SparkSession</span>" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">import</span> <span class="id">org.apache.spark.sql.types._</span>" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">import</span> <span class="id">org.qcert.QcertRuntime</span>" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">import</span> <span class="id">org.qcert.QcertRuntime._</span>" ++ <span class="id">eol</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">object</span> " ++ <span class="id">name</span> ++ " {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">def</span> <span class="id">main</span>(<span class="id">args</span>: <span class="id">Array</span>[<span class="id">String</span>]): <span class="id">Unit</span> = {" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">val</span> <span class="id">HIERARCHY</span> = <span class="id">QcertRuntime.makeHierarchy</span>(" ++ <span class="id">initBrandHierarchy</span> ++ ")" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">val</span> <span class="id">sparkContext</span> = <span class="id">new</span> <span class="id">SparkContext</span>()" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">org.apache.log4j.Logger.getRootLogger</span>().<span class="id">setLevel</span>(<span class="id">org.apache.log4j.Level.WARN</span>)" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">val</span> <span class="id">sparkSession</span> = <span class="id">SparkSession.builder</span>().<span class="id">getOrCreate</span>()" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">emitGlobals</span> <span class="id">tenv</span> 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">import</span> <span class="id">sparkSession.implicits._</span>" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">QcertRuntime.beforeQuery</span>()" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">println</span>(<span class="id">QcertRuntime.toBlob</span>(" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id">scala_of_dnnrc</span> <span class="id">e</span> ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "))" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">QcertRuntime.afterQuery</span>()" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "<span class="id">sparkContext.stop</span>()" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "}" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ "}" ++ <span class="id">eol</span><br/>
&nbsp;&nbsp;.<br/>
<br/>
<span class="kwd">End</span> <span class="id">tDNNRCtoSparkDF</span>.<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</div>
</body>
</html>
