
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Qcert.NRAEnv.Lang.NRAEnv</title>
<meta name="description" content="Documentation of Coq module Qcert.NRAEnv.Lang.NRAEnv" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Qcert.NRAEnv.Lang.NRAEnv</h1>
<div class="coq">
<br/>
<div class="doc">NRAEnv is nested relational algebra, extended with operations to
  facilitate encoding of environment manipulation. It serves as the
  main intermediate language for optimization. </div>
<br/>
<div class="doc">NRAEnv is a thin layer over the core language cNRAEnv. As cNRAEnv,
  NRAEnv is combinators-based, i.e., it is evaluated with only a
  static global environment, but no notion of local
  variables. </div>
<br/>
<div class="doc">Additional operators in NRAEnv can be easily expressed in terms of
  the core cNRAEnv, but are useful for optimization purposes. Those
  operators notably include joins and group-by. </div>
<br/>
<div class="doc">NRAEnv builds on a large body of work from the database
community. For a complete treatment on nested relational algebras, we
refer to Guido Moerkotte's "Building Query Compilers", Chapter 7.
   http://pi3.informatik.uni-mannheim.de/~moer/querycompiler.pdf </div>
<br/>
<div class="doc">Summary:
<ul>
<li>
 Language: NRAEnv (Nested Relational Algebra with Environments)
</li>
<li>
 Based on: "Handling Environments in a Nested Relational Algebra with
  Combinators and an Implementation in a Verified Query Compiler"
  Joshua Auerbach, Martin Hirzel, Louis Mandel, Avraham Shinnar, and
  Jérôme Siméon. SIGMOD'2017.
</li>
<li>
 translating to NRAEnv: LambdaNRA, SQL, OQL, CAMP, cNRAEnv
</li>
<li>
 translating from NRAEnv: NNRC, cNRAEnv </li>
</ul>
</div>
<br/>
<span class="kwd">Section</span> <span class="id">NRAEnv</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">List</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Compare_dec</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">EquivDec</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Utils</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">BasicRuntime</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">cNRAEnv</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">cNRAEnvEq</span>.<br/>
<br/>
<h1> Abstract Syntax </h1>
<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> (<span class="id">h</span>:<span class="id">list</span>(<span class="id">string</span>*<span class="id">string</span>)).<br/>
&nbsp;&nbsp;<span class="kwd">Context</span> {<span class="id">fruntime</span>:<span class="id">foreign_runtime</span>}.<br/>
<br/>
<div class="doc">As much as possible, notations are aligned with those of S. Cluet
   and G. Moerkotte. Nested queries in object bases. In Proc. Int.
   Workshop on Database Programming Languages , pages 226-242,
   1993. </div>
<br/>
&nbsp;&nbsp;<span class="kwd">Inductive</span> <span class="id">nraenv</span> : <span class="kwd">Set</span> :=<br/>
&nbsp;&nbsp;| <span class="id">NRAEnvID</span> : <span class="id">nraenv</span>                                         <span class="docright">(* Current value  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvConst</span> : <span class="id">data</span> -&gt; <span class="id">nraenv</span>                              <span class="docright">(* Constant value  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> : <span class="id">binOp</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>         <span class="docright">(* Binary operator  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> : <span class="id">unaryOp</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                  <span class="docright">(* Unary operator  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                    <span class="docright">(* Map <span class="bracket">χ</span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvMapConcat</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>              <span class="docright">(* Dependent cartesian product <span class="bracket">⋈ᵈ</span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvProduct</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                <span class="docright">(* Cartesian product <span class="bracket">×</span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                 <span class="docright">(* Relational selection <span class="bracket">σ</span>  *)</span> <br/>
&nbsp;&nbsp;| <span class="id">NRAEnvDefault</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                <span class="docright">(* Default for empty collection <span class="bracket">∥</span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvEither</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                 <span class="docright">(* Choice  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvEitherConcat</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>           <span class="docright">(* Choice with concatenation  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                    <span class="docright">(* Composition  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvGetConstant</span> : <span class="id">string</span> -&gt; <span class="id">nraenv</span>                      <span class="docright">(* Accesses a global constant  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvEnv</span> : <span class="id">nraenv</span>                                        <span class="docright">(* Current environment  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                 <span class="docright">(* Composition over the environment  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvMapEnv</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                           <span class="docright">(* Map over the environment  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvFlatMap</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>                <span class="docright">(* Flat map  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvJoin</span> : <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>         <span class="docright">(* Join <span class="bracket">⋈</span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvProject</span> : <span class="id">list</span> <span class="id">string</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>           <span class="docright">(* Projection <span class="bracket">Π</span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvGroupBy</span> : <span class="id">string</span> -&gt; <span class="id">list</span> <span class="id">string</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span> <span class="docright">(* GroupBy <span class="bracket">Γ</span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id">NRAEnvUnnest</span> : <span class="id">string</span> -&gt; <span class="id">string</span> -&gt; <span class="id">nraenv</span> -&gt; <span class="id">nraenv</span>       <span class="docright">(* Unnesting <span class="bracket">μ</span>  *)</span><br/>
&nbsp;&nbsp;.<br/>
<br/>
<div class="doc">Equality between two NRAEnv expressions is decidable. </div>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Global</span> <span class="kwd">Instance</span> <span class="id">nraenv_eqdec</span> : <span class="id">EqDec</span> <span class="id">nraenv</span> <span class="id">eq</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof1918')">Proof.</div>
<div class="proofscript" id="proof1918">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (<span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> : <span class="id">nraenv</span>,  {<span class="id">x</span> = <span class="id">y</span>} + {<span class="id">x</span> &lt;&gt; <span class="id">y</span>}).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">decide</span> <span class="id">equality</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span> [<span class="tactic">apply</span> <span class="id">binOp_eqdec</span> | <span class="tactic">apply</span> <span class="id">unaryOp_eqdec</span> | <span class="tactic">apply</span> <span class="id">data_eqdec</span> | <span class="tactic">apply</span> <span class="id">string_eqdec</span> | <span class="tactic">apply</span> <span class="id">list_eqdec</span>; <span class="tactic">apply</span> <span class="id">string_eqdec</span>].<br/>
&nbsp;&nbsp;Defined.</div>
<br/>
<h1> Macros </h1>
<br/>
<div class="doc">All the additional operators are defined in terms of the core cNRAEnv. </div>
&nbsp;&nbsp;<br/>
<h2> Join operations </h2>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">join</span> (<span class="id">op1</span> <span class="id">op2</span> <span class="id">op3</span> : <span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANSelect</span> <span class="id">op1</span> (<span class="id">ANProduct</span> <span class="id">op2</span> <span class="id">op3</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">semi_join</span> (<span class="id">op1</span> <span class="id">op2</span> <span class="id">op3</span> : <span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANSelect</span> (<span class="id">ANUnop</span> <span class="id">ANeg</span> (<span class="id">ANBinop</span> <span class="id">AEq</span> (<span class="id">ANSelect</span> <span class="id">op1</span> (<span class="id">ANProduct</span> ((<span class="id">ANUnop</span> <span class="id">AColl</span>) <span class="id">ANID</span>) <span class="id">op3</span>)) (<span class="id">ANConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>)))) <span class="id">op2</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">anti_join</span> (<span class="id">op1</span> <span class="id">op2</span> <span class="id">op3</span> : <span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANSelect</span> (<span class="id">ANBinop</span> <span class="id">AEq</span> (<span class="id">ANSelect</span> <span class="id">op1</span> (<span class="id">ANProduct</span> ((<span class="id">ANUnop</span> <span class="id">AColl</span>) <span class="id">ANID</span>) <span class="id">op3</span>)) (<span class="id">ANConst</span> (<span class="id">dcoll</span> <span class="id">nil</span>))) <span class="id">op2</span>.<br/>
<br/>
<h2> Map operations </h2>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">map_add_rec</span> (<span class="id">s</span>:<span class="id">string</span>) (<span class="id">op1</span> <span class="id">op2</span> : <span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANMap</span> ((<span class="id">ANBinop</span> <span class="id">AConcat</span>) <span class="id">ANID</span> ((<span class="id">ANUnop</span> (<span class="id">ARec</span> <span class="id">s</span>)) <span class="id">op1</span>)) <span class="id">op2</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">map_to_rec</span> (<span class="id">s</span>:<span class="id">string</span>) (<span class="id">op</span> : <span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANMap</span> (<span class="id">ANUnop</span> (<span class="id">ARec</span> <span class="id">s</span>) <span class="id">ANID</span>) <span class="id">op</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">flat_map</span> (<span class="id">op1</span> <span class="id">op2</span> : <span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANUnop</span> <span class="id">AFlatten</span> (<span class="id">ANMap</span> <span class="id">op1</span> <span class="id">op2</span>).<br/>
&nbsp;&nbsp;<br/>
<h2> Projection </h2>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">project</span> (<span class="id">fields</span>:<span class="id">list</span> <span class="id">string</span>) (<span class="id">op</span>:<span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id">ANMap</span> (<span class="id">ANUnop</span> (<span class="id">ARecProject</span> <span class="id">fields</span>) <span class="id">ANID</span>) <span class="id">op</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">project_remove</span> (<span class="id">s</span>:<span class="id">string</span>) (<span class="id">op</span>:<span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANMap</span> ((<span class="id">ANUnop</span> (<span class="id">ARecRemove</span> <span class="id">s</span>)) <span class="id">ANID</span>) <span class="id">op</span>.<br/>
<br/>
<h2> Renaming </h2>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">map_rename_rec</span> (<span class="id">s1</span> <span class="id">s2</span>:<span class="id">string</span>) (<span class="id">op</span>:<span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANMap</span> ((<span class="id">ANBinop</span> <span class="id">AConcat</span>) ((<span class="id">ANUnop</span> (<span class="id">ARec</span> <span class="id">s2</span>)) ((<span class="id">ANUnop</span> (<span class="id">ADot</span> <span class="id">s1</span>)) <span class="id">ANID</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">ANUnop</span> (<span class="id">ARecRemove</span> <span class="id">s1</span>)) <span class="id">ANID</span>)) <span class="id">op</span>.<br/>
<br/>
<h2> Grouping </h2>
<br/>
<div class="doc">Defining group-by in terms of the core is more tricky, but is
     possible. You need to do two passes, and compare elements with
     the same set of attribute names which means you need to
     encapsulate each branch with distinct record names. </div>
<br/>
&nbsp;&nbsp;<span class="kwd">Import</span> <span class="id">ListNotations</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">group_by_no_env</span> (<span class="id">g</span>:<span class="id">string</span>) (<span class="id">sl</span>:<span class="id">list</span> <span class="id">string</span>) (<span class="id">op</span> : <span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANMap</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ADot</span> "1") (<span class="id">ANUnop</span> (<span class="id">ADot</span> "2") <span class="id">ANID</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ARec</span> <span class="id">g</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANMap</span> (<span class="id">ANUnop</span> (<span class="id">ADot</span> "3") <span class="id">ANID</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANSelect</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANBinop</span> <span class="id">AEq</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) (<span class="id">ANUnop</span> (<span class="id">ADot</span> "1") <span class="id">ANID</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) (<span class="id">ANUnop</span> (<span class="id">ADot</span> "3") <span class="id">ANID</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANProduct</span> (<span class="id">ANUnop</span> <span class="id">AColl</span> (<span class="id">ANUnop</span> (<span class="id">ADot</span> "2") <span class="id">ANID</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ADot</span> "4") <span class="id">ANID</span>))))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANProduct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> <span class="id">AColl</span> (<span class="id">ANUnop</span> (<span class="id">ARec</span> "4") (<span class="id">map_to_rec</span> "3" <span class="id">op</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">map_to_rec</span> "2" (<span class="id">map_to_rec</span> "1" (<span class="id">ANUnop</span> <span class="id">ADistinct</span> (<span class="id">project</span> <span class="id">sl</span> <span class="id">op</span>))))).<br/>
<br/>
<div class="doc">This is an alternative definition that isn't quite as
      inefficient. It stores the result of the input operator in the
      environment so it isn't computed twice. This is still
      quadratic. </div>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">group_by_with_env</span> (<span class="id">g</span>:<span class="id">string</span>) (<span class="id">sl</span>:<span class="id">list</span> <span class="id">string</span>) (<span class="id">op</span> : <span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">op_pregroup</span> := <span class="id">ANUnop</span> (<span class="id">ADot</span> "$<span class="id">pregroup</span>") <span class="id">ANEnv</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANAppEnv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANMap</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANBinop</span> <span class="id">AConcat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ARec</span> <span class="id">g</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANAppEnv</span> (<span class="id">ANSelect</span> (<span class="id">ANBinop</span> <span class="id">AEq</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ARecProject</span> <span class="id">sl</span>) <span class="id">ANID</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ADot</span> "$<span class="id">key</span>") <span class="id">ANEnv</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">op_pregroup</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANBinop</span> <span class="id">AConcat</span> (<span class="id">ANUnop</span> (<span class="id">ARec</span> "$<span class="id">key</span>") <span class="id">ANID</span>) <span class="id">ANEnv</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANID</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> <span class="id">ADistinct</span> (<span class="id">project</span> <span class="id">sl</span> <span class="id">op_pregroup</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ANUnop</span> (<span class="id">ARec</span> "$<span class="id">pregroup</span>") <span class="id">op</span>).<br/>
<br/>
<h2> Unnesting </h2>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">unnest_one</span> (<span class="id">s</span>:<span class="id">string</span>) (<span class="id">op</span>:<span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANMap</span> ((<span class="id">ANUnop</span> (<span class="id">ARecRemove</span> <span class="id">s</span>)) <span class="id">ANID</span>) (<span class="id">ANMapConcat</span> ((<span class="id">ANUnop</span> (<span class="id">ADot</span> <span class="id">s</span>)) <span class="id">ANID</span>) <span class="id">op</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">unnest</span> (<span class="id">a</span> <span class="id">b</span>:<span class="id">string</span>) (<span class="id">op</span>:<span class="id">nraenv_core</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ANMap</span> ((<span class="id">ANUnop</span> (<span class="id">ARecRemove</span> <span class="id">a</span>)) <span class="id">ANID</span>) (<span class="id">ANMapConcat</span> (<span class="id">ANMap</span> ((<span class="id">ANUnop</span> (<span class="id">ARec</span> <span class="id">b</span>)) <span class="id">ANID</span>) ((<span class="id">ANUnop</span> (<span class="id">ADot</span> <span class="id">a</span>)) <span class="id">ANID</span>)) <span class="id">op</span>).<br/>
<br/>
<h1> Evaluation Semantics </h1>
<br/>
<div class="doc">The semantics of NRAEnv is defined as macro-expansion to the core language cNRAEnv. </div>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">nraenv_core_of_nraenv</span> (<span class="id">e</span>:<span class="id">nraenv</span>) : <span class="id">nraenv_core</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvID</span> =&gt; <span class="id">ANID</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvConst</span> <span class="id">d</span> =&gt; <span class="id">ANConst</span> <span class="id">d</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> <span class="id">b</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">ANBinop</span> <span class="id">b</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">u</span> <span class="id">e1</span> =&gt; <span class="id">ANUnop</span> <span class="id">u</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">ANMap</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMapConcat</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">ANMapConcat</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProduct</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">ANProduct</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">ANSelect</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvDefault</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">ANDefault</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEither</span> <span class="id">opl</span> <span class="id">opr</span> =&gt; <span class="id">ANEither</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">opl</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">opr</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEitherConcat</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">ANEitherConcat</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">op1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">ANApp</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvGetConstant</span> <span class="id">s</span> =&gt; <span class="id">ANGetConstant</span> <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEnv</span> =&gt; <span class="id">ANEnv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">ANAppEnv</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMapEnv</span> <span class="id">e1</span> =&gt; <span class="id">ANMapEnv</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvFlatMap</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">flat_map</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvJoin</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">e3</span> =&gt; <span class="id">join</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e2</span>) (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProject</span> <span class="id">ls</span> <span class="id">e1</span> =&gt; <span class="id">project</span> <span class="id">ls</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvGroupBy</span> <span class="id">s</span> <span class="id">ls</span> <span class="id">e1</span> =&gt; <span class="id">group_by_with_env</span> <span class="id">s</span> <span class="id">ls</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnnest</span> <span class="id">a</span> <span class="id">b</span> <span class="id">e1</span> =&gt; <span class="id">unnest</span> <span class="id">a</span> <span class="id">b</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nraenv_eval</span> <span class="id">c</span> (<span class="id">e</span>:<span class="id">nraenv</span>) (<span class="id">env</span>:<span class="id">data</span>) (<span class="id">x</span>:<span class="id">data</span>) : <span class="id">option</span> <span class="id">data</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_core_eval</span> <span class="id">h</span> <span class="id">c</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">e</span>) <span class="id">env</span> <span class="id">x</span>.<br/>
<br/>
<h1> Round-tripping </h1>
<br/>
<div class="doc">Just checking that cNRAEnv can be lifted back to NRAEnv, and
  showing that we can round-trip. </div>
<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">nraenv_of_nraenv_core</span> (<span class="id">a</span>:<span class="id">nraenv_core</span>) : <span class="id">nraenv</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANID</span> =&gt; <span class="id">NRAEnvID</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANConst</span> <span class="id">d</span> =&gt; <span class="id">NRAEnvConst</span> <span class="id">d</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANBinop</span> <span class="id">b</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NRAEnvBinop</span> <span class="id">b</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANUnop</span> <span class="id">u</span> <span class="id">e1</span> =&gt; <span class="id">NRAEnvUnop</span> <span class="id">u</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANMap</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NRAEnvMap</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANMapConcat</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NRAEnvMapConcat</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANProduct</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NRAEnvProduct</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANSelect</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NRAEnvSelect</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANDefault</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NRAEnvDefault</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANEither</span> <span class="id">opl</span> <span class="id">opr</span> =&gt; <span class="id">NRAEnvEither</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">opl</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">opr</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANEitherConcat</span> <span class="id">op1</span> <span class="id">op2</span> =&gt; <span class="id">NRAEnvEitherConcat</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">op1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">op2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANApp</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NRAEnvApp</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANGetConstant</span> <span class="id">s</span> =&gt; <span class="id">NRAEnvGetConstant</span> <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANEnv</span> =&gt; <span class="id">NRAEnvEnv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANAppEnv</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">NRAEnvAppEnv</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>) (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ANMapEnv</span> <span class="id">e1</span> =&gt; <span class="id">NRAEnvMapEnv</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">e1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nraenv_roundtrip</span> (<span class="id">a</span>:<span class="id">nraenv_core</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">nraenv_core_of_nraenv</span> (<span class="id">nraenv_of_nraenv_core</span> <span class="id">a</span>)) = <span class="id">a</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof1919')">Proof.</div>
<div class="proofscript" id="proof1919">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">a</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>; <span class="tactic">try</span> (<span class="tactic">rewrite</span> <span class="id">IHa1</span>; <span class="tactic">rewrite</span> <span class="id">IHa2</span>; <span class="tactic">try</span> <span class="tactic">rewrite</span> <span class="id">IHa3</span>; <span class="tactic">reflexivity</span>); <span class="tactic">rewrite</span> <span class="id">IHa</span>; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div>
<br/>
<h1> Toplevel </h1>
&nbsp;&nbsp;<br/>
<div class="doc">Top-level evaluation is used externally by the Q*cert
  compiler. It takes an NRAEnv expression and a global environment as
  input. The initial current environment is set to an empty record,
  and the initial current value to unit. </div>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">Top</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">nraenv_eval_top</span> (<span class="id">q</span>:<span class="id">nraenv</span>) (<span class="id">env</span>:<span class="id">bindings</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_eval</span> (<span class="id">rec_sort</span> <span class="id">env</span>) <span class="id">q</span> (<span class="id">drec</span> <span class="id">nil</span>) <span class="id">dunit</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">Top</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">FreeVars</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">nraenv_free_vars</span> (<span class="id">q</span>:<span class="id">nraenv</span>) : <span class="id">list</span> <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">q</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvID</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvConst</span> <span class="id">rd</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvBinop</span> <span class="id">_</span> <span class="id">q1</span> <span class="id">q2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnop</span> <span class="id">_</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMap</span> <span class="id">q2</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMapConcat</span> <span class="id">q2</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProduct</span> <span class="id">q1</span> <span class="id">q2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvSelect</span> <span class="id">q2</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEither</span> <span class="id">ql</span> <span class="id">qr</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">ql</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">qr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEitherConcat</span> <span class="id">q1</span> <span class="id">q2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvDefault</span> <span class="id">q1</span> <span class="id">q2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvApp</span> <span class="id">q2</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvGetConstant</span> <span class="id">s</span> =&gt; <span class="id">s</span> :: <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvEnv</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvAppEnv</span> <span class="id">q2</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvMapEnv</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvFlatMap</span> <span class="id">q2</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvJoin</span> <span class="id">q3</span> <span class="id">q1</span> <span class="id">q2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q2</span> ++ <span class="id">nraenv_free_vars</span> <span class="id">q3</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvProject</span> <span class="id">_</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvGroupBy</span> <span class="id">_</span> <span class="id">_</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">NRAEnvUnnest</span> <span class="id">_</span> <span class="id">_</span> <span class="id">q1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_free_vars</span> <span class="id">q1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">nraenv_free_vars_as_core</span> (<span class="id">q</span>:<span class="id">nraenv</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nraenv_core_free_vars</span> (<span class="id">nraenv_core_of_nraenv</span> <span class="id">q</span>) = <span class="id">nraenv_free_vars</span> <span class="id">q</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof1920')">Proof.</div>
<div class="proofscript" id="proof1920">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">q</span>; <span class="tactic">simpl</span>; <span class="tactic">try</span> <span class="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> <span class="id">solve</span>[<span class="tactic">rewrite</span> <span class="id">IHq1</span>; <span class="tactic">rewrite</span> <span class="id">IHq2</span>; <span class="tactic">reflexivity</span>|<span class="tactic">rewrite</span> <span class="id">IHq</span>;<span class="tactic">reflexivity</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">rewrite</span> <span class="id">IHq1</span>; <span class="tactic">rewrite</span> <span class="id">IHq2</span>; <span class="tactic">rewrite</span> <span class="id">IHq3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">app_assoc</span>; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">rewrite</span> <span class="id">app_nil_r</span>; <span class="tactic">rewrite</span> <span class="id">IHq</span>; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">rewrite</span> <span class="id">app_nil_r</span>; <span class="tactic">rewrite</span> <span class="id">IHq</span>; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="tactic">rewrite</span> <span class="id">app_nil_r</span>; <span class="tactic">rewrite</span> <span class="id">app_nil_r</span>; <span class="tactic">rewrite</span> <span class="id">IHq</span>; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Qed.</div>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">FreeVars</span>.<br/>
<br/>
<span class="kwd">End</span> <span class="id">NRAEnv</span>.<br/>
<br/>
<span class="kwd">Delimit</span> <span class="kwd">Scope</span> <span class="id">nraenv_scope</span> <span class="kwd">with</span> <span class="id">nraenv</span>.<br/>
<br/>
<span class="kwd">Notation</span> "<span class="id">h</span> ⊢ <span class="id">EOp</span> @ₓ <span class="id">x</span> ⊣ <span class="id">c</span> ; <span class="id">env</span>" := (<span class="id">nraenv_eval</span> <span class="id">h</span> <span class="id">c</span> <span class="id">EOp</span> <span class="id">env</span> <span class="id">x</span>) (<span class="tactic">at</span> <span class="id">level</span> 10): <span class="id">nraenv_scope</span>.<br/>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string_scope</span>.<br/>
<span class="kwd">Tactic</span> <span class="kwd">Notation</span> "<span class="id">nraenv_cases</span>" <span class="id">tactic</span>(<span class="id">first</span>) <span class="id">ident</span>(<span class="id">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvID</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvConst</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvBinop</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvUnop</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvMap</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvMapConcat</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvProduct</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvSelect</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvDefault</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvEither</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvEitherConcat</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvApp</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvGetConstant</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvEnv</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvAppEnv</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvMapEnv</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvFlatMap</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvJoin</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvProject</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvGroupBy</span>"<br/>
&nbsp;&nbsp;| <span class="id">Case_aux</span> <span class="id">c</span> "<span class="id">NRAEnvUnnest</span>"].<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</div>
</body>
</html>
